<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (24 May 2007)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Thu May 24 22:26:48 2007</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir__2Fusr_2Flocal_2Fsrc_2Fasterisk_2Esvn_2Fastum_2Fres_2F.html">res</a></div>
<h1>res_astum.c</h1><a href="res__astum_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * </span>
<a name="l00005"></a>00005 <span class="comment"> * ASTUM - Asterisk User Management Resource</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * Copyright (C) 2005-2006, Edvina AB, Sollentuna, Sweden.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * Olle E. Johansson &lt;oej@edvina.net&gt;</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00012"></a>00012 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00013"></a>00013 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00014"></a>00014 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00015"></a>00015 <span class="comment"> * channels for your use.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00018"></a>00018 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00019"></a>00019 <span class="comment"> * at the top of the source tree.</span>
<a name="l00020"></a>00020 <span class="comment"> */</span>
<a name="l00021"></a>00021 <span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment">/*! \file</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * \brief AstUM - Asterisk User Management</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * \author Olle E. Johansson &lt;oej@edvina.net&gt;</span>
<a name="l00027"></a>00027 <span class="comment"> *</span>
<a name="l00028"></a>00028 <span class="comment"> * \arg For information about AstUM, see \ref AUM_desc</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> */</span>
<a name="l00031"></a>00031  
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;sys/signal.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#ifdef STRING_I18N      </span><span class="comment">/* This part is not done yet */</span>
<a name="l00044"></a>00044             <span class="comment">/* For supporting string conversions we need libiconv dependencies */</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;iconv.h&gt;</span>   <span class="comment">/* String conversion routines */</span>
<a name="l00046"></a>00046 <span class="preprocessor">#endif</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="asterisk_8h.html">asterisk.h</a>"</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <a class="code" href="asterisk_8h.html#9c510a313e63f75dac1b4afadc0d5545">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">"$Revision$"</span>)
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 #include <span class="stringliteral">"asterisk/lock.h"</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include "<a class="code" href="file_8h.html">asterisk/file.h</a>"</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">asterisk/logger.h</a>"</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include "<a class="code" href="config_8h.html">asterisk/config.h</a>"</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include "<a class="code" href="channel_8h.html">asterisk/channel.h</a>"</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include "<a class="code" href="callerid_8h.html">asterisk/callerid.h</a>"</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include "<a class="code" href="astobj_8h.html">asterisk/astobj.h</a>"</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include "<a class="code" href="pbx_8h.html">asterisk/pbx.h</a>"</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include "<a class="code" href="acl_8h.html">asterisk/acl.h</a>"</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include "<a class="code" href="options_8h.html">asterisk/options.h</a>"</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include "<a class="code" href="module_8h.html">asterisk/module.h</a>"</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include "<a class="code" href="app_8h.html">asterisk/app.h</a>"</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include "<a class="code" href="cli_8h.html">asterisk/cli.h</a>"</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include "<a class="code" href="manager_8h.html">asterisk/manager.h</a>"</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">asterisk/utils.h</a>"</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include "<a class="code" href="linkedlists_8h.html">asterisk/linkedlists.h</a>"</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include "<a class="code" href="localtime_8h.html">asterisk/localtime.h</a>"</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include "<a class="code" href="astum_8h.html">asterisk/astum.h</a>"</span>
<a name="l00070"></a>00070 <span class="comment"></span>
<a name="l00071"></a>00071 <span class="comment">/*! AUM user lock */</span>
<a name="l00072"></a>00072 <a class="code" href="lock_8h.html#4291c0bd75dfaf0052799003d3305e16">AST_MUTEX_DEFINE_STATIC</a>(aum_userlock);<span class="comment"></span>
<a name="l00073"></a>00073 <span class="comment">/*! AUM group lock */</span>
<a name="l00074"></a>00074 <a class="code" href="lock_8h.html#4291c0bd75dfaf0052799003d3305e16">AST_MUTEX_DEFINE_STATIC</a>(aum_grouplock);
<a name="l00075"></a>00075 
<a name="l00076"></a><a class="code" href="res__astum_8c.html#6de05447dd0558c62ca446380d53e9e0">00076</a> <a class="code" href="res__astum_8c.html#6de05447dd0558c62ca446380d53e9e0">STANDARD_LOCAL_USER</a>;
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="res__astum_8c.html#09a58f646081eb2f35a2d9ae2864b9c3">00078</a> <a class="code" href="res__astum_8c.html#09a58f646081eb2f35a2d9ae2864b9c3">LOCAL_USER_DECL</a>;
<a name="l00079"></a>00079 <span class="comment"></span>
<a name="l00080"></a>00080 <span class="comment">/*! \page AUM_desc Asterisk User Managment - ASTUM - module </span>
<a name="l00081"></a>00081 <span class="comment">   \par What is ASTUM?</span>
<a name="l00082"></a>00082 <span class="comment">   The ASTUM module implements common user management. A user</span>
<a name="l00083"></a>00083 <span class="comment">   can have one or several voicemail accounts, phones, IM accounts</span>
<a name="l00084"></a>00084 <span class="comment">   and other properties. A common user module mamkes it easier</span>
<a name="l00085"></a>00085 <span class="comment">   to manage passwords, e-mail addresses and properties that belong</span>
<a name="l00086"></a>00086 <span class="comment">   to the person who manages a device.</span>
<a name="l00087"></a>00087 <span class="comment"></span>
<a name="l00088"></a>00088 <span class="comment">   \par</span>
<a name="l00089"></a>00089 <span class="comment">   In ASTUM-enabled Asterisk modules (channels, applications, functions)</span>
<a name="l00090"></a>00090 <span class="comment">   you can refer to the AUMid and thus fetch configuration data from</span>
<a name="l00091"></a>00091 <span class="comment">   the ASTUM module for common properties.</span>
<a name="l00092"></a>00092 <span class="comment"></span>
<a name="l00093"></a>00093 <span class="comment">   \par Currently these modules support AUM:</span>
<a name="l00094"></a>00094 <span class="comment">      - none </span>
<a name="l00095"></a>00095 <span class="comment"></span>
<a name="l00096"></a>00096 <span class="comment">   \par Modules that may benefit from implementing AUM</span>
<a name="l00097"></a>00097 <span class="comment">      - all channel drivers</span>
<a name="l00098"></a>00098 <span class="comment">      - app_disa.c</span>
<a name="l00099"></a>00099 <span class="comment">      - app_voicemail.c</span>
<a name="l00100"></a>00100 <span class="comment">      - app_meetme.c</span>
<a name="l00101"></a>00101 <span class="comment">      - manager.c</span>
<a name="l00102"></a>00102 <span class="comment">      - The Asterisk CLI</span>
<a name="l00103"></a>00103 <span class="comment">      - Parking</span>
<a name="l00104"></a>00104 <span class="comment"></span>
<a name="l00105"></a>00105 <span class="comment">   \par The ASTUM User object</span>
<a name="l00106"></a>00106 <span class="comment">   The ASTUM user object consist of one general structure and</span>
<a name="l00107"></a>00107 <span class="comment">   linked lists for addresses, contexts and groups.</span>
<a name="l00108"></a>00108 <span class="comment">   When installed, the user inherit properties from the groups.</span>
<a name="l00109"></a>00109 <span class="comment">   \arg \ref aum_user The user object</span>
<a name="l00110"></a>00110 <span class="comment">   \arg \ref aum_group The group object</span>
<a name="l00111"></a>00111 <span class="comment"></span>
<a name="l00112"></a>00112 <span class="comment">   \par</span>
<a name="l00113"></a>00113 <span class="comment">   The user has a presence state that can be checked with</span>
<a name="l00114"></a>00114 <span class="comment">   a dial plan function. Presence can be changed from a SIP phone</span>
<a name="l00115"></a>00115 <span class="comment">   with publish or linked to an IM account (if there's code support</span>
<a name="l00116"></a>00116 <span class="comment">   for it).</span>
<a name="l00117"></a>00117 <span class="comment"></span>
<a name="l00118"></a>00118 <span class="comment">   \par The ASTUM Address Object</span>
<a name="l00119"></a>00119 <span class="comment">   The address object consists of a type and a text string.</span>
<a name="l00120"></a>00120 <span class="comment">   The type can be a phone number, SIP uri, IAX number or </span>
<a name="l00121"></a>00121 <span class="comment">   cell phone number.</span>
<a name="l00122"></a>00122 <span class="comment">   </span>
<a name="l00123"></a>00123 <span class="comment">   We will not add an address type for each service provider</span>
<a name="l00124"></a>00124 <span class="comment">   out there. Instead, there are five "custom" addresses. These</span>
<a name="l00125"></a>00125 <span class="comment">   will be configurable so that they can have different labels,</span>
<a name="l00126"></a>00126 <span class="comment">   depending upon your configuration.</span>
<a name="l00127"></a>00127 <span class="comment"></span>
<a name="l00128"></a>00128 <span class="comment">   \par The ASTUM group object</span>
<a name="l00129"></a>00129 <span class="comment">   Group objects are "master" objects that the User inherits</span>
<a name="l00130"></a>00130 <span class="comment">   properties from.</span>
<a name="l00131"></a>00131 <span class="comment"></span>
<a name="l00132"></a>00132 <span class="comment">   There are dial plan functions to check if a user belongs</span>
<a name="l00133"></a>00133 <span class="comment">   to a user group or not.</span>
<a name="l00134"></a>00134 <span class="comment">   </span>
<a name="l00135"></a>00135 <span class="comment">   \par The ASTUM context object</span>
<a name="l00136"></a>00136 <span class="comment">   ...</span>
<a name="l00137"></a>00137 <span class="comment">   \par The ASTUM string object</span>
<a name="l00138"></a>00138 <span class="comment">   The AUM string object is an encapsulation of a normal C character string,</span>
<a name="l00139"></a>00139 <span class="comment">   terminated with a zero character. It is a linked list of strings </span>
<a name="l00140"></a>00140 <span class="comment">   where each string is clearly marked with character set.</span>
<a name="l00141"></a>00141 <span class="comment">   If a different character set is asked for, the string handling functions</span>
<a name="l00142"></a>00142 <span class="comment">   will convert and add a new string in a linked list from the first one.</span>
<a name="l00143"></a>00143 <span class="comment"></span>
<a name="l00144"></a>00144 <span class="comment">   - String objects are created with aum_string_alloc()</span>
<a name="l00145"></a>00145 <span class="comment">   - String objects are destroyed with aum_string_destroy()</span>
<a name="l00146"></a>00146 <span class="comment"></span>
<a name="l00147"></a>00147 <span class="comment">   \par Ideas for AUM presence</span>
<a name="l00148"></a>00148 <span class="comment">   </span>
<a name="l00149"></a>00149 <span class="comment">   Basically, we need to have a few classical PBX presence indicators</span>
<a name="l00150"></a>00150 <span class="comment">   with major status and substatus</span>
<a name="l00151"></a>00151 <span class="comment">   - Away</span>
<a name="l00152"></a>00152 <span class="comment">      - Meeting</span>
<a name="l00153"></a>00153 <span class="comment">      - Sick</span>
<a name="l00154"></a>00154 <span class="comment">      - Travelling</span>
<a name="l00155"></a>00155 <span class="comment">   - Meeting</span>
<a name="l00156"></a>00156 <span class="comment">   - Busy</span>
<a name="l00157"></a>00157 <span class="comment">   - Not reachable (system error, network error)</span>
<a name="l00158"></a>00158 <span class="comment">   - Custom </span>
<a name="l00159"></a>00159 <span class="comment">      - Custom</span>
<a name="l00160"></a>00160 <span class="comment">   - Agent specific statuses</span>
<a name="l00161"></a>00161 <span class="comment"></span>
<a name="l00162"></a>00162 <span class="comment">   For each user, a chain of events need to maintained, current and</span>
<a name="l00163"></a>00163 <span class="comment">   future events. The handling of past events is up to another system.</span>
<a name="l00164"></a>00164 <span class="comment">   </span>
<a name="l00165"></a>00165 <span class="comment">   - For each user, we need to keep track of next planned change.</span>
<a name="l00166"></a>00166 <span class="comment">   - For planned event changes, check whether the time is mandatory</span>
<a name="l00167"></a>00167 <span class="comment">     (should be executed) or a suggestion (don't time out, just keep</span>
<a name="l00168"></a>00168 <span class="comment">     current status while waiting for status change).</span>
<a name="l00169"></a>00169 <span class="comment">     Example:</span>
<a name="l00170"></a>00170 <span class="comment">      - Meeting is planned to 13:00, but ran over to 14:15</span>
<a name="l00171"></a>00171 <span class="comment">      - I am busy to 10:45, open my phone after that.</span>
<a name="l00172"></a>00172 <span class="comment">   </span>
<a name="l00173"></a>00173 <span class="comment">   - We need to store events somewhere (event silo) between reloads</span>
<a name="l00174"></a>00174 <span class="comment">   - Events can come in trough dial plan or manager</span>
<a name="l00175"></a>00175 <span class="comment">   - Current user status can be changed through dialplan functions,</span>
<a name="l00176"></a>00176 <span class="comment">     manager or IM channels/gateways (Jabber, SIP, other)</span>
<a name="l00177"></a>00177 <span class="comment">   - We need to synch status levels with other IM (SIMPLE/Jabber/XMPP)</span>
<a name="l00178"></a>00178 <span class="comment"></span>
<a name="l00179"></a>00179 <span class="comment">   \par Realtime usage</span>
<a name="l00180"></a>00180 <span class="comment">   ASTUM uses ARA - the realtime architecture - to load users and groups.</span>
<a name="l00181"></a>00181 <span class="comment">   The realtime handles for AUM is</span>
<a name="l00182"></a>00182 <span class="comment">   - \b aumusers  For users</span>
<a name="l00183"></a>00183 <span class="comment">   - \b aumgroups  For the realtime groups</span>
<a name="l00184"></a>00184 <span class="comment">   </span>
<a name="l00185"></a>00185 <span class="comment">   ASTUM will cache realtime users in memory after we load them.</span>
<a name="l00186"></a>00186 <span class="comment">   Every time a realtime user is accessed, it's moved to top of</span>
<a name="l00187"></a>00187 <span class="comment">   the cache. When we reach the maximum number of cached users,</span>
<a name="l00188"></a>00188 <span class="comment">   ASTUM mwill delete from the bottom of the cache while adding the</span>
<a name="l00189"></a>00189 <span class="comment">   missing user to the top.</span>
<a name="l00190"></a>00190 <span class="comment">   </span>
<a name="l00191"></a>00191 <span class="comment">   (Actually, the cache is implemented upside down, but I guess</span>
<a name="l00192"></a>00192 <span class="comment">   that does not matter.)</span>
<a name="l00193"></a>00193 <span class="comment"></span>
<a name="l00194"></a>00194 <span class="comment">   The ASTUM cache size will be configurable in the general</span>
<a name="l00195"></a>00195 <span class="comment">   section of astum.conf</span>
<a name="l00196"></a>00196 <span class="comment"></span>
<a name="l00197"></a>00197 <span class="comment">   \par Channel usage</span>
<a name="l00198"></a>00198 <span class="comment">   For channels, they can register a device that belongs to</span>
<a name="l00199"></a>00199 <span class="comment">   a user in combination with a callback function. It that callback</span>
<a name="l00200"></a>00200 <span class="comment">   is registred, it will be called each time a user state changes.</span>
<a name="l00201"></a>00201 <span class="comment"></span>
<a name="l00202"></a>00202 <span class="comment">   \par Things to do</span>
<a name="l00203"></a>00203 <span class="comment">   - Implement all core AUM api functions from aum.h</span>
<a name="l00204"></a>00204 <span class="comment">      - Revise the list</span>
<a name="l00205"></a>00205 <span class="comment">   - Implement needed function in config engine (if needed)</span>
<a name="l00206"></a>00206 <span class="comment">   - Implement manager functions for AUM</span>
<a name="l00207"></a>00207 <span class="comment">      - Read presence</span>
<a name="l00208"></a>00208 <span class="comment">      - Change presence</span>
<a name="l00209"></a>00209 <span class="comment">   - Implement dial plan functions</span>
<a name="l00210"></a>00210 <span class="comment">      - belong_to_group</span>
<a name="l00211"></a>00211 <span class="comment">      - check_presence</span>
<a name="l00212"></a>00212 <span class="comment">      - get_email_address</span>
<a name="l00213"></a>00213 <span class="comment">      - get_sip_address</span>
<a name="l00214"></a>00214 <span class="comment">   - Implement AUM in channel drivers</span>
<a name="l00215"></a>00215 <span class="comment">      - Implement in chan_sip.c</span>
<a name="l00216"></a>00216 <span class="comment">      - Implement in chan_iax2.c</span>
<a name="l00217"></a>00217 <span class="comment">   - Implement AUM in applications</span>
<a name="l00218"></a>00218 <span class="comment">      - Implement AUM in app_disa.c</span>
<a name="l00219"></a>00219 <span class="comment">      - Implement AUM in app_voicemail.c</span>
<a name="l00220"></a>00220 <span class="comment">   - Implement AUM functions</span>
<a name="l00221"></a>00221 <span class="comment">      - Callback to register devices with AUM - $AUMUSERPHONE()</span>
<a name="l00222"></a>00222 <span class="comment">   - Check if we can merge AUM with </span>
<a name="l00223"></a>00223 <span class="comment">      - mogorman's jabber patch</span>
<a name="l00224"></a>00224 <span class="comment">      - file's SIP messaging patch</span>
<a name="l00225"></a>00225 <span class="comment">   - Can we use aum_groups as callgroups/pickupgroups?</span>
<a name="l00226"></a>00226 <span class="comment">   - Internationalization issues</span>
<a name="l00227"></a>00227 <span class="comment">      - Learn how to use utf-8 in source code and convert between different</span>
<a name="l00228"></a>00228 <span class="comment">      strings (firstname, lastname, sip uri etc)</span>
<a name="l00229"></a>00229 <span class="comment">      - Figure out what character set is used in config and relatime</span>
<a name="l00230"></a>00230 <span class="comment">   - Investigate the possibility of a chan_user as a proxy channel (ssokol's idea)</span>
<a name="l00231"></a>00231 <span class="comment">   - Implement channel registration and callbacks</span>
<a name="l00232"></a>00232 <span class="comment">   - Continue with other projects</span>
<a name="l00233"></a>00233 <span class="comment">   - \b Remember: It's only software</span>
<a name="l00234"></a>00234 <span class="comment">*/</span>
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 <span class="comment">/*------------------------------- Declarations of static functions ---------*/</span>
<a name="l00237"></a><a class="code" href="res__astum_8c.html#4e2c74b8ed5eb469d94c25d198b8f171">00237</a> <span class="keyword">enum</span> <a class="code" href="res__astum_8c.html#4e2c74b8ed5eb469d94c25d198b8f171">modulereloadreason</a> {  <span class="comment">/* Should be in module.h or something */</span>
<a name="l00238"></a>00238         <a class="code" href="res__astum_8c.html#4e2c74b8ed5eb469d94c25d198b8f1715648e9d89905777021731d659721eb16">MODULE__LOAD</a>,
<a name="l00239"></a>00239         <a class="code" href="res__astum_8c.html#4e2c74b8ed5eb469d94c25d198b8f171604f6ec0660f9b55a36eb27d6fd4777f">MODULE__RELOAD</a>,
<a name="l00240"></a>00240         <a class="code" href="res__astum_8c.html#4e2c74b8ed5eb469d94c25d198b8f171b8b2789423e9826acd2a12972ea1963a">MODULE_CLI_RELOAD</a>,
<a name="l00241"></a>00241         <a class="code" href="res__astum_8c.html#4e2c74b8ed5eb469d94c25d198b8f17153eee322f41cc03307a61780ff088444">MODULE_MANAGER_RELOAD</a>,
<a name="l00242"></a>00242 };
<a name="l00243"></a>00243 
<a name="l00244"></a>00244 <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="res__astum_8c.html#e7c38e3f31f3b834ced400a0ef0d5393">aum_allocate</a>(size_t size);
<a name="l00245"></a>00245 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__astum_8c.html#9dd2e3e6486090c6e1930a49b376319e">aum_free</a>(<span class="keywordtype">void</span> *obj);
<a name="l00246"></a>00246 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__astum_8c.html#e3b7823b997a9732153a16e6c120b767">aum_destroy_user</a>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *user);
<a name="l00247"></a>00247 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__astum_8c.html#b1b57aeeb3f6691238a6d7e71c62a744">aum_destroy_group</a>(<span class="keyword">struct</span> <a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a>);
<a name="l00248"></a>00248 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="res__astum_8c.html#ee1adf0cb0617ea05eaccd8f5ad8b129">aum_build_user</a>(<span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#14c4b06b824ec593239362517f538b29">username</a>, <span class="keyword">struct</span> <a class="code" href="structast__variable.html">ast_variable</a> *x, <span class="keywordtype">int</span> realtime);
<a name="l00249"></a>00249 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="res__astum_8c.html#55307d0ee9eb7b6419585594347227d9">aum_build_group</a>(<span class="keywordtype">char</span> *groupname, <span class="keyword">struct</span> <a class="code" href="structast__variable.html">ast_variable</a> *x, <span class="keywordtype">int</span> realtime);
<a name="l00250"></a>00250 <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="res__astum_8c.html#96ef8b04540433e255e0d2c332d551fa">modulereloadreason2txt</a>(<span class="keyword">enum</span> <a class="code" href="res__astum_8c.html#4e2c74b8ed5eb469d94c25d198b8f171">modulereloadreason</a> reason);
<a name="l00251"></a>00251 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="res__astum_8c.html#201b6a416de57697d57b26cafeab26a8">aum_addrtype2txt</a>(<span class="keyword">enum</span> <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf">aum_address_type</a> <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>);
<a name="l00252"></a>00252 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf">aum_address_type</a> <a class="code" href="res__astum_8c.html#3dedc214e98008ac28f5093ac3593c30">get_addr_type_from_config_option</a>(<span class="keyword">enum</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1">aum_config_options</a> option);
<a name="l00253"></a>00253 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="res__astum_8c.html#3a0575e7b508cd30b91c36186e0ee2d2">context_type2str</a>(<span class="keyword">enum</span> <a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc19">aum_context_type</a> <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>);
<a name="l00254"></a>00254 
<a name="l00255"></a>00255 <span class="comment"></span>
<a name="l00256"></a>00256 <span class="comment">/*! ----------------------------------------</span>
<a name="l00257"></a>00257 <span class="comment">\brief AUM General Configuration </span>
<a name="l00258"></a>00258 <span class="comment">*/</span><span class="comment"></span>
<a name="l00259"></a>00259 <span class="comment">/*! \brief Configuration file name */</span>
<a name="l00260"></a><a class="code" href="res__astum_8c.html#c3f3453270a4460e449983a232f6283a">00260</a> <span class="keywordtype">char</span> *<a class="code" href="res__astum_8c.html#c3f3453270a4460e449983a232f6283a">aum_config_file</a> = <span class="stringliteral">"astum.conf"</span>;
<a name="l00261"></a>00261 <span class="comment"></span>
<a name="l00262"></a>00262 <span class="comment">/*! \brief AUM debugging */</span>
<a name="l00263"></a><a class="code" href="res__astum_8c.html#e910aeac3bd7570908f8be1a9b12134f">00263</a> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#e910aeac3bd7570908f8be1a9b12134f">aum_debug</a> = 0;
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 <span class="comment">/* Counters */</span>
<a name="l00266"></a><a class="code" href="res__astum_8c.html#decda0d0cbdba0e8a722f972201501af">00266</a> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#decda0d0cbdba0e8a722f972201501af">aum_static_users</a>;         <span class="comment">/*!&lt; Number of in-memory users */</span>
<a name="l00267"></a><a class="code" href="res__astum_8c.html#ebf83cc80ef4e43a6fe1dd0149ae8d07">00267</a> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#ebf83cc80ef4e43a6fe1dd0149ae8d07">aum_real_users</a>;        <span class="comment">/*!&lt; Number of active realtime users */</span>
<a name="l00268"></a><a class="code" href="res__astum_8c.html#2e4b6b5e42594b7f28a94a3b7d6c0433">00268</a> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#2e4b6b5e42594b7f28a94a3b7d6c0433">aum_real_groups</a>;       <span class="comment">/*!&lt; Number of active realtime groups */</span>
<a name="l00269"></a><a class="code" href="res__astum_8c.html#aaf6c6bfd8f8801838688e0cd4943115">00269</a> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#aaf6c6bfd8f8801838688e0cd4943115">aum_static_groups</a>;        <span class="comment">/*!&lt; Number of in-memory groups */</span>
<a name="l00270"></a><a class="code" href="res__astum_8c.html#b8a5bbee002aece8af628f8694357607">00270</a> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#b8a5bbee002aece8af628f8694357607">aum_real_groups_enabled</a> = 0; <span class="comment">/*!&lt; TRUE If realtime groups are enabled */</span>
<a name="l00271"></a><a class="code" href="res__astum_8c.html#e126e8e41904920cffa1f9c582ef4bf8">00271</a> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#e126e8e41904920cffa1f9c582ef4bf8">aum_real_users_enabled</a> = 0;     <span class="comment">/*!&lt; TRUE if realtime users are enabled */</span>
<a name="l00272"></a>00272 
<a name="l00273"></a><a class="code" href="res__astum_8c.html#a2325d652c26029e243507fe8aa308be">00273</a> <span class="keywordtype">long</span> <a class="code" href="res__astum_8c.html#a2325d652c26029e243507fe8aa308be">aum_memory_used</a> = 0;     <span class="comment">/*!&lt; Used memory for the AUM module */</span>
<a name="l00274"></a>00274 
<a name="l00275"></a>00275 <span class="preprocessor">#ifdef STRING_I18N</span>
<a name="l00276"></a>00276 <span class="preprocessor"></span>iconv_t  ichandler_utf8_to_iso88591;   <span class="comment">/*!&lt; libiconv handler from utf8 to iso8859-1 */</span>
<a name="l00277"></a>00277 iconv_t  ichandler_iso88591_to_utf8;   <span class="comment">/*!&lt; libiconv handler from iso8859- to utf8 */</span>
<a name="l00278"></a>00278 <span class="preprocessor">#endif</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00280"></a>00280 <span class="comment">/*! \brief the AUM Group list */</span>
<a name="l00281"></a><a class="code" href="structs__aum__grouplist.html">00281</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structs__aum__grouplist.html">s_aum_grouplist</a> {
<a name="l00282"></a>00282    <a class="code" href="structs__aum__grouplist.html#c41abab02e2e3e2d4e73381121efcb7e">ASTOBJ_CONTAINER_COMPONENTS</a>(<span class="keyword">struct</span> <a class="code" href="structaum__group.html">aum_group</a>);
<a name="l00283"></a>00283 } <a class="code" href="res__astum_8c.html#df751995f211be58a457c2d71dc6dc19">aum_grouplist</a>;
<a name="l00284"></a>00284 <span class="comment"></span>
<a name="l00285"></a>00285 <span class="comment">/*! \brief the AUM User list */</span>
<a name="l00286"></a><a class="code" href="structs__aum__userlist.html">00286</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structs__aum__userlist.html">s_aum_userlist</a> {
<a name="l00287"></a>00287    <a class="code" href="structs__aum__userlist.html#e29d166c84d253b6a7b5bd08d5f0e000">ASTOBJ_CONTAINER_COMPONENTS</a>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a>);
<a name="l00288"></a>00288 } <a class="code" href="res__astum_8c.html#ba74a92e97c6e68e9f1a98087416ca97">aum_userlist</a>;
<a name="l00289"></a>00289 <span class="comment"></span>
<a name="l00290"></a>00290 <span class="comment">/*! \brief The realtime user cache */</span>
<a name="l00291"></a><a class="code" href="structaum__usercache__struct.html">00291</a> <span class="keyword">struct </span><a class="code" href="structaum__usercache__struct.html">aum_usercache_struct</a> {
<a name="l00292"></a><a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">00292</a>    <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>;
<a name="l00293"></a>00293    <a class="code" href="linkedlists_8h.html#281773a259b5b580d77d636e50fff073">AST_LIST_ENTRY</a>(<a class="code" href="structaum__usercache__struct.html">aum_usercache_struct</a>) list;
<a name="l00294"></a>00294 };
<a name="l00295"></a>00295 
<a name="l00296"></a><a class="code" href="res__astum_8c.html#595a5c0d7ae5700453d5f991ca2dbdae">00296</a> static <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#595a5c0d7ae5700453d5f991ca2dbdae">aum_usercache_count</a> = 0; <span class="comment">/*!&lt; Current number of users in user cache */</span>
<a name="l00297"></a><a class="code" href="res__astum_8c.html#3b28ee7e07abf7ced3662bf4f6697dcd">00297</a> static <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#3b28ee7e07abf7ced3662bf4f6697dcd">aum_usercache_max</a>;    <span class="comment">/*!&lt; Maximum number of users in cache */</span>
<a name="l00298"></a><a class="code" href="res__astum_8c.html#0b2d7e2e4a5bc2a472f6c92b59cdaf63">00298</a> #define <a class="code" href="res__astum_8c.html#0b2d7e2e4a5bc2a472f6c92b59cdaf63">DEFAULT_USERCACHE_MAX</a> 50
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 static <a class="code" href="linkedlists_8h.html#4d5b67756dc1a102125bc1bad484e32b">AST_LIST_HEAD_STATIC</a>(aum_usercache, <a class="code" href="structaum__usercache__struct.html">aum_usercache_struct</a>); <span class="comment">/*!&lt; The user cache for realtime */</span>
<a name="l00301"></a>00301 <span class="comment"></span>
<a name="l00302"></a>00302 <span class="comment">/*! brief Different config options for address formats */</span>
<a name="l00303"></a><a class="code" href="res__astum_8c.html#df9d0b5d32e2f0d8680b7c1ce8cf1473">00303</a> static struct <a class="code" href="structaum__address__config__struct.html">aum_address_config_struct</a> <a class="code" href="res__astum_8c.html#df9d0b5d32e2f0d8680b7c1ce8cf1473">aum_address_config</a>[] = {
<a name="l00304"></a>00304    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfa684fc88dfbd27a288352c7a3b8711e5">AUM_ADDR_EMAIL</a>,  <span class="stringliteral">"email"</span>,    <span class="stringliteral">"E-mail"</span>,   <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1a8576257bedbe62f4790713809733d65">AUM_CNF_ADDR_EMAIL</a>},
<a name="l00305"></a>00305    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfa684fc88dfbd27a288352c7a3b8711e5">AUM_ADDR_EMAIL</a>,  <span class="stringliteral">"mailto"</span>,   <span class="stringliteral">"E-mail"</span>,   AUM_CNF_ADDR_EMAIL},
<a name="l00306"></a>00306    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf4cdd2da976ae0ab88be29d9d1bc50a0b">AUM_ADDR_XMPP</a>,      <span class="stringliteral">"xmpp"</span>,  <span class="stringliteral">"XMPP/Jabber"</span>, <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d16c8142f5020dfa3610b1417a09edc5c7">AUM_CNF_ADDR_XMPP</a>},
<a name="l00307"></a>00307    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf4cdd2da976ae0ab88be29d9d1bc50a0b">AUM_ADDR_XMPP</a>,      <span class="stringliteral">"jabber"</span>,   <span class="stringliteral">"XMPP/Jabber"</span>, AUM_CNF_ADDR_XMPP},  <span class="comment">/*! Alias for xmpp */</span>
<a name="l00308"></a>00308    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf11652df43c78789328352cfe6a31a1a0">AUM_ADDR_SIP</a>,    <span class="stringliteral">"sip"</span>,      <span class="stringliteral">"SIP"</span>,      <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1c0423d2c59faaacb7c7e11954b8828dd">AUM_CNF_ADDR_SIP</a>},   
<a name="l00309"></a>00309    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf3c8d446aaec445730d3e818ab78ca6da">AUM_ADDR_MSN</a>,    <span class="stringliteral">"msn"</span>,      <span class="stringliteral">"MSN"</span>,      <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1fc869e867dea46c80885ac31de7306d6">AUM_CNF_ADDR_MSN</a>},
<a name="l00310"></a>00310    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf940432dad4a6a55c48463cc9320a2d8b">AUM_ADDR_AOL</a>,    <span class="stringliteral">"aol"</span>,      <span class="stringliteral">"AOL"</span>,      <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d11cae255e4089eb9a2ba932bfab5e66cb">AUM_CNF_ADDR_AOL</a>},
<a name="l00311"></a>00311    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf55672bff653f58ae2f14ca158ba2bd8e">AUM_ADDR_TEL</a>,    <span class="stringliteral">"tel"</span>,      <span class="stringliteral">"Tel"</span>,      <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d14c4bd85fcc69fe6747d665df272bf3f1">AUM_CNF_ADDR_TEL</a>},
<a name="l00312"></a>00312    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf55672bff653f58ae2f14ca158ba2bd8e">AUM_ADDR_TEL</a>,    <span class="stringliteral">"phone"</span>,    <span class="stringliteral">"Tel"</span>,      AUM_CNF_ADDR_TEL},
<a name="l00313"></a>00313    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf55672bff653f58ae2f14ca158ba2bd8e">AUM_ADDR_TEL</a>,    <span class="stringliteral">"e164"</span>,  <span class="stringliteral">"Tel"</span>,      AUM_CNF_ADDR_TEL},
<a name="l00314"></a>00314    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf28ee25a9546ea3e9c0df7c40414ae45f">AUM_ADDR_CELL_TEL</a>,  <span class="stringliteral">"cell"</span>,  <span class="stringliteral">"Cell"</span>,     <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1182819936b470a1a3701e98029266c04">AUM_CNF_ADDR_CELL_TEL</a>},
<a name="l00315"></a>00315    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf28ee25a9546ea3e9c0df7c40414ae45f">AUM_ADDR_CELL_TEL</a>,  <span class="stringliteral">"mobile"</span>,   <span class="stringliteral">"Cell"</span>,     AUM_CNF_ADDR_CELL_TEL},
<a name="l00316"></a>00316    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfcc33cc480318cfc21f2b8b730914ba76">AUM_ADDR_IAX2</a>,      <span class="stringliteral">"iax"</span>,      <span class="stringliteral">"IAX2"</span>,     <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d14ba1d4c30a97f548dadc75a2d5f7cf09">AUM_CNF_ADDR_IAX2</a>},
<a name="l00317"></a>00317    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfcc33cc480318cfc21f2b8b730914ba76">AUM_ADDR_IAX2</a>,      <span class="stringliteral">"iax2"</span>,  <span class="stringliteral">"IAX2"</span>,     AUM_CNF_ADDR_IAX2},
<a name="l00318"></a>00318    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cff1789fd0775dc1abeb33abf37cf17de2">AUM_ADDR_FWD</a>,    <span class="stringliteral">"fwd"</span>,      <span class="stringliteral">"FWD"</span>,      <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1e3563a4ec8cc44c4a4fb02dbac030240">AUM_CNF_ADDR_FWD</a>},
<a name="l00319"></a>00319    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf9d5bb57a0a9b1af00208a52a98fb3f92">AUM_ADDR_IAXTEL</a>, <span class="stringliteral">"iaxtel"</span>,   <span class="stringliteral">"IAXtel"</span>,   <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1d123b99f24de1a3434b3edc522b0025e">AUM_CNF_ADDR_IAXTEL</a>},
<a name="l00320"></a>00320    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf2c4d8e935191eccf7862adcf3d7e0846">AUM_ADDR_FAX</a>,    <span class="stringliteral">"fax"</span>,      <span class="stringliteral">"Fax"</span>,      <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1fc23f73d7662836b4a0ddbc828064575">AUM_CNF_ADDR_FAX</a>},
<a name="l00321"></a>00321    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf72c94b71b40d11dedbb06c609cd38a32">AUM_ADDR_WEB</a>,    <span class="stringliteral">"homepage"</span>,    <span class="stringliteral">"Web"</span>,      <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d168302ab71153787f570a87a0933d28cd">AUM_CNF_ADDR_WEB</a>},
<a name="l00322"></a>00322    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf72c94b71b40d11dedbb06c609cd38a32">AUM_ADDR_WEB</a>,    <span class="stringliteral">"url"</span>,      <span class="stringliteral">"Web"</span>,      AUM_CNF_ADDR_WEB},
<a name="l00323"></a>00323    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf72c94b71b40d11dedbb06c609cd38a32">AUM_ADDR_WEB</a>,    <span class="stringliteral">"http"</span>,  <span class="stringliteral">"Web"</span>,      AUM_CNF_ADDR_WEB},
<a name="l00324"></a>00324    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfc918f12d1ca9ccb3e25f9dbcdd7e8002">AUM_ADDR_CUST0</a>,  <span class="stringliteral">"cust0"</span>,    <span class="stringliteral">"Custom 0"</span>, <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d124d01b652521d320e3d7e8bc087a032f">AUM_CNF_ADDR_CUST0</a>},
<a name="l00325"></a>00325    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfe15d228bb079d1ce20763baf14788d24">AUM_ADDR_CUST1</a>,  <span class="stringliteral">"cust1"</span>,    <span class="stringliteral">"Custom 1"</span>, <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d17c94703cc3398d0ae710826f3dcdccd7">AUM_CNF_ADDR_CUST1</a>},
<a name="l00326"></a>00326    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf6457ae16e903dc1ce696b7c81a410f3e">AUM_ADDR_CUST2</a>,  <span class="stringliteral">"cust2"</span>,    <span class="stringliteral">"Custom 2"</span>, <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d11a9bafdae7e1086d9494dfeb47ca8835">AUM_CNF_ADDR_CUST2</a>},
<a name="l00327"></a>00327    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfbb176a2eb462fe6500bffbe51652f9aa">AUM_ADDR_CUST3</a>,  <span class="stringliteral">"cust3"</span>,    <span class="stringliteral">"Custom 3"</span>, <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1e1002859d276a2232941d8cfb7a7410b">AUM_CNF_ADDR_CUST3</a>},
<a name="l00328"></a>00328    {<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfc3f066ffff407fda7bce0ad3dcde1a36">AUM_ADDR_CUST4</a>,  <span class="stringliteral">"cust4"</span>,    <span class="stringliteral">"Custom 4"</span>, <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d18594351074100a9d003bbb1fe085b9af">AUM_CNF_ADDR_CUST4</a>},
<a name="l00329"></a>00329 };
<a name="l00330"></a>00330 
<a name="l00331"></a><a class="code" href="res__astum_8c.html#c72e2b6e92d9b6c7edcd0a5da5cddead">00331</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaum__context__table.html">aum_context_table</a> aum_context_text[] = {
<a name="l00332"></a>00332    {<a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc192c0f1e472b875d296416258589aef812">AUM_CONTEXT_NONE</a>,      <span class="stringliteral">"None"</span> },
<a name="l00333"></a>00333    {<a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc192a3f315e5d458cdc839267b1b37ebf69">AUM_CONTEXT_DEF_CB</a>,    <span class="stringliteral">"Callback"</span> },
<a name="l00334"></a>00334    {<a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc193f4c9154e1d42efa3b293026ed5bb02c">AUM_CONTEXT_DEF_INCOMING</a>, <span class="stringliteral">"Incoming"</span> },
<a name="l00335"></a>00335    {<a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc196d15e49e3a2bb0f343502e047f9424b2">AUM_CONTEXT_VOICEMAIL</a>,    <span class="stringliteral">"Voicemail"</span> },
<a name="l00336"></a>00336    {<a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc19b589b574e51a177b14895e93710c152d">AUM_CONTEXT_DISA</a>,      <span class="stringliteral">"Disa"</span> },
<a name="l00337"></a>00337    {<a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc1988cfbd41e25867356b75d53a969b8467">AUM_CONTEXT_SIPSUBSCRIBE</a>, <span class="stringliteral">"SIPsubscribe"</span> },
<a name="l00338"></a>00338 };
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 
<a name="l00341"></a><a class="code" href="res__astum_8c.html#96ef8b04540433e255e0d2c332d551fa">00341</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="res__astum_8c.html#96ef8b04540433e255e0d2c332d551fa">modulereloadreason2txt</a>(<span class="keyword">enum</span> <a class="code" href="res__astum_8c.html#4e2c74b8ed5eb469d94c25d198b8f171">modulereloadreason</a> reason)
<a name="l00342"></a>00342 {
<a name="l00343"></a>00343    <span class="keywordflow">switch</span> (reason) {
<a name="l00344"></a>00344    <span class="keywordflow">case</span> <a class="code" href="res__astum_8c.html#4e2c74b8ed5eb469d94c25d198b8f1715648e9d89905777021731d659721eb16">MODULE__LOAD</a>:   <span class="keywordflow">return</span> <span class="stringliteral">"LOAD (Channel module load)"</span>;
<a name="l00345"></a>00345       <span class="keywordflow">break</span>;
<a name="l00346"></a>00346    <span class="keywordflow">case</span> <a class="code" href="res__astum_8c.html#4e2c74b8ed5eb469d94c25d198b8f171604f6ec0660f9b55a36eb27d6fd4777f">MODULE__RELOAD</a>: <span class="keywordflow">return</span> <span class="stringliteral">"RELOAD (Channel module reload)"</span>;
<a name="l00347"></a>00347       <span class="keywordflow">break</span>;
<a name="l00348"></a>00348    <span class="keywordflow">case</span> <a class="code" href="res__astum_8c.html#4e2c74b8ed5eb469d94c25d198b8f171b8b2789423e9826acd2a12972ea1963a">MODULE_CLI_RELOAD</a>: <span class="keywordflow">return</span> <span class="stringliteral">"CLIRELOAD (Channel module reload by CLI command)"</span>;
<a name="l00349"></a>00349       <span class="keywordflow">break</span>;
<a name="l00350"></a>00350    <span class="keywordflow">default</span>:          <span class="keywordflow">return</span> <span class="stringliteral">"MANAGERRELOAD (Channel module reload by manager)"</span>;
<a name="l00351"></a>00351       <span class="keywordflow">break</span>;
<a name="l00352"></a>00352         };
<a name="l00353"></a>00353 };
<a name="l00354"></a>00354 <span class="comment"></span>
<a name="l00355"></a>00355 <span class="comment">/*! \brief Convert address type to display string */</span>
<a name="l00356"></a><a class="code" href="res__astum_8c.html#201b6a416de57697d57b26cafeab26a8">00356</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="res__astum_8c.html#201b6a416de57697d57b26cafeab26a8">aum_addrtype2txt</a>(<span class="keyword">enum</span> <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf">aum_address_type</a> <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>) {
<a name="l00357"></a>00357    <span class="keywordtype">int</span> x;
<a name="l00358"></a>00358    <span class="keywordflow">for</span> (x = 0; x &lt; (<span class="keyword">sizeof</span>(<a class="code" href="res__astum_8c.html#df9d0b5d32e2f0d8680b7c1ce8cf1473">aum_address_config</a>) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__address__config__struct.html">aum_address_config_struct</a>)); x++) {
<a name="l00359"></a>00359       <span class="keywordflow">if</span> (aum_address_config[x].type == type)
<a name="l00360"></a>00360          <span class="keywordflow">return</span> aum_address_config[x].display;
<a name="l00361"></a>00361    }
<a name="l00362"></a>00362    <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
<a name="l00363"></a>00363 }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365 <span class="comment">/*----------------------------- CLI COMMANDS ----------------------*/</span><span class="comment"></span>
<a name="l00366"></a>00366 <span class="comment">/*! \brief  print_group: Print call group and pickup group ---*/</span>
<a name="l00367"></a><a class="code" href="res__astum_8c.html#b66b38feea66784db8933a0409eba4c1">00367</a> <span class="keyword">static</span> <span class="keywordtype">void</span>  <a class="code" href="chan__sip_8c.html#591a4bb0fdd9fca1def3c4b91bc1ed7a">print_group</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a>, <span class="keywordtype">int</span> crlf) 
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>[256];
<a name="l00370"></a>00370    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, crlf ? <span class="stringliteral">"%s\r\n"</span> : <span class="stringliteral">"%s\n"</span>, <a class="code" href="channel_8c.html#68e3e84e623c83dd308276466ccf7a35">ast_print_group</a>(buf, <span class="keyword">sizeof</span>(buf), group) );
<a name="l00371"></a>00371 }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 <span class="comment"></span>
<a name="l00374"></a>00374 <span class="comment">/*! \brief CLI command description */</span>
<a name="l00375"></a><a class="code" href="res__astum_8c.html#d28ea856c8a5f557315ad81f2d94c52e">00375</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__astum_8c.html#d28ea856c8a5f557315ad81f2d94c52e">cli_aum_show_stats_usage</a>[] = 
<a name="l00376"></a>00376 <span class="stringliteral">"Usage: aum show stats\n"</span>
<a name="l00377"></a>00377 <span class="stringliteral">"  Displays some AUM statistics.\n"</span>;
<a name="l00378"></a>00378 <span class="comment"></span>
<a name="l00379"></a>00379 <span class="comment">/*! \brief CLI command "aum show stats" */</span>
<a name="l00380"></a><a class="code" href="res__astum_8c.html#033335b0943094281eb7074b9d5a47b7">00380</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#033335b0943094281eb7074b9d5a47b7">cli_aum_show_stats</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00381"></a>00381 {
<a name="l00382"></a>00382 
<a name="l00383"></a>00383    <span class="keywordflow">if</span> (argc != 3)
<a name="l00384"></a>00384       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00385"></a>00385    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"AUM Statistics\n"</span>);
<a name="l00386"></a>00386    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"--------------\n\n"</span>);
<a name="l00387"></a>00387    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Allocated memory:      %-10.10ld\n"</span>, <a class="code" href="res__astum_8c.html#a2325d652c26029e243507fe8aa308be">aum_memory_used</a>);
<a name="l00388"></a>00388    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Users - static:        %-10.10d\n"</span>, <a class="code" href="res__astum_8c.html#decda0d0cbdba0e8a722f972201501af">aum_static_users</a>);
<a name="l00389"></a>00389    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Groups - static:       %-10.10d\n"</span>, <a class="code" href="res__astum_8c.html#aaf6c6bfd8f8801838688e0cd4943115">aum_static_groups</a>);
<a name="l00390"></a>00390    <span class="keywordflow">if</span> (<a class="code" href="res__astum_8c.html#e126e8e41904920cffa1f9c582ef4bf8">aum_real_users_enabled</a>)
<a name="l00391"></a>00391       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Users - realtime:      %-10.10d\n"</span>, <a class="code" href="res__astum_8c.html#ebf83cc80ef4e43a6fe1dd0149ae8d07">aum_real_users</a>);
<a name="l00392"></a>00392    <span class="keywordflow">if</span> (<a class="code" href="res__astum_8c.html#b8a5bbee002aece8af628f8694357607">aum_real_groups_enabled</a>)
<a name="l00393"></a>00393       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Groups - realtime:     %-10.10d\n"</span>, <a class="code" href="res__astum_8c.html#2e4b6b5e42594b7f28a94a3b7d6c0433">aum_real_groups</a>);
<a name="l00394"></a>00394    <span class="keywordflow">if</span> (<a class="code" href="res__astum_8c.html#e126e8e41904920cffa1f9c582ef4bf8">aum_real_users_enabled</a>)
<a name="l00395"></a>00395       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Realtime cache:        %d objects (%-10.10d kb) %d %% full\n"</span>, <a class="code" href="res__astum_8c.html#595a5c0d7ae5700453d5f991ca2dbdae">aum_usercache_count</a>, (<span class="keywordtype">int</span>) (<a class="code" href="res__astum_8c.html#595a5c0d7ae5700453d5f991ca2dbdae">aum_usercache_count</a> * (<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a>) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__usercache__struct.html">aum_usercache_struct</a>)) / 1000), (<span class="keywordtype">int</span>) (<a class="code" href="res__astum_8c.html#595a5c0d7ae5700453d5f991ca2dbdae">aum_usercache_count</a> / <a class="code" href="res__astum_8c.html#3b28ee7e07abf7ced3662bf4f6697dcd">aum_usercache_max</a> * 100 ) );
<a name="l00396"></a>00396    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"\n\n"</span>);
<a name="l00397"></a>00397    
<a name="l00398"></a>00398    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00399"></a>00399 }
<a name="l00400"></a>00400 <span class="comment"></span>
<a name="l00401"></a>00401 <span class="comment">/*! \brief CLI command description */</span>
<a name="l00402"></a><a class="code" href="res__astum_8c.html#be7ddd36b2aa7fa123dafb18bf6ef231">00402</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__astum_8c.html#be7ddd36b2aa7fa123dafb18bf6ef231">cli_aum_show_users_usage</a>[] = 
<a name="l00403"></a>00403 <span class="stringliteral">"Usage: aum show users\n"</span>
<a name="l00404"></a>00404 <span class="stringliteral">"  Lists all configured AUM users.\n"</span>
<a name="l00405"></a>00405 <span class="stringliteral">"  For details on a specific user, use \"aum show user &lt;name&gt;\"\n"</span>;
<a name="l00406"></a>00406 <span class="comment"></span>
<a name="l00407"></a>00407 <span class="comment">/*! \brief CLI command "aum show users" */</span>
<a name="l00408"></a><a class="code" href="res__astum_8c.html#ab3111666dddaa9db0d1861414e4b18c">00408</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#ab3111666dddaa9db0d1861414e4b18c">cli_aum_show_users</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00409"></a>00409 {
<a name="l00410"></a>00410    <span class="keywordtype">int</span> numusers = 0;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412    <span class="keywordflow">if</span> (argc != 3)
<a name="l00413"></a>00413       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415    <span class="keywordflow">if</span> (argc != 3)
<a name="l00416"></a>00416       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00417"></a>00417    
<a name="l00418"></a>00418    <a class="code" href="astobj_8h.html#0d158ef06434f7b47d5a7eddaa24f18a">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__astum_8c.html#ba74a92e97c6e68e9f1a98087416ca97">aum_userlist</a>, 1, {
<a name="l00419"></a>00419       <a class="code" href="astobj_8h.html#013e2f1442ca7e5cd2cb0756766cd6c7">ASTOBJ_RDLOCK</a>(iterator);
<a name="l00420"></a>00420       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(iterator, <a class="code" href="astum_8h.html#6ad8155725a1f22cb2b08985ccb68d238bbed3f7071f380cb87b9ea966826684">AUM_USER_FLAG_REALTIME</a>)) {
<a name="l00421"></a>00421          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" %-20.20s: %-10.10s %-15.15s %-10.10s %s\n"</span>, iterator-&gt;name, iterator-&gt;first_name, iterator-&gt;last_name, iterator-&gt;numuserid, <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(iterator, <a class="code" href="astum_8h.html#6ad8155725a1f22cb2b08985ccb68d2377709f69647fb26330b781787c4027bd">AUM_USER_FLAG_DISABLED</a>) ? <span class="stringliteral">"* DISABLED *"</span> : <span class="stringliteral">""</span>);
<a name="l00422"></a>00422          numusers ++;
<a name="l00423"></a>00423       }
<a name="l00424"></a>00424       <a class="code" href="astobj_8h.html#09df6ddac721782b63dde9c9247b5285">ASTOBJ_UNLOCK</a>(iterator);
<a name="l00425"></a>00425    } );
<a name="l00426"></a>00426    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"-- Number of users: %d\n"</span>, numusers);
<a name="l00427"></a>00427    
<a name="l00428"></a>00428    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a><a class="code" href="res__astum_8c.html#a782f0e2eef42789727fbe2da50d11d2">00431</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__astum_8c.html#a782f0e2eef42789727fbe2da50d11d2">cli_aum_load_rtuser_usage</a>[] = 
<a name="l00432"></a>00432 <span class="stringliteral">"Usage: aum load rtuser &lt;user&gt;\n"</span>
<a name="l00433"></a>00433 <span class="stringliteral">"  Loads a user from realtime storage into the AUM realtime cache.\n"</span>
<a name="l00434"></a>00434 <span class="stringliteral">"  For a list of all static users, use \"aum show users\"\n"</span>;
<a name="l00435"></a>00435 <span class="comment"></span>
<a name="l00436"></a>00436 <span class="comment">/*! \brief Load an realtime user */</span>
<a name="l00437"></a><a class="code" href="res__astum_8c.html#ef446c3018722e876b370b46e702fac5">00437</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#ef446c3018722e876b370b46e702fac5">cli_aum_load_rtuser</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00438"></a>00438 {
<a name="l00439"></a>00439    <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>;
<a name="l00440"></a>00440    <span class="keywordflow">if</span> (!<a class="code" href="res__astum_8c.html#e126e8e41904920cffa1f9c582ef4bf8">aum_real_users_enabled</a>) {
<a name="l00441"></a>00441       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"Realtime AUM is not enabled in extconfig.conf.\n"</span>);
<a name="l00442"></a>00442       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00443"></a>00443    }
<a name="l00444"></a>00444    <span class="keywordflow">if</span> (argc != 4)
<a name="l00445"></a>00445       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00446"></a>00446 
<a name="l00447"></a>00447    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l00448"></a>00448       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Trying to find realtime user %s to show... \n"</span>, argv[3]);
<a name="l00449"></a>00449 
<a name="l00450"></a>00450    user = <a class="code" href="astum_8h.html#193a76f977f30b532eb9bccca7d0d8b9">find_aum_user</a>(argv[3], <a class="code" href="plc_8c.html#c0d83f0b82a6b30de8811e69e6d95c61">TRUE</a>);
<a name="l00451"></a>00451    <span class="keywordflow">if</span> (!user) {
<a name="l00452"></a>00452       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"- AUM user %s not found\n"</span>, argv[3]);
<a name="l00453"></a>00453       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00454"></a>00454    }
<a name="l00455"></a>00455    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(user, <a class="code" href="astum_8h.html#6ad8155725a1f22cb2b08985ccb68d238bbed3f7071f380cb87b9ea966826684">AUM_USER_FLAG_REALTIME</a>)) {
<a name="l00456"></a>00456       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"User %s is not a realtime user\n"</span>, argv[3]);
<a name="l00457"></a>00457       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00458"></a>00458    }
<a name="l00459"></a>00459    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"* Userid %s loaded in realtime cache. \n"</span>, user-&gt;name);
<a name="l00460"></a>00460    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Realtime cache:        %d objects (%-10.10d kb) %d %% full\n"</span>, <a class="code" href="res__astum_8c.html#595a5c0d7ae5700453d5f991ca2dbdae">aum_usercache_count</a>, (<span class="keywordtype">int</span>) (<a class="code" href="res__astum_8c.html#595a5c0d7ae5700453d5f991ca2dbdae">aum_usercache_count</a> * (<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a>) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__usercache__struct.html">aum_usercache_struct</a>)) / 1000), (<span class="keywordtype">int</span>) (<a class="code" href="res__astum_8c.html#595a5c0d7ae5700453d5f991ca2dbdae">aum_usercache_count</a> / <a class="code" href="res__astum_8c.html#3b28ee7e07abf7ced3662bf4f6697dcd">aum_usercache_max</a> * 100 ) );
<a name="l00461"></a>00461    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"\n"</span>);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00464"></a>00464 }
<a name="l00465"></a>00465 <span class="comment"></span>
<a name="l00466"></a>00466 <span class="comment">/*! \brief CLI command description */</span>
<a name="l00467"></a><a class="code" href="res__astum_8c.html#7277b75e569e91be02f13de8f6a73885">00467</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__astum_8c.html#7277b75e569e91be02f13de8f6a73885">cli_aum_show_user_usage</a>[] = 
<a name="l00468"></a>00468 <span class="stringliteral">"Usage: aum show user &lt;user&gt;\n"</span>
<a name="l00469"></a>00469 <span class="stringliteral">"  Lists details about one AUM user, either static or a realtime user in the realtime cache.\n"</span>
<a name="l00470"></a>00470 <span class="stringliteral">"  To load a user in the realtime cache, use \"aum load rtuser\"\n"</span>
<a name="l00471"></a>00471 <span class="stringliteral">"  For a list of all static users, use \"aum show users\"\n"</span>;
<a name="l00472"></a>00472 <span class="comment"></span>
<a name="l00473"></a>00473 <span class="comment">/*! \brief CLI command "aum show user" */</span>
<a name="l00474"></a><a class="code" href="res__astum_8c.html#4375bd5ccc7d1385a3f3d3a53c672737">00474</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#4375bd5ccc7d1385a3f3d3a53c672737">cli_aum_show_user</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00475"></a>00475 {
<a name="l00476"></a>00476    <span class="keyword">struct </span><a class="code" href="structaum__group__member.html">aum_group_member</a> *<a class="code" href="structmember.html">member</a>;
<a name="l00477"></a>00477    <span class="keyword">struct </span><a class="code" href="structaum__context.html">aum_context</a> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>;
<a name="l00478"></a>00478    <span class="keyword">struct </span><a class="code" href="structaum__address.html">aum_address</a> *addr;
<a name="l00479"></a>00479    <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>;
<a name="l00480"></a>00480    <span class="keyword">struct </span>timeval tv;
<a name="l00481"></a>00481    <span class="keyword">struct </span>tm tm;
<a name="l00482"></a>00482    
<a name="l00483"></a>00483 
<a name="l00484"></a>00484    <span class="keywordflow">if</span> (argc != 4)
<a name="l00485"></a>00485       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00486"></a>00486    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Trying to find user %s to show... \n"</span>, argv[3]);
<a name="l00487"></a>00487 
<a name="l00488"></a>00488    user = <a class="code" href="astum_8h.html#193a76f977f30b532eb9bccca7d0d8b9">find_aum_user</a>(argv[3], <a class="code" href="plc_8c.html#946003f97ccc52d5d3b54ac0ec31bbfc">FALSE</a>);
<a name="l00489"></a>00489    <span class="keywordflow">if</span> (!user) {
<a name="l00490"></a>00490       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"- AUM user %s not found\n"</span>, argv[3]);
<a name="l00491"></a>00491       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00492"></a>00492    }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"* Userid:        %s\n"</span>, user-&gt;name);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(user, <a class="code" href="astum_8h.html#6ad8155725a1f22cb2b08985ccb68d238bbed3f7071f380cb87b9ea966826684">AUM_USER_FLAG_REALTIME</a>))
<a name="l00497"></a>00497       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Usertype:   Realtime (cached)\n"</span>);
<a name="l00498"></a>00498    <span class="keywordflow">else</span>
<a name="l00499"></a>00499       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Usertype:   Static\n"</span>);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(user, <a class="code" href="astum_8h.html#6ad8155725a1f22cb2b08985ccb68d2377709f69647fb26330b781787c4027bd">AUM_USER_FLAG_DISABLED</a>))
<a name="l00502"></a>00502       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Status:     Disabled\n"</span>);
<a name="l00503"></a>00503    <span class="keywordflow">else</span>
<a name="l00504"></a>00504       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Status:     Enabled\n"</span>);
<a name="l00505"></a>00505 
<a name="l00506"></a>00506    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(user-&gt;<a class="code" href="structaum__user.html#e7cb80e19629cb66649ce1bbeaaf4ffc">title</a>))
<a name="l00507"></a>00507       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Title:      %s\n"</span>, user-&gt;<a class="code" href="structaum__user.html#e7cb80e19629cb66649ce1bbeaaf4ffc">title</a>);
<a name="l00508"></a>00508    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(user-&gt;<a class="code" href="structaum__user.html#0ff0a46e078589126485715107ee6175">last_name</a>))
<a name="l00509"></a>00509       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Name:       %s %s\n"</span>, user-&gt;<a class="code" href="structaum__user.html#ff4bb5940ba9aa31e82ac23bce34bd6a">first_name</a>, user-&gt;<a class="code" href="structaum__user.html#0ff0a46e078589126485715107ee6175">last_name</a>);
<a name="l00510"></a>00510    
<a name="l00511"></a>00511    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#1471e4e05a4db95d353cc867fe317314">groups</a>, member, list) {
<a name="l00512"></a>00512       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Member of:  %s\n"</span>, member-&gt;<a class="code" href="structaum__group__member.html#db0f6f37ebeb6ea09489124345af2a45">group</a>-&gt;name);
<a name="l00513"></a>00513    };
<a name="l00514"></a>00514 
<a name="l00515"></a>00515    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#884d9804999fc47a3c2694e49ad2536a">address</a>, addr, list) {
<a name="l00516"></a>00516       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Address:    %s - %s\n"</span>, <a class="code" href="res__astum_8c.html#201b6a416de57697d57b26cafeab26a8">aum_addrtype2txt</a>(addr-&gt;<a class="code" href="structaum__address.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>), addr-&gt;<a class="code" href="structaum__address.html#716bf5b8761420f27a8804154f75d738">address</a>);
<a name="l00517"></a>00517    };
<a name="l00518"></a>00518 
<a name="l00519"></a>00519    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#9be90dc64c1f5b5c993ff11d732a8da0">contexts</a>, context, list) {
<a name="l00520"></a>00520       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" %s Context : %s\n"</span>, <a class="code" href="res__astum_8c.html#3a0575e7b508cd30b91c36186e0ee2d2">context_type2str</a>(context-&gt;<a class="code" href="structaum__context.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>), context-&gt;<a class="code" href="structaum__context.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>);
<a name="l00521"></a>00521    };
<a name="l00522"></a>00522    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(user-&gt;<a class="code" href="structaum__user.html#3851af5f4bc758cb39c646b9b4efd21d">ldapdn</a>))
<a name="l00523"></a>00523       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  LDAP dn:       %s\n"</span>, user-&gt;<a class="code" href="structaum__user.html#3851af5f4bc758cb39c646b9b4efd21d">ldapdn</a>);
<a name="l00524"></a>00524    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Callgroup:     "</span>);
<a name="l00525"></a>00525    <a class="code" href="chan__sip_8c.html#591a4bb0fdd9fca1def3c4b91bc1ed7a">print_group</a>(fd, user-&gt;<a class="code" href="structaum__user.html#d435ec54d713513ab1d94049cbc33629">callgroup</a>, 0);
<a name="l00526"></a>00526    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Pickupgroup:   "</span>);
<a name="l00527"></a>00527    <a class="code" href="chan__sip_8c.html#591a4bb0fdd9fca1def3c4b91bc1ed7a">print_group</a>(fd, user-&gt;<a class="code" href="structaum__user.html#6a5ae60e87b5caa521ea5c2b36de96cc">pickupgroup</a>, 0);
<a name="l00528"></a>00528    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Channel group : %s\n"</span>, user-&gt;<a class="code" href="structaum__user.html#0ae5f6206a09288389cbb98d5eb0f3c0">channelgroup</a>);
<a name="l00529"></a>00529    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Numeric ID :    %s\n"</span>, user-&gt;<a class="code" href="structaum__user.html#c6b7c05f6f9e8d0ec2ca5596ca504936">numuserid</a>);
<a name="l00530"></a>00530    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Secret :        %s\n"</span>, !<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(user-&gt;<a class="code" href="structaum__user.html#4bb178d856d85e3399472bc0525dc657">secret</a>) ? <span class="stringliteral">"&lt;set&gt;"</span> : <span class="stringliteral">"&lt;not set&gt;"</span>);
<a name="l00531"></a>00531    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Music class:    %s\n"</span>, user-&gt;<a class="code" href="structaum__user.html#80439b02fbec6ba43c0438ad4d67348d">musicclass</a>);
<a name="l00532"></a>00532    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Language:       %s\n"</span>, user-&gt;<a class="code" href="structaum__user.html#8e5b6b627f81f1981fc6d241d6b3dd21">language</a>);
<a name="l00533"></a>00533    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(user-&gt;<a class="code" href="structaum__user.html#13159d7907ff4ef35fd3a1fd7e219118">timezone</a>)) {
<a name="l00534"></a>00534       gettimeofday(&amp;tv, NULL);
<a name="l00535"></a>00535       <a class="code" href="localtime_8h.html#7ed0b22e72553de90f7f3a1f0496baa7">ast_localtime</a>(&amp;tv.tv_sec, &amp;tm, user-&gt;<a class="code" href="structaum__user.html#13159d7907ff4ef35fd3a1fd7e219118">timezone</a>);
<a name="l00536"></a>00536       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Time zone:       %s (Current time: %02d:%02d\n"</span>, user-&gt;<a class="code" href="structaum__user.html#13159d7907ff4ef35fd3a1fd7e219118">timezone</a>, tm.tm_hour, tm.tm_min);
<a name="l00537"></a>00537    }
<a name="l00538"></a>00538    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" ACL:            %s\n"</span>, (user-&gt;<a class="code" href="structaum__user.html#a33915ba226b6dbd1edb3e09fac41ed9">acl</a>?<span class="stringliteral">"Yes (IP address restriction)"</span>:<span class="stringliteral">"No"</span>));
<a name="l00539"></a>00539    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structaum__user.html#b94a3a67b5d68e65a0e1065aac55b042">manager_write_perm</a> || user-&gt;<a class="code" href="structaum__user.html#65a8bc84e148e7cca02d8d8e26fd4653">manager_read_perm</a>) {
<a name="l00540"></a>00540       <span class="keywordtype">char</span> permbuf[120];
<a name="l00541"></a>00541       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Manager write:  %s\n"</span>, <a class="code" href="group__Group__AMI.html#g7a74ba6c31130ec1d434b549ec0bd523">authority_to_str</a>(user-&gt;<a class="code" href="structaum__user.html#b94a3a67b5d68e65a0e1065aac55b042">manager_write_perm</a>, permbuf, <span class="keyword">sizeof</span>(permbuf)));
<a name="l00542"></a>00542       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Manager read:  %s\n"</span>, <a class="code" href="group__Group__AMI.html#g7a74ba6c31130ec1d434b549ec0bd523">authority_to_str</a>(user-&gt;<a class="code" href="structaum__user.html#65a8bc84e148e7cca02d8d8e26fd4653">manager_read_perm</a>, permbuf, <span class="keyword">sizeof</span>(permbuf)));
<a name="l00543"></a>00543    }
<a name="l00544"></a>00544    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structaum__user.html#1a366a2de522c52f41f6de2219adf59b">chanvars</a>) {
<a name="l00545"></a>00545       <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *v;
<a name="l00546"></a>00546       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Variables    :\n"</span>);
<a name="l00547"></a>00547       <span class="keywordflow">for</span> (v = user-&gt;<a class="code" href="structaum__user.html#1a366a2de522c52f41f6de2219adf59b">chanvars</a> ; v ; v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>)
<a name="l00548"></a>00548          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"                 %s = %s\n"</span>, v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00549"></a>00549    }
<a name="l00550"></a>00550    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd,<span class="stringliteral">"\n"</span>);
<a name="l00551"></a>00551    
<a name="l00552"></a>00552    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00553"></a>00553 }
<a name="l00554"></a>00554 <span class="comment"></span>
<a name="l00555"></a>00555 <span class="comment">/*! \brief CLI command description */</span>
<a name="l00556"></a><a class="code" href="res__astum_8c.html#fa5365ba180a5c8d6b863dd8ace468a8">00556</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__astum_8c.html#fa5365ba180a5c8d6b863dd8ace468a8">cli_aum_show_group_usage</a>[] = 
<a name="l00557"></a>00557 <span class="stringliteral">"Usage: aum show group &lt;group&gt;\n"</span>
<a name="l00558"></a>00558 <span class="stringliteral">"  Lists details about one AUM group.\n"</span>
<a name="l00559"></a>00559 <span class="stringliteral">"  For a list of all static groups, use \"aum show groups\"\n"</span>;
<a name="l00560"></a>00560 <span class="comment"></span>
<a name="l00561"></a>00561 <span class="comment">/*! \brief CLI command "aum show group" */</span>
<a name="l00562"></a><a class="code" href="res__astum_8c.html#00625bec7d45aa46d68408b318a490fa">00562</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#00625bec7d45aa46d68408b318a490fa">cli_aum_show_group</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00563"></a>00563 {
<a name="l00564"></a>00564    <span class="keyword">struct </span><a class="code" href="structaum__address.html">aum_address</a> *addr;
<a name="l00565"></a>00565    <span class="keyword">struct </span><a class="code" href="structaum__context.html">aum_context</a> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>;
<a name="l00566"></a>00566    <span class="keyword">struct </span><a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a>;
<a name="l00567"></a>00567    <span class="keyword">struct </span><a class="code" href="structaum__group__member.html">aum_group_member</a> *<a class="code" href="structmember.html">member</a>;
<a name="l00568"></a>00568    <span class="keywordtype">int</span> groupmembers = 0;
<a name="l00569"></a>00569 
<a name="l00570"></a>00570    <span class="keywordflow">if</span> (argc != 4)
<a name="l00571"></a>00571       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00572"></a>00572    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Trying to find group %s to show... \n"</span>, argv[3]);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574    group = <a class="code" href="astum_8h.html#d910eebd103db9cd510cd15e10e3ee4b">find_aum_group_by_name</a>(argv[3]);
<a name="l00575"></a>00575    <span class="keywordflow">if</span> (!group) {
<a name="l00576"></a>00576       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"- AUM group %s not found\n"</span>, argv[3]);
<a name="l00577"></a>00577       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00578"></a>00578    }
<a name="l00579"></a>00579    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"* Group:         %s\n"</span>, group-&gt;name);
<a name="l00580"></a>00580    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;group-&gt;<a class="code" href="structaum__group.html#d2e3083420929d8bfae81f58fa4594cb">members</a>, member, list) {
<a name="l00581"></a>00581       groupmembers++;
<a name="l00582"></a>00582    };
<a name="l00583"></a>00583    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Number of members: %d\n"</span>, groupmembers);
<a name="l00584"></a>00584 
<a name="l00585"></a>00585    <span class="comment">//if (ast_test_flag(group, AUM_USER_FLAG_REALTIME))</span>
<a name="l00586"></a>00586       <span class="comment">//ast_cli(fd, " Usertype:   Realtime (cached)\n");</span>
<a name="l00587"></a>00587    <span class="comment">//else</span>
<a name="l00588"></a>00588       <span class="comment">//ast_cli(fd, " Usertype:   Static\n");</span>
<a name="l00589"></a>00589 
<a name="l00590"></a>00590    <span class="comment">//if (ast_test_flag(group, AUM_USER_FLAG_DISABLED))</span>
<a name="l00591"></a>00591       <span class="comment">//ast_cli(fd, " Status:     Disabled\n");</span>
<a name="l00592"></a>00592    <span class="comment">//else</span>
<a name="l00593"></a>00593       <span class="comment">//ast_cli(fd, " Status:     Enabled\n");</span>
<a name="l00594"></a>00594 
<a name="l00595"></a>00595    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(group-&gt;<a class="code" href="structaum__group.html#67daf92c833c41c95db874e18fcb2786">description</a>))
<a name="l00596"></a>00596       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Description:       %s\n"</span>, group-&gt;<a class="code" href="structaum__group.html#67daf92c833c41c95db874e18fcb2786">description</a>);
<a name="l00597"></a>00597    
<a name="l00598"></a>00598    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;group-&gt;<a class="code" href="structaum__group.html#9be90dc64c1f5b5c993ff11d732a8da0">contexts</a>, context, list) {
<a name="l00599"></a>00599       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" %s Context : %s\n"</span>, <a class="code" href="res__astum_8c.html#3a0575e7b508cd30b91c36186e0ee2d2">context_type2str</a>(context-&gt;<a class="code" href="structaum__context.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>), context-&gt;<a class="code" href="structaum__context.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>);
<a name="l00600"></a>00600    };
<a name="l00601"></a>00601    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Callgroups:    "</span>);
<a name="l00602"></a>00602    <a class="code" href="chan__sip_8c.html#591a4bb0fdd9fca1def3c4b91bc1ed7a">print_group</a>(fd, group-&gt;<a class="code" href="structaum__group.html#d435ec54d713513ab1d94049cbc33629">callgroup</a>, 0);
<a name="l00603"></a>00603    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Pickupgroups:  "</span>);
<a name="l00604"></a>00604    <a class="code" href="chan__sip_8c.html#591a4bb0fdd9fca1def3c4b91bc1ed7a">print_group</a>(fd, group-&gt;<a class="code" href="structaum__group.html#6a5ae60e87b5caa521ea5c2b36de96cc">pickupgroup</a>, 0);
<a name="l00605"></a>00605    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Music class:    %s\n"</span>, group-&gt;<a class="code" href="structaum__group.html#80439b02fbec6ba43c0438ad4d67348d">musicclass</a>);
<a name="l00606"></a>00606    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Language:       %s\n"</span>, group-&gt;<a class="code" href="structaum__group.html#8e5b6b627f81f1981fc6d241d6b3dd21">language</a>);
<a name="l00607"></a>00607    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Timezone:       %s\n"</span>, group-&gt;<a class="code" href="structaum__group.html#13159d7907ff4ef35fd3a1fd7e219118">timezone</a>);
<a name="l00608"></a>00608    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" ACL:            %s\n"</span>, (group-&gt;<a class="code" href="structaum__group.html#a33915ba226b6dbd1edb3e09fac41ed9">acl</a>?<span class="stringliteral">"Yes (IP address restriction)"</span>:<span class="stringliteral">"No"</span>));
<a name="l00609"></a>00609    <span class="keywordflow">if</span> (group-&gt;<a class="code" href="structaum__group.html#b94a3a67b5d68e65a0e1065aac55b042">manager_write_perm</a> || group-&gt;<a class="code" href="structaum__group.html#65a8bc84e148e7cca02d8d8e26fd4653">manager_read_perm</a>) {
<a name="l00610"></a>00610       <span class="keywordtype">char</span> permbuf[120];
<a name="l00611"></a>00611       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Manager write:  %s\n"</span>, <a class="code" href="group__Group__AMI.html#g7a74ba6c31130ec1d434b549ec0bd523">authority_to_str</a>(group-&gt;<a class="code" href="structaum__group.html#b94a3a67b5d68e65a0e1065aac55b042">manager_write_perm</a>, permbuf, <span class="keyword">sizeof</span>(permbuf)));
<a name="l00612"></a>00612       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" Manager read:  %s\n"</span>, <a class="code" href="group__Group__AMI.html#g7a74ba6c31130ec1d434b549ec0bd523">authority_to_str</a>(group-&gt;<a class="code" href="structaum__group.html#65a8bc84e148e7cca02d8d8e26fd4653">manager_read_perm</a>, permbuf, <span class="keyword">sizeof</span>(permbuf)));
<a name="l00613"></a>00613    }
<a name="l00614"></a>00614    <span class="keywordflow">if</span> (group-&gt;<a class="code" href="structaum__group.html#1a366a2de522c52f41f6de2219adf59b">chanvars</a>) {
<a name="l00615"></a>00615       <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *v;
<a name="l00616"></a>00616       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"  Variables    :\n"</span>);
<a name="l00617"></a>00617       <span class="keywordflow">for</span> (v = group-&gt;<a class="code" href="structaum__group.html#1a366a2de522c52f41f6de2219adf59b">chanvars</a> ; v ; v = v-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>)
<a name="l00618"></a>00618          <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"                 %s = %s\n"</span>, v-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, v-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l00619"></a>00619    }
<a name="l00620"></a>00620    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd,<span class="stringliteral">"\n"</span>);
<a name="l00621"></a>00621    
<a name="l00622"></a>00622    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00623"></a>00623 }
<a name="l00624"></a>00624 <span class="comment"></span>
<a name="l00625"></a>00625 <span class="comment">/*! \brief CLI command description */</span>
<a name="l00626"></a><a class="code" href="res__astum_8c.html#fa68bf35e4c7fb609b1cd04cebbad24a">00626</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__astum_8c.html#fa68bf35e4c7fb609b1cd04cebbad24a">cli_aum_show_groups_usage</a>[] = 
<a name="l00627"></a>00627 <span class="stringliteral">"Usage: aum show groups\n"</span>
<a name="l00628"></a>00628 <span class="stringliteral">"  Lists all configured AUM groups.\n"</span>
<a name="l00629"></a>00629 <span class="stringliteral">"  For details on a specific group, use \"aum show group &lt;name&gt;\"\n"</span>;
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 <span class="comment"></span>
<a name="l00632"></a>00632 <span class="comment">/*! \brief CLI command "aum show groups" */</span>
<a name="l00633"></a><a class="code" href="res__astum_8c.html#7f4a4641c16f6fce9301b85a73134f68">00633</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#7f4a4641c16f6fce9301b85a73134f68">cli_aum_show_groups</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00634"></a>00634 {
<a name="l00635"></a>00635    <span class="keywordtype">int</span> numgroups = 0;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637    <span class="keywordflow">if</span> (argc != 3)
<a name="l00638"></a>00638       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d7f3bcd35c16172e6fc0964a175fcadb">RESULT_SHOWUSAGE</a>;
<a name="l00639"></a>00639    
<a name="l00640"></a>00640    <a class="code" href="astobj_8h.html#0d158ef06434f7b47d5a7eddaa24f18a">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__astum_8c.html#df751995f211be58a457c2d71dc6dc19">aum_grouplist</a>, 1, {
<a name="l00641"></a>00641       <a class="code" href="astobj_8h.html#013e2f1442ca7e5cd2cb0756766cd6c7">ASTOBJ_RDLOCK</a>(iterator);
<a name="l00642"></a>00642       <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">" %-20.20s %55s\n"</span>, iterator-&gt;name, (iterator-&gt;description ? iterator-&gt;description : <span class="stringliteral">""</span>) );
<a name="l00643"></a>00643       numgroups ++;
<a name="l00644"></a>00644       <a class="code" href="astobj_8h.html#09df6ddac721782b63dde9c9247b5285">ASTOBJ_UNLOCK</a>(iterator);
<a name="l00645"></a>00645    } );
<a name="l00646"></a>00646 
<a name="l00647"></a>00647    <a class="code" href="cli_8c.html#b610d6e1fd70e1b164d66a2ee22207dc">ast_cli</a>(fd, <span class="stringliteral">"-- %d AUM groups\n\n"</span>, numgroups);
<a name="l00648"></a>00648 
<a name="l00649"></a>00649    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#d92028a33e35e9d037718f4d846096f9">RESULT_SUCCESS</a>;
<a name="l00650"></a>00650 }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652 
<a name="l00653"></a>00653 <span class="comment"></span>
<a name="l00654"></a>00654 <span class="comment">/*! \brief CLI entries for the AUM module */</span>
<a name="l00655"></a><a class="code" href="res__astum_8c.html#d41cfb9797a324bfbf477ff50adc3368">00655</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html">ast_cli_entry</a> my_clis[] = {
<a name="l00656"></a>00656    { { <span class="stringliteral">"aum"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"groups"</span>, NULL }, <a class="code" href="res__astum_8c.html#7f4a4641c16f6fce9301b85a73134f68">cli_aum_show_groups</a>, <span class="stringliteral">"List AUM groups"</span>, <a class="code" href="res__astum_8c.html#fa68bf35e4c7fb609b1cd04cebbad24a">cli_aum_show_groups_usage</a> },
<a name="l00657"></a>00657    { { <span class="stringliteral">"aum"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"group"</span>, NULL }, <a class="code" href="res__astum_8c.html#00625bec7d45aa46d68408b318a490fa">cli_aum_show_group</a>, <span class="stringliteral">"List details of AUM group"</span>, <a class="code" href="res__astum_8c.html#fa5365ba180a5c8d6b863dd8ace468a8">cli_aum_show_group_usage</a> },
<a name="l00658"></a>00658    { { <span class="stringliteral">"aum"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"users"</span>, NULL }, <a class="code" href="res__astum_8c.html#ab3111666dddaa9db0d1861414e4b18c">cli_aum_show_users</a>, <span class="stringliteral">"List AUM users"</span>, <a class="code" href="res__astum_8c.html#be7ddd36b2aa7fa123dafb18bf6ef231">cli_aum_show_users_usage</a> },
<a name="l00659"></a>00659    { { <span class="stringliteral">"aum"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"user"</span>, NULL }, <a class="code" href="res__astum_8c.html#4375bd5ccc7d1385a3f3d3a53c672737">cli_aum_show_user</a>, <span class="stringliteral">"List details of AUM user"</span>, <a class="code" href="res__astum_8c.html#7277b75e569e91be02f13de8f6a73885">cli_aum_show_user_usage</a> },
<a name="l00660"></a>00660    { { <span class="stringliteral">"aum"</span>, <span class="stringliteral">"show"</span>, <span class="stringliteral">"stats"</span>, NULL }, <a class="code" href="res__astum_8c.html#033335b0943094281eb7074b9d5a47b7">cli_aum_show_stats</a>, <span class="stringliteral">"Display AUM statistics"</span>, <a class="code" href="res__astum_8c.html#d28ea856c8a5f557315ad81f2d94c52e">cli_aum_show_stats_usage</a> },
<a name="l00661"></a>00661    { { <span class="stringliteral">"aum"</span>, <span class="stringliteral">"load"</span>, <span class="stringliteral">"rtuser"</span>, NULL }, <a class="code" href="res__astum_8c.html#ef446c3018722e876b370b46e702fac5">cli_aum_load_rtuser</a>, <span class="stringliteral">"Load realtime AUM user in cache"</span>, <a class="code" href="res__astum_8c.html#a782f0e2eef42789727fbe2da50d11d2">cli_aum_load_rtuser_usage</a> },
<a name="l00662"></a>00662 };
<a name="l00663"></a>00663 
<a name="l00664"></a>00664 <span class="comment">/*----------------------------- DIALPLAN FUNCTIONS ---------------------*/</span>
<a name="l00665"></a><a class="code" href="res__astum_8c.html#964847df638061679ad6b942e362b1fc">00665</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__astum_8c.html#964847df638061679ad6b942e362b1fc">func_aumuser_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html">ast_channel</a> *<a class="code" href="adsistub_8c.html#26c322652770620e64ac90682eb6504c">chan</a>, <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *data, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>, size_t <a class="code" href="utils_8h.html#f5a8e923f8cd24b56b3bab32358cc58a">len</a>)
<a name="l00666"></a>00666 {
<a name="l00667"></a>00667    <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>;
<a name="l00668"></a>00668    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#8d6242bc80162ac99dd4d368eabe77cc">s</a>, *args[2];
<a name="l00669"></a>00669    <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#14c4b06b824ec593239362517f538b29">username</a>, *param;
<a name="l00670"></a>00670    <span class="keywordtype">int</span> <a class="code" href="dlfcn_8c.html#9989047f9754c69a45ea752cb417ca79">error</a> = 0;
<a name="l00671"></a>00671    <span class="keywordtype">char</span> *res = NULL;
<a name="l00672"></a>00672 
<a name="l00673"></a>00673    buf[0] = <span class="charliteral">'\0'</span>; <span class="comment">/* Reset buffer */</span>
<a name="l00674"></a>00674 
<a name="l00675"></a>00675    <span class="keywordflow">if</span> (!data) {
<a name="l00676"></a>00676       error = 1;
<a name="l00677"></a>00677    } <span class="keywordflow">else</span> {
<a name="l00678"></a>00678       s = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>((<span class="keywordtype">char</span> *) data);
<a name="l00679"></a>00679       <span class="keywordflow">if</span> (!s) {
<a name="l00680"></a>00680          error = 1;
<a name="l00681"></a>00681       } <span class="keywordflow">else</span> {
<a name="l00682"></a>00682          <a class="code" href="app_8c.html#dcdae17d64f9e1f0fe1879e70961f028">ast_app_separate_args</a>(s, <span class="charliteral">'|'</span>, args, 2);
<a name="l00683"></a>00683          username = args[0];
<a name="l00684"></a>00684          param = args[1];
<a name="l00685"></a>00685          <span class="keywordflow">if</span> (!param)
<a name="l00686"></a>00686             error = 1;
<a name="l00687"></a>00687       }
<a name="l00688"></a>00688    }
<a name="l00689"></a>00689 
<a name="l00690"></a>00690    <span class="keywordflow">if</span> (error) {
<a name="l00691"></a>00691       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"This function requires two parameters.\n"</span>);
<a name="l00692"></a>00692       <span class="keywordflow">return</span> (<span class="keywordtype">char</span>*) NULL;
<a name="l00693"></a>00693    }
<a name="l00694"></a>00694    user = <a class="code" href="astum_8h.html#193a76f977f30b532eb9bccca7d0d8b9">find_aum_user</a>(username, <a class="code" href="plc_8c.html#946003f97ccc52d5d3b54ac0ec31bbfc">FALSE</a>);
<a name="l00695"></a>00695    <span class="keywordflow">if</span> (!user) {
<a name="l00696"></a>00696       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"AUM user ID %s not found.\n"</span>, username);
<a name="l00697"></a>00697       <span class="keywordflow">return</span> (<span class="keywordtype">char</span>*) NULL;
<a name="l00698"></a>00698    }
<a name="l00699"></a>00699    <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"email"</span>)) {
<a name="l00700"></a>00700       res = <a class="code" href="astum_8h.html#16992249397edb9a870daba8809c14f3">aum_find_email_full</a>(user);
<a name="l00701"></a>00701    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"xmpp"</span>)) {
<a name="l00702"></a>00702       res = <a class="code" href="astum_8h.html#072e629f1d7a418f927edd707df10807">aum_find_address</a>(user, <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf4cdd2da976ae0ab88be29d9d1bc50a0b">AUM_ADDR_XMPP</a>);
<a name="l00703"></a>00703    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"sip"</span>)) {
<a name="l00704"></a>00704       res = <a class="code" href="astum_8h.html#072e629f1d7a418f927edd707df10807">aum_find_address</a>(user, <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf11652df43c78789328352cfe6a31a1a0">AUM_ADDR_SIP</a>);
<a name="l00705"></a>00705    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"tel"</span>)) {
<a name="l00706"></a>00706       res = <a class="code" href="astum_8h.html#072e629f1d7a418f927edd707df10807">aum_find_address</a>(user, <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf55672bff653f58ae2f14ca158ba2bd8e">AUM_ADDR_TEL</a>);
<a name="l00707"></a>00707    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"iax2"</span>)) {
<a name="l00708"></a>00708       res = <a class="code" href="astum_8h.html#072e629f1d7a418f927edd707df10807">aum_find_address</a>(user, <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfcc33cc480318cfc21f2b8b730914ba76">AUM_ADDR_IAX2</a>);
<a name="l00709"></a>00709    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"fwd"</span>)) {
<a name="l00710"></a>00710       res = <a class="code" href="astum_8h.html#072e629f1d7a418f927edd707df10807">aum_find_address</a>(user, <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cff1789fd0775dc1abeb33abf37cf17de2">AUM_ADDR_FWD</a>);
<a name="l00711"></a>00711    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"cust0"</span>)) {
<a name="l00712"></a>00712       res = <a class="code" href="astum_8h.html#072e629f1d7a418f927edd707df10807">aum_find_address</a>(user, <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfc918f12d1ca9ccb3e25f9dbcdd7e8002">AUM_ADDR_CUST0</a>);
<a name="l00713"></a>00713    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"cust1"</span>)) {
<a name="l00714"></a>00714       res = <a class="code" href="astum_8h.html#072e629f1d7a418f927edd707df10807">aum_find_address</a>(user, <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfe15d228bb079d1ce20763baf14788d24">AUM_ADDR_CUST1</a>);
<a name="l00715"></a>00715    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"cust2"</span>)) {
<a name="l00716"></a>00716       res = <a class="code" href="astum_8h.html#072e629f1d7a418f927edd707df10807">aum_find_address</a>(user, <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf6457ae16e903dc1ce696b7c81a410f3e">AUM_ADDR_CUST2</a>);
<a name="l00717"></a>00717    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"cust3"</span>)) {
<a name="l00718"></a>00718       res = <a class="code" href="astum_8h.html#072e629f1d7a418f927edd707df10807">aum_find_address</a>(user, <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfbb176a2eb462fe6500bffbe51652f9aa">AUM_ADDR_CUST3</a>);
<a name="l00719"></a>00719    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"cust4"</span>)) {
<a name="l00720"></a>00720       res = <a class="code" href="astum_8h.html#072e629f1d7a418f927edd707df10807">aum_find_address</a>(user, <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfc3f066ffff407fda7bce0ad3dcde1a36">AUM_ADDR_CUST4</a>);
<a name="l00721"></a>00721    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"numuserid"</span>)) {
<a name="l00722"></a>00722       res = user-&gt;<a class="code" href="structaum__user.html#c6b7c05f6f9e8d0ec2ca5596ca504936">numuserid</a>;
<a name="l00723"></a>00723    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"pincode"</span>)) {
<a name="l00724"></a>00724       res = user-&gt;<a class="code" href="structaum__user.html#034bb11d597ab840a6622019ece5038f">pincode</a>;
<a name="l00725"></a>00725    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"firstname"</span>)) {
<a name="l00726"></a>00726       res = user-&gt;<a class="code" href="structaum__user.html#ff4bb5940ba9aa31e82ac23bce34bd6a">first_name</a>;
<a name="l00727"></a>00727    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"lastname"</span>)) {
<a name="l00728"></a>00728       res = user-&gt;<a class="code" href="structaum__user.html#ff4bb5940ba9aa31e82ac23bce34bd6a">first_name</a>;
<a name="l00729"></a>00729    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"title"</span>)) {
<a name="l00730"></a>00730       res = user-&gt;<a class="code" href="structaum__user.html#e7cb80e19629cb66649ce1bbeaaf4ffc">title</a>;
<a name="l00731"></a>00731    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"musicclass"</span>)) {
<a name="l00732"></a>00732       res = user-&gt;<a class="code" href="structaum__user.html#80439b02fbec6ba43c0438ad4d67348d">musicclass</a>;
<a name="l00733"></a>00733    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"language"</span>)) {
<a name="l00734"></a>00734       res = user-&gt;<a class="code" href="structaum__user.html#8e5b6b627f81f1981fc6d241d6b3dd21">language</a>;
<a name="l00735"></a>00735    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"accountcode"</span>)) {
<a name="l00736"></a>00736       res = user-&gt;<a class="code" href="structaum__user.html#6c4d520c88ca77ed2acc04ae1add9f8e">accountcode</a>;
<a name="l00737"></a>00737    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"cidnum"</span>)) {
<a name="l00738"></a>00738        res = user-&gt;<a class="code" href="structaum__user.html#ce037b538ac4ffb9fc87c43fb24feafc">cid_num</a>;
<a name="l00739"></a>00739    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"cidname"</span>)) {
<a name="l00740"></a>00740        res = user-&gt;<a class="code" href="structaum__user.html#d32e37c15e50d082935eab51f32d28e1">cid_name</a>;
<a name="l00741"></a>00741    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"channelgroup"</span>)) {
<a name="l00742"></a>00742        res = user-&gt;<a class="code" href="structaum__user.html#0ae5f6206a09288389cbb98d5eb0f3c0">channelgroup</a>;
<a name="l00743"></a>00743    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"timezone"</span>)) {
<a name="l00744"></a>00744       res = user-&gt;<a class="code" href="structaum__user.html#13159d7907ff4ef35fd3a1fd7e219118">timezone</a>;
<a name="l00745"></a>00745    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"currenttime"</span>)) {
<a name="l00746"></a>00746       <span class="keyword">struct </span>tm tm;
<a name="l00747"></a>00747       <span class="keyword">struct </span>timeval tv;
<a name="l00748"></a>00748 
<a name="l00749"></a>00749       gettimeofday(&amp;tv, NULL);
<a name="l00750"></a>00750       <a class="code" href="localtime_8h.html#7ed0b22e72553de90f7f3a1f0496baa7">ast_localtime</a>(&amp;tv.tv_sec, &amp;tm, user-&gt;<a class="code" href="structaum__user.html#13159d7907ff4ef35fd3a1fd7e219118">timezone</a>);
<a name="l00751"></a>00751       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"%02d:%02d:%02d"</span>, tm.tm_hour, tm.tm_min, tm.tm_sec);
<a name="l00752"></a>00752    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"name"</span>)) {
<a name="l00753"></a>00753        snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"%s %s"</span>, user-&gt;<a class="code" href="structaum__user.html#ff4bb5940ba9aa31e82ac23bce34bd6a">first_name</a>, user-&gt;<a class="code" href="structaum__user.html#0ff0a46e078589126485715107ee6175">last_name</a>);
<a name="l00754"></a>00754    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(param, <span class="stringliteral">"vmbox"</span>)) {
<a name="l00755"></a>00755        snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"%s@%s"</span>, user-&gt;<a class="code" href="structaum__user.html#be2fc5fd64209e633c78549d39c04fb2">mailbox</a>, <a class="code" href="astum_8h.html#4eb80065d680923883153124d6b710f5">aum_find_user_context</a>(user, <a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc196d15e49e3a2bb0f343502e047f9424b2">AUM_CONTEXT_VOICEMAIL</a>));
<a name="l00756"></a>00756    } <span class="keywordflow">else</span> {
<a name="l00757"></a>00757       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Unknown parameter: %s\n"</span>, param);
<a name="l00758"></a>00758       <span class="keywordflow">return</span> (<span class="keywordtype">char</span>*) NULL;
<a name="l00759"></a>00759    }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761    <span class="keywordflow">if</span> (res)
<a name="l00762"></a>00762       ast_copy_string(buf, res, len);
<a name="l00763"></a>00763    <span class="keywordflow">return</span> buf;
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 <span class="comment"></span>
<a name="l00766"></a>00766 <span class="comment">/*! Dial plan function AUM-USER */</span>
<a name="l00767"></a><a class="code" href="res__astum_8c.html#215e50bc5c871c1c28cb6e8445b333ce">00767</a> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html">ast_custom_function</a> aum_user_function = {
<a name="l00768"></a>00768    .<a class="code" href="structast__custom__function.html#b068931cc450442b63f5b3d276ea4297">name</a> = <span class="stringliteral">"AUM-USER"</span>,
<a name="l00769"></a>00769    .synopsis = <span class="stringliteral">"Gets AUM User information"</span>,
<a name="l00770"></a>00770    .syntax = <span class="stringliteral">"AUM-USER(&lt;userid&gt;,&lt;param&gt;)"</span>,
<a name="l00771"></a>00771    .read = <a class="code" href="res__astum_8c.html#964847df638061679ad6b942e362b1fc">func_aumuser_read</a>,
<a name="l00772"></a>00772    .desc = <span class="stringliteral">"Valid parameters are:\n"</span>
<a name="l00773"></a>00773    <span class="stringliteral">"- accountcode    Account code\n"</span>
<a name="l00774"></a>00774    <span class="stringliteral">"- channelgroup      Default channel group\n"</span>
<a name="l00775"></a>00775    <span class="stringliteral">"- cidnum      Caller ID number\n"</span>
<a name="l00776"></a>00776    <span class="stringliteral">"- cidname     Caller ID name\n"</span>
<a name="l00777"></a>00777    <span class="stringliteral">"- currenttime    Current time in user's timezone\n"</span>
<a name="l00778"></a>00778    <span class="stringliteral">"- email    Email address\n"</span>
<a name="l00779"></a>00779    <span class="stringliteral">"- firstname      First name\n"</span>
<a name="l00780"></a>00780    <span class="stringliteral">"- fwd         FWD number\n"</span>
<a name="l00781"></a>00781    <span class="stringliteral">"- iax2        IAX2 address\n"</span>
<a name="l00782"></a>00782    <span class="stringliteral">"- lastname    Last name\n"</span>
<a name="l00783"></a>00783    <span class="stringliteral">"- musicclass     Default music class (MOH)\n"</span>
<a name="l00784"></a>00784    <span class="stringliteral">"- name        First and last name\n"</span>
<a name="l00785"></a>00785    <span class="stringliteral">"- numuserid      Numeric User ID\n"</span>
<a name="l00786"></a>00786    <span class="stringliteral">"- pincode     User's Pincode\n"</span>
<a name="l00787"></a>00787    <span class="stringliteral">"- sip         SIP address\n"</span>
<a name="l00788"></a>00788    <span class="stringliteral">"- tel         Telephone number\n"</span>
<a name="l00789"></a>00789    <span class="stringliteral">"- timezone    Timezone\n"</span>
<a name="l00790"></a>00790    <span class="stringliteral">"- vmbox    Voicemail box for user (mbox@vmcontext)\n"</span>
<a name="l00791"></a>00791    <span class="stringliteral">"- xmpp        XMPP/Jabber address\n"</span>
<a name="l00792"></a>00792    <span class="stringliteral">"\n"</span>,
<a name="l00793"></a>00793 };
<a name="l00794"></a>00794 
<a name="l00795"></a>00795 <span class="comment">/*-------------------------AUM_STRING SUPPORT--------------------------*/</span>
<a name="l00796"></a>00796 <span class="preprocessor">#ifdef STRING_I18N</span>
<a name="l00797"></a>00797 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00798"></a>00798 <span class="comment">/*! \note This part of the code is not done yet. The idea is to </span>
<a name="l00799"></a>00799 <span class="comment">   be able to configure caller ID names in multiple character sets.</span>
<a name="l00800"></a>00800 <span class="comment">   If they are not available in required character set, then we'll</span>
<a name="l00801"></a>00801 <span class="comment">   convert by using libiconv.</span>
<a name="l00802"></a>00802 <span class="comment"></span>
<a name="l00803"></a>00803 <span class="comment">   option = charset::value</span>
<a name="l00804"></a>00804 <span class="comment">   </span>
<a name="l00805"></a>00805 <span class="comment">   cidname = UTF8::Jrgen Blbr</span>
<a name="l00806"></a>00806 <span class="comment">   cidname = ASCII::Jorgen Blabar</span>
<a name="l00807"></a>00807 <span class="comment"></span>
<a name="l00808"></a>00808 <span class="comment">   Then the channel should know how to handle this and send UTF8 Caller ID Names</span>
<a name="l00809"></a>00809 <span class="comment">   on SIP, but ASCII on PRI</span>
<a name="l00810"></a>00810 <span class="comment"> */</span>
<a name="l00811"></a>00811 
<a name="l00812"></a>00812 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaum__string__convert.html">aum_string_convert</a> aum_string_labels[] = {
<a name="l00813"></a>00813    { <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc62a3b181a5271b44161fadf567dffd3fb">AUM_CHAR_ASCII</a>, <span class="stringliteral">"ASCII"</span>  },
<a name="l00814"></a>00814    { <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc68cd69b102fbe2ea2a2afd5c408ded164">AUM_CHAR_ISO8859_1</a>,   <span class="stringliteral">"ISO8859-1"</span> },
<a name="l00815"></a>00815    { <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc676bf79cd5518f061de544f4d6e32327a">AUM_CHAR_ISO8859_2</a>,   <span class="stringliteral">"ISO8859-2"</span> },
<a name="l00816"></a>00816    { <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc6c9ea6a3075afcd2dd6560da69d500df4">AUM_CHAR_ISO8859_3</a>,   <span class="stringliteral">"ISO8859-3"</span> },
<a name="l00817"></a>00817    { <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc61b41b6ae2482f24fbf42c24b17ac82e5">AUM_CHAR_UTF8</a>,  <span class="stringliteral">"UTF8"</span>   },
<a name="l00818"></a>00818 };
<a name="l00819"></a>00819 
<a name="l00820"></a>00820 <a class="code" href="structaum__string__struct.html">aum_string</a> *<a class="code" href="astum_8h.html#1b2d57e8039de5eee85e4112c87799c6">aum_string_alloc</a>(<span class="keywordtype">char</span> *string, <span class="keyword">enum</span> <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc6">aum_string_charset</a> <a class="code" href="app__voicemail_8c.html#a394dd933819e2418e7be47ee8fbc2f0">charset</a>)
<a name="l00821"></a>00821 {
<a name="l00822"></a>00822    <a class="code" href="structaum__string__struct.html">aum_string</a> *temp = NULL;
<a name="l00823"></a>00823 
<a name="l00824"></a>00824    <span class="keywordflow">if</span> (!string || charset == <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc6328a227787b16ee4f6086a86fcb4995f">AUM_CHAR_UNKNOWN</a>)
<a name="l00825"></a>00825       <span class="keywordflow">return</span> temp;   <span class="comment">/* Null */</span>
<a name="l00826"></a>00826 
<a name="l00827"></a>00827    temp = (<a class="code" href="structaum__string__struct.html">aum_string</a> *) <a class="code" href="res__astum_8c.html#e7c38e3f31f3b834ced400a0ef0d5393">aum_allocate</a>(<span class="keyword">sizeof</span>(<a class="code" href="structaum__string__struct.html">aum_string</a>));
<a name="l00828"></a>00828    temp-&gt;<a class="code" href="structaum__string__struct.html#dbd153490a1c3720a970a611afc4371c">charset</a> = charset;
<a name="l00829"></a>00829    temp-&gt;<a class="code" href="structaum__string__struct.html#b45cffe084dd3d20d928bee85e7b0f21">string</a> = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(string);
<a name="l00830"></a>00830    temp-&gt;<a class="code" href="structaum__string__struct.html#f7bd60b75b29d79b660a2859395c1a24">size</a> = <span class="keyword">sizeof</span>(temp-&gt;<a class="code" href="structaum__string__struct.html#b45cffe084dd3d20d928bee85e7b0f21">string</a>);
<a name="l00831"></a>00831    <a class="code" href="res__astum_8c.html#a2325d652c26029e243507fe8aa308be">aum_memory_used</a> += (<span class="keywordtype">long</span>) temp-&gt;<a class="code" href="structaum__string__struct.html#f7bd60b75b29d79b660a2859395c1a24">size</a>;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833    <span class="keywordflow">return</span> temp;   
<a name="l00834"></a>00834 }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836 <span class="keywordtype">void</span> <a class="code" href="astum_8h.html#0a6bc70cf29eff252165312c9e7faba2">aum_string_destroy</a>(aum_string *string)
<a name="l00837"></a>00837 {
<a name="l00838"></a>00838    <a class="code" href="res__astum_8c.html#9dd2e3e6486090c6e1930a49b376319e">aum_free</a>(string-&gt;<a class="code" href="structaum__string__struct.html#b45cffe084dd3d20d928bee85e7b0f21">string</a>);
<a name="l00839"></a>00839    <a class="code" href="res__astum_8c.html#9dd2e3e6486090c6e1930a49b376319e">aum_free</a>(string);
<a name="l00840"></a>00840 }
<a name="l00841"></a>00841 
<a name="l00842"></a>00842 aum_string *<a class="code" href="astum_8h.html#868e9f516c0be98b7d98408acab86b01">aum_string_add_charset_variant</a>(aum_string *string, <span class="keyword">enum</span> <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc6">aum_string_charset</a> charset)
<a name="l00843"></a>00843 {
<a name="l00844"></a>00844    aum_string *temp = string;
<a name="l00845"></a>00845    aum_string *<span class="keyword">new</span> = (aum_string *) NULL;
<a name="l00846"></a>00846    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>[BUFSIZ];
<a name="l00847"></a>00847    size_t newsize = 0, insize, outsize;
<a name="l00848"></a>00848    <span class="keyword">enum</span> <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc6">aum_string_charset</a> fromcharset;
<a name="l00849"></a>00849    <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#9453e0669d18369bbc9281cfb2fed1f5">inbuf</a>;
<a name="l00850"></a>00850 
<a name="l00851"></a>00851    <span class="keywordflow">while</span> (temp &amp;&amp; temp-&gt;<a class="code" href="structaum__string__struct.html#dbd153490a1c3720a970a611afc4371c">charset</a> != charset)
<a name="l00852"></a>00852       temp = (aum_string *) temp-&gt;<a class="code" href="structaum__string__struct.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l00853"></a>00853 
<a name="l00854"></a>00854    if (temp)   <span class="comment">/* We got a string already */</span>
<a name="l00855"></a>00855       <span class="keywordflow">return</span> temp;
<a name="l00856"></a>00856    
<a name="l00857"></a>00857    fromcharset = string-&gt;<a class="code" href="structaum__string__struct.html#dbd153490a1c3720a970a611afc4371c">charset</a>;
<a name="l00858"></a>00858    insize = <span class="keyword">sizeof</span>(string-&gt;<a class="code" href="structaum__string__struct.html#b45cffe084dd3d20d928bee85e7b0f21">string</a>);
<a name="l00859"></a>00859    outsize = <span class="keyword">sizeof</span>(<a class="code" href="adsistub_8c.html#cb7e52b21171fb9a53b498202607f0bd">buf</a>);
<a name="l00860"></a>00860    <a class="code" href="app__voicemail_8c.html#9453e0669d18369bbc9281cfb2fed1f5">inbuf</a> = string-&gt;<a class="code" href="structaum__string__struct.html#b45cffe084dd3d20d928bee85e7b0f21">string</a>;
<a name="l00861"></a>00861    <span class="keywordflow">if</span> (fromcharset == <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc61b41b6ae2482f24fbf42c24b17ac82e5">AUM_CHAR_UTF8</a>) {
<a name="l00862"></a>00862       <span class="keywordflow">switch</span> (charset) {
<a name="l00863"></a>00863          <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc68cd69b102fbe2ea2a2afd5c408ded164">AUM_CHAR_ISO8859_1</a>:
<a name="l00864"></a>00864             newsize = iconv(ichandler_utf8_to_iso88591, &amp;<a class="code" href="app__voicemail_8c.html#9453e0669d18369bbc9281cfb2fed1f5">inbuf</a>, &amp;insize, &amp;buf, &amp;outsize);
<a name="l00865"></a>00865             <span class="keywordflow">break</span>;
<a name="l00866"></a>00866          <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc62a3b181a5271b44161fadf567dffd3fb">AUM_CHAR_ASCII</a>:
<a name="l00867"></a>00867             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Don't know how to convert from utf to ascii yet...\n"</span>);
<a name="l00868"></a>00868             <span class="keywordflow">break</span>;
<a name="l00869"></a>00869          <span class="keywordflow">default</span>:
<a name="l00870"></a>00870             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Don't know how to convert from utf to unknown charset yet...\n"</span>);
<a name="l00871"></a>00871             <span class="keywordflow">break</span>;
<a name="l00872"></a>00872       }
<a name="l00873"></a>00873    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fromcharset == <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc68cd69b102fbe2ea2a2afd5c408ded164">AUM_CHAR_ISO8859_1</a>) {
<a name="l00874"></a>00874       <span class="keywordflow">switch</span> (charset) {
<a name="l00875"></a>00875          <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc61b41b6ae2482f24fbf42c24b17ac82e5">AUM_CHAR_UTF8</a>:
<a name="l00876"></a>00876             newsize = iconv(ichandler_iso88591_to_utf8, &amp;<a class="code" href="app__voicemail_8c.html#9453e0669d18369bbc9281cfb2fed1f5">inbuf</a>, &amp;insize, &amp;buf, &amp;outsize);
<a name="l00877"></a>00877             <span class="keywordflow">break</span>;
<a name="l00878"></a>00878          <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#db69232fe1aebb7185d26848a244acc62a3b181a5271b44161fadf567dffd3fb">AUM_CHAR_ASCII</a>:
<a name="l00879"></a>00879             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Don't know how to convert from ISO8859-1 to ascii yet...\n"</span>);
<a name="l00880"></a>00880             <span class="keywordflow">break</span>;
<a name="l00881"></a>00881          <span class="keywordflow">default</span>:
<a name="l00882"></a>00882             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Don't know how to convert from utf to unknown charset yet...\n"</span>);
<a name="l00883"></a>00883             <span class="keywordflow">break</span>;
<a name="l00884"></a>00884       }
<a name="l00885"></a>00885    }
<a name="l00886"></a>00886    <span class="keywordflow">if</span> (newsize == (size_t) -1)   <span class="comment">/* Could not convert */</span>
<a name="l00887"></a>00887       <span class="comment">/* If errno == EILSEQ   Illegal multibyte sequence */</span>
<a name="l00888"></a>00888       <span class="comment">/* If errno == EINVAL   Invalid multibyte sequence */</span>
<a name="l00889"></a>00889       <span class="comment">/* If errno == E2BIG Output buffer too small */</span>
<a name="l00890"></a>00890       <span class="keywordflow">return</span> temp;      <span class="comment">/* ??? */</span>
<a name="l00891"></a>00891 
<a name="l00892"></a>00892    <span class="keyword">new</span> = <a class="code" href="astum_8h.html#1b2d57e8039de5eee85e4112c87799c6">aum_string_alloc</a>(buf, charset);  <span class="comment">/* Allocate object */</span>
<a name="l00893"></a>00893 
<a name="l00894"></a>00894    <span class="comment">/* Link it in */</span>
<a name="l00895"></a>00895    temp = string-&gt;<a class="code" href="structaum__string__struct.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l00896"></a>00896    string-&gt;<a class="code" href="structaum__string__struct.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> = <span class="keyword">new</span>;
<a name="l00897"></a>00897    <span class="keyword">new</span>-&gt;<a class="code" href="structaum__string__struct.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> = temp;
<a name="l00898"></a>00898 
<a name="l00899"></a>00899    <span class="keywordflow">return</span> <span class="keyword">new</span>;
<a name="l00900"></a>00900    
<a name="l00901"></a>00901 }
<a name="l00902"></a>00902 <span class="preprocessor">#endif</span>
<a name="l00903"></a>00903 <span class="preprocessor"></span>
<a name="l00904"></a>00904 <span class="comment">/*------------------------- CONFIGURATION ------------------------------*/</span>
<a name="l00905"></a><a class="code" href="res__astum_8c.html#c91c7cf0bb62bffdfecb070e55e63d64">00905</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaum__config__struct.html">aum_config_struct</a> aum_config[] = {
<a name="l00906"></a>00906    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1a8576257bedbe62f4790713809733d65">AUM_CNF_ADDR_EMAIL</a>,   <span class="stringliteral">"email"</span>  ,<a class="code" href="astum_8h.html#8e3821198833f49fc234e3aa9d1c101bcf1e18f3f14fdbfe7ab61d68ea8bd654">AUM_CONFOBJ_USER</a> },
<a name="l00907"></a>00907    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d16c8142f5020dfa3610b1417a09edc5c7">AUM_CNF_ADDR_XMPP</a>, <span class="stringliteral">"xmpp"</span>      ,AUM_CONFOBJ_USER },
<a name="l00908"></a>00908    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d16c8142f5020dfa3610b1417a09edc5c7">AUM_CNF_ADDR_XMPP</a>, <span class="stringliteral">"jabber"</span>    ,AUM_CONFOBJ_USER },
<a name="l00909"></a>00909    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1c0423d2c59faaacb7c7e11954b8828dd">AUM_CNF_ADDR_SIP</a>,  <span class="stringliteral">"sip"</span>       ,AUM_CONFOBJ_USER },
<a name="l00910"></a>00910    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d14ba1d4c30a97f548dadc75a2d5f7cf09">AUM_CNF_ADDR_IAX2</a>, <span class="stringliteral">"iax"</span>       ,AUM_CONFOBJ_USER },
<a name="l00911"></a>00911    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d11cae255e4089eb9a2ba932bfab5e66cb">AUM_CNF_ADDR_AOL</a>,  <span class="stringliteral">"aol"</span>       ,AUM_CONFOBJ_USER },
<a name="l00912"></a>00912    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1fc869e867dea46c80885ac31de7306d6">AUM_CNF_ADDR_MSN</a>,  <span class="stringliteral">"msn"</span>       ,AUM_CONFOBJ_USER },
<a name="l00913"></a>00913    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d14c4bd85fcc69fe6747d665df272bf3f1">AUM_CNF_ADDR_TEL</a>,  <span class="stringliteral">"tel"</span>       ,AUM_CONFOBJ_USER },
<a name="l00914"></a>00914    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1182819936b470a1a3701e98029266c04">AUM_CNF_ADDR_CELL_TEL</a>,<span class="stringliteral">"cell"</span>      ,AUM_CONFOBJ_USER },
<a name="l00915"></a>00915    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1fc23f73d7662836b4a0ddbc828064575">AUM_CNF_ADDR_FAX</a>,  <span class="stringliteral">"fax"</span>       ,AUM_CONFOBJ_USER },
<a name="l00916"></a>00916    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d124d01b652521d320e3d7e8bc087a032f">AUM_CNF_ADDR_CUST0</a>,   <span class="stringliteral">"cust0"</span>  ,AUM_CONFOBJ_USER },
<a name="l00917"></a>00917    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d17c94703cc3398d0ae710826f3dcdccd7">AUM_CNF_ADDR_CUST1</a>,   <span class="stringliteral">"cust1"</span>  ,AUM_CONFOBJ_USER },
<a name="l00918"></a>00918    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d11a9bafdae7e1086d9494dfeb47ca8835">AUM_CNF_ADDR_CUST2</a>,   <span class="stringliteral">"cust2"</span>  ,AUM_CONFOBJ_USER },
<a name="l00919"></a>00919    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1e1002859d276a2232941d8cfb7a7410b">AUM_CNF_ADDR_CUST3</a>,   <span class="stringliteral">"cust3"</span>  ,AUM_CONFOBJ_USER },
<a name="l00920"></a>00920    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d18594351074100a9d003bbb1fe085b9af">AUM_CNF_ADDR_CUST4</a>,   <span class="stringliteral">"cust4"</span>  ,AUM_CONFOBJ_USER },
<a name="l00921"></a>00921    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1cc57634669ab3f671192d3d536a7f20e">AUM_CNF_PIN</a>,    <span class="stringliteral">"pin"</span>       ,AUM_CONFOBJ_USER },
<a name="l00922"></a>00922    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1d26e1d33859c0d512ab736475b7b4ae7">AUM_CNF_VMAILBOX</a>,  <span class="stringliteral">"mailbox"</span>   ,AUM_CONFOBJ_USER },
<a name="l00923"></a>00923    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1561e3abfdefcaef79d4d60892905ae9b">AUM_CNF_GROUP</a>,  <span class="stringliteral">"group"</span>  ,AUM_CONFOBJ_USER },
<a name="l00924"></a>00924    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d12b018e5e7c717972bb174422a3f9c20a">AUM_CNF_CALLBACKEXT</a>,  <span class="stringliteral">"extension"</span>    ,AUM_CONFOBJ_USER }, <span class="comment">/*!&lt; Default extension */</span>
<a name="l00925"></a>00925    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1a5319d95070aeb082a195e94821f6a32">AUM_CNF_DEFCONTEXT</a>,   <span class="stringliteral">"context"</span>   ,AUM_CONFOBJ_USER &amp; <a class="code" href="astum_8h.html#8e3821198833f49fc234e3aa9d1c101bbb20b1fb9afd97cc175c859147a1e0f5">AUM_CONFOBJ_GROUP</a> },
<a name="l00926"></a>00926    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d19e6b41f33953f81097f898b442ee78a7">AUM_CNF_SUBSCRIBECONTEXT</a>,   <span class="stringliteral">"subscribecontext"</span>   ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00927"></a>00927    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1ffd6d9310028b78b6a7879d81f878b22">AUM_CNF_DISACONTEXT</a>,  <span class="stringliteral">"disacontext"</span>  ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00928"></a>00928    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d192502231549b215ed96ccd1750f10b10">AUM_CNF_PARKING</a>,   <span class="stringliteral">"parking"</span>   ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00929"></a>00929    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1e437b6d74bfb76811c782e71617416df">AUM_CNF_CID</a>,    <span class="stringliteral">"callerid"</span>  ,AUM_CONFOBJ_USER },
<a name="l00930"></a>00930    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d15443aa5252d209282d0aa6539e8da5f1">AUM_CNF_CALLERPRES</a>,   <span class="stringliteral">"callerpres"</span>   ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00931"></a>00931    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1fa286f085242a44c1f34ec99b5a03dd8">AUM_CNF_ACCOUNTCODE</a>,  <span class="stringliteral">"accountcode"</span>  ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00932"></a>00932    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1f84e9000cce9ae5030c76163734ce77f">AUM_CNF_MANAGER_RACCESS</a>,<span class="stringliteral">"managerread"</span> ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00933"></a>00933    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1bbd31009f30c0770c64b7da8a88ddeeb">AUM_CNF_MANAGER_WACCESS</a>,<span class="stringliteral">"managerwrite"</span>,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00934"></a>00934    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1e7a492b3fc5ff87178fcda895cd8a7b5">AUM_CNF_SECRET</a>, <span class="stringliteral">"secret"</span>    ,AUM_CONFOBJ_USER },
<a name="l00935"></a>00935    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d157321e30c86db3994429d23b4fdad73d">AUM_CNF_IAX2KEY</a>,   <span class="stringliteral">"iax2key"</span>   ,AUM_CONFOBJ_USER },
<a name="l00936"></a>00936    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1dd7681943f5be2e183b9e86e40b23903">AUM_CNF_MUSICCLASS</a>,   <span class="stringliteral">"musicclass"</span>   ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00937"></a>00937    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1256fa31814b414eee06fe70770459fa3">AUM_CNF_LDAPDN</a>, <span class="stringliteral">"ldapdn"</span>    ,AUM_CONFOBJ_USER },
<a name="l00938"></a>00938    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1d4a2ab65cb03eb2c8bb692242100fe16">AUM_CNF_FIRSTNAME</a>, <span class="stringliteral">"firstname"</span>    ,AUM_CONFOBJ_USER },
<a name="l00939"></a>00939    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d16145d5fae67a4409dbae5fc841fa4b79">AUM_CNF_LASTNAME</a>,  <span class="stringliteral">"lastname"</span>  ,AUM_CONFOBJ_USER },
<a name="l00940"></a>00940    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1b152e5aedd0d021f7eb0c8b641f69e81">AUM_CNF_TITLE</a>,  <span class="stringliteral">"title"</span>  ,AUM_CONFOBJ_USER },
<a name="l00941"></a>00941    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1d695d9e56bc72c53b0edfa3d7362c2c4">AUM_CNF_LANGUAGE</a>,  <span class="stringliteral">"language"</span>  ,AUM_CONFOBJ_USER },
<a name="l00942"></a>00942    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1ab1f98ead6ac86c77e90954480014ed1">AUM_CNF_SOUNDNAME</a>, <span class="stringliteral">"audioname"</span>    ,AUM_CONFOBJ_USER },
<a name="l00943"></a>00943    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d150d98c782a081966433cc59a730fc1f1">AUM_CNF_CHANVAR</a>,   <span class="stringliteral">"chanvar"</span>   ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00944"></a>00944    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1ac7c069632f3cfe61b8f0d8f4a4fed1d">AUM_CNF_PERMIT</a>, <span class="stringliteral">"permit"</span>    ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00945"></a>00945    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d193ddc34ed01fe92ff40e14e73bc0a2d8">AUM_CNF_DENY</a>,      <span class="stringliteral">"deny"</span>      ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00946"></a>00946    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1da482c6fb97506bf10d1a357848cc1c2">AUM_CNF_NUMID</a>,  <span class="stringliteral">"numericid"</span>    ,AUM_CONFOBJ_USER },
<a name="l00947"></a>00947    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d15c76e4c2e4c3dbb70883bbcf3190e3ad">AUM_CNF_SIPDOMAIN</a>, <span class="stringliteral">"sipdomain"</span>    ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00948"></a>00948    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d17d64f9a915afa40bae0d479e0bf267b3">AUM_CNF_CALLGROUP</a>, <span class="stringliteral">"callgroup"</span>    ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00949"></a>00949    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1e174148077a55ba0a856eb250a9e8fbc">AUM_CNF_PICKUPGROUP</a>,  <span class="stringliteral">"pickupgroup"</span>  ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00950"></a>00950    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d10a87a7e16ee2c439c16db0a4d2ece843">AUM_CNF_GROUPVAR</a>,  <span class="stringliteral">"changroup"</span>    ,AUM_CONFOBJ_USER &amp; AUM_CONFOBJ_GROUP },
<a name="l00951"></a>00951    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1f5c01833a89887e5638175a4f4e46e0d">AUM_CNF_GROUPDESC</a>, <span class="stringliteral">"description"</span>  ,AUM_CONFOBJ_GROUP },
<a name="l00952"></a>00952    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1607d396d8b0eba2eacffa612a18113d9">AUM_CNF_TYPE</a>,      <span class="stringliteral">"type"</span>      ,<a class="code" href="astum_8h.html#8e3821198833f49fc234e3aa9d1c101bff38ea64de63fe4712712ea2f5447b4f">AUM_CONFOBJ_GENERAL</a> },
<a name="l00953"></a>00953    { <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d127ae02c9aa3ccdc46710f636bfb68bae">AUM_CNF_DEBUG</a>,  <span class="stringliteral">"debug"</span>  ,AUM_CONFOBJ_GENERAL },
<a name="l00954"></a>00954 };
<a name="l00955"></a>00955 
<a name="l00956"></a>00956 <span class="comment"></span>
<a name="l00957"></a>00957 <span class="comment">/*! \brief Add AUM user to a group */</span>
<a name="l00958"></a><a class="code" href="res__astum_8c.html#9a23ffd576c140b41d38b60fc46237b7">00958</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__astum_8c.html#9a23ffd576c140b41d38b60fc46237b7">add_user_to_group</a>(<span class="keyword">struct</span> <a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a>, <span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>)
<a name="l00959"></a>00959 {
<a name="l00960"></a>00960    <span class="keyword">struct </span><a class="code" href="structaum__group__member.html">aum_group_member</a> *<a class="code" href="structmember.html">member</a>;
<a name="l00961"></a>00961 
<a name="l00962"></a>00962    <span class="keywordflow">if</span> (!group || !user)
<a name="l00963"></a>00963       <span class="keywordflow">return</span> -1;  <span class="comment">/* Error */</span>
<a name="l00964"></a>00964 
<a name="l00965"></a>00965    member = <a class="code" href="res__astum_8c.html#e7c38e3f31f3b834ced400a0ef0d5393">aum_allocate</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__group__member.html">aum_group_member</a>)); 
<a name="l00966"></a>00966    <span class="keywordflow">if</span> (!member)
<a name="l00967"></a>00967       <span class="keywordflow">return</span> -1;  <span class="comment">/* Memory allocation */</span>
<a name="l00968"></a>00968    
<a name="l00969"></a>00969    <span class="comment">/* Link list from user to groups */</span>
<a name="l00970"></a>00970    member-&gt;<a class="code" href="structaum__group__member.html#db0f6f37ebeb6ea09489124345af2a45">group</a> = group;
<a name="l00971"></a>00971    <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#1471e4e05a4db95d353cc867fe317314">groups</a>, member, list);
<a name="l00972"></a>00972 
<a name="l00973"></a>00973    member = <a class="code" href="res__astum_8c.html#e7c38e3f31f3b834ced400a0ef0d5393">aum_allocate</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> aum_group_member)); 
<a name="l00974"></a>00974    <span class="keywordflow">if</span> (!member)
<a name="l00975"></a>00975       <span class="keywordflow">return</span> -2;  <span class="comment">/* Group membership failed */</span>
<a name="l00976"></a>00976 
<a name="l00977"></a>00977    <span class="comment">/* Link list from groups to users */</span>
<a name="l00978"></a>00978    member-&gt;<a class="code" href="structaum__group__member.html#ee11cbb19052e40b07aac0ca060c23ee">user</a> = user;
<a name="l00979"></a>00979    <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;group-&gt;<a class="code" href="structaum__group.html#d2e3083420929d8bfae81f58fa4594cb">members</a>, member, list);
<a name="l00980"></a>00980    <span class="keywordflow">return</span> 0;      <span class="comment">/* Success */</span>
<a name="l00981"></a>00981 }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983 <span class="comment"></span>
<a name="l00984"></a>00984 <span class="comment">/*! \brief Parse configuration file label, check if it's valid in this </span>
<a name="l00985"></a>00985 <span class="comment">     object context and return label */</span>
<a name="l00986"></a><a class="code" href="res__astum_8c.html#f19ceacaa5634e43392db073d1607a78">00986</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1">aum_config_options</a> <a class="code" href="res__astum_8c.html#f19ceacaa5634e43392db073d1607a78">aum_config_parse</a>(<span class="keywordtype">char</span> *label, <span class="keyword">enum</span> <a class="code" href="astum_8h.html#8e3821198833f49fc234e3aa9d1c101b">aum_config_objects</a> object)
<a name="l00987"></a>00987 {
<a name="l00988"></a>00988    <span class="keywordtype">int</span> x;
<a name="l00989"></a>00989 
<a name="l00990"></a>00990    <span class="keywordflow">for</span> (x = 0; x &lt; (<span class="keyword">sizeof</span>(aum_config) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__config__struct.html">aum_config_struct</a>)); x++) {
<a name="l00991"></a>00991       <span class="keywordflow">if</span> (!strcmp(aum_config[x].label, label)) {
<a name="l00992"></a>00992          <span class="keywordflow">if</span> (aum_config[x].valid &amp; object)
<a name="l00993"></a>00993             <span class="keywordflow">return</span> aum_config[x].option;
<a name="l00994"></a>00994          <span class="keywordflow">else</span>
<a name="l00995"></a>00995             <span class="keywordflow">return</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1020cff95905ec429aa2da79cd75f3365">AUM_CNF_NOT_VALID_FOR_OBJECT</a>;
<a name="l00996"></a>00996       }
<a name="l00997"></a>00997    };
<a name="l00998"></a>00998    <span class="keywordflow">return</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d173fa26fecd85afb58dae334118e88ed1">AUM_CNF_NOT_FOUND</a>;
<a name="l00999"></a>00999 }
<a name="l01000"></a>01000 <span class="comment"></span>
<a name="l01001"></a>01001 <span class="comment">/*! \brief Allocate and calculate total memory used */</span>
<a name="l01002"></a><a class="code" href="res__astum_8c.html#e7c38e3f31f3b834ced400a0ef0d5393">01002</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="res__astum_8c.html#e7c38e3f31f3b834ced400a0ef0d5393">aum_allocate</a>(size_t size)
<a name="l01003"></a>01003 {
<a name="l01004"></a>01004    <span class="keywordtype">void</span> *obj = <a class="code" href="astmm_8h.html#b9d011ff8b105f2850962f2003da06d9">calloc</a>(1, size);
<a name="l01005"></a>01005    <span class="keywordflow">if</span> (obj) {
<a name="l01006"></a>01006       <a class="code" href="res__astum_8c.html#a2325d652c26029e243507fe8aa308be">aum_memory_used</a> += (long) size;
<a name="l01007"></a>01007    } <span class="keywordflow">else</span>
<a name="l01008"></a>01008       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Out of memory in AUM allocation. Memory used: %ld\n"</span>, <a class="code" href="res__astum_8c.html#a2325d652c26029e243507fe8aa308be">aum_memory_used</a>);
<a name="l01009"></a>01009 
<a name="l01010"></a>01010    <span class="keywordflow">return</span> obj;
<a name="l01011"></a>01011 }
<a name="l01012"></a>01012 <span class="comment"></span>
<a name="l01013"></a>01013 <span class="comment">/*! \brief Free allocated memory */</span>
<a name="l01014"></a><a class="code" href="res__astum_8c.html#9dd2e3e6486090c6e1930a49b376319e">01014</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__astum_8c.html#9dd2e3e6486090c6e1930a49b376319e">aum_free</a>(<span class="keywordtype">void</span> *obj)
<a name="l01015"></a>01015 {
<a name="l01016"></a>01016    size_t sajz = <span class="keyword">sizeof</span>(*obj);
<a name="l01017"></a>01017    <a class="code" href="res__astum_8c.html#a2325d652c26029e243507fe8aa308be">aum_memory_used</a> -= (long) sajz;
<a name="l01018"></a>01018    <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(obj);
<a name="l01019"></a>01019 }
<a name="l01020"></a>01020 <span class="comment"></span>
<a name="l01021"></a>01021 <span class="comment">/*! \brief Get address type from configuration option */</span>
<a name="l01022"></a><a class="code" href="res__astum_8c.html#3dedc214e98008ac28f5093ac3593c30">01022</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf">aum_address_type</a> <a class="code" href="res__astum_8c.html#3dedc214e98008ac28f5093ac3593c30">get_addr_type_from_config_option</a>(<span class="keyword">enum</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1">aum_config_options</a> option)
<a name="l01023"></a>01023 {
<a name="l01024"></a>01024    <span class="keywordtype">int</span> x;
<a name="l01025"></a>01025 
<a name="l01026"></a>01026    <span class="keywordflow">for</span> (x = 0; x &lt; (<span class="keyword">sizeof</span>(<a class="code" href="res__astum_8c.html#df9d0b5d32e2f0d8680b7c1ce8cf1473">aum_address_config</a>) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__address__config__struct.html">aum_address_config_struct</a>)); x++) {
<a name="l01027"></a>01027       <span class="keywordflow">if</span> (aum_address_config[x].configoption == option)
<a name="l01028"></a>01028          <span class="keywordflow">return</span> aum_address_config[x].type;
<a name="l01029"></a>01029    }
<a name="l01030"></a>01030    <span class="keywordflow">return</span> <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf72fc093e3fa1bccf5fc289fd4ea656e0">AUM_ADDR_NONE</a>;
<a name="l01031"></a>01031 }
<a name="l01032"></a>01032 <span class="comment"></span>
<a name="l01033"></a>01033 <span class="comment">/*! \brief Get context description from context type */</span>
<a name="l01034"></a><a class="code" href="res__astum_8c.html#3a0575e7b508cd30b91c36186e0ee2d2">01034</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="res__astum_8c.html#3a0575e7b508cd30b91c36186e0ee2d2">context_type2str</a>(<span class="keyword">enum</span> <a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc19">aum_context_type</a> <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>)
<a name="l01035"></a>01035 {
<a name="l01036"></a>01036    <span class="keywordtype">int</span> x;
<a name="l01037"></a>01037    <span class="keywordflow">for</span> (x = 0; x &lt; (<span class="keyword">sizeof</span>(aum_context_text) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__context__table.html">aum_context_table</a>)); x++) {
<a name="l01038"></a>01038       <span class="keywordflow">if</span> (aum_context_text[x].type == type)
<a name="l01039"></a>01039          <span class="keywordflow">return</span> aum_context_text[x].desc;
<a name="l01040"></a>01040    }
<a name="l01041"></a>01041    
<a name="l01042"></a>01042    <span class="keywordflow">return</span> (<span class="keyword">const</span> <span class="keywordtype">char</span> *) <span class="stringliteral">""</span>;
<a name="l01043"></a>01043 }
<a name="l01044"></a>01044 <span class="comment"></span>
<a name="l01045"></a>01045 <span class="comment">/*! \brief Build address object from config file */</span>
<a name="l01046"></a><a class="code" href="res__astum_8c.html#f969e8f88ae239dfe886c362092fa6d0">01046</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaum__address.html">aum_address</a> *<a class="code" href="res__astum_8c.html#f969e8f88ae239dfe886c362092fa6d0">build_address</a>(<span class="keyword">enum</span> <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf">aum_address_type</a> <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, <span class="keyword">enum</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1">aum_config_options</a> option, <span class="keywordtype">char</span> *<a class="code" href="structaum__address.html#716bf5b8761420f27a8804154f75d738">address</a>)
<a name="l01047"></a>01047 {
<a name="l01048"></a>01048    <span class="keyword">struct </span><a class="code" href="structaum__address.html">aum_address</a> *add_obj = (<span class="keyword">struct </span><a class="code" href="structaum__address.html">aum_address</a> *) NULL;
<a name="l01049"></a>01049 
<a name="l01050"></a>01050    <span class="keywordflow">if</span> (type==<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf72fc093e3fa1bccf5fc289fd4ea656e0">AUM_ADDR_NONE</a> &amp;&amp; option == <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d131c1c71fa784f95f5d4adfb986e5fdad">AUM_CNF_NONE</a>)
<a name="l01051"></a>01051       <span class="keywordflow">return</span> add_obj;
<a name="l01052"></a>01052 
<a name="l01053"></a>01053    <span class="keywordflow">if</span> (type == <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf72fc093e3fa1bccf5fc289fd4ea656e0">AUM_ADDR_NONE</a>)
<a name="l01054"></a>01054       type = <a class="code" href="res__astum_8c.html#3dedc214e98008ac28f5093ac3593c30">get_addr_type_from_config_option</a>(option);
<a name="l01055"></a>01055 
<a name="l01056"></a>01056    
<a name="l01057"></a>01057    <span class="comment">/* Allocate object and reset memory */</span>
<a name="l01058"></a>01058    add_obj = <a class="code" href="res__astum_8c.html#e7c38e3f31f3b834ced400a0ef0d5393">aum_allocate</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__address.html">aum_address</a>));
<a name="l01059"></a>01059    <span class="keywordflow">if</span> (!add_obj)
<a name="l01060"></a>01060       <span class="keywordflow">return</span> add_obj;
<a name="l01061"></a>01061    ast_copy_string(add_obj-&gt;<a class="code" href="structaum__address.html#716bf5b8761420f27a8804154f75d738">address</a>, address, <span class="keyword">sizeof</span>(add_obj-&gt;<a class="code" href="structaum__address.html#716bf5b8761420f27a8804154f75d738">address</a>));
<a name="l01062"></a>01062    add_obj-&gt;<a class="code" href="structaum__address.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a> = type;
<a name="l01063"></a>01063    add_obj-&gt;<a class="code" href="structaum__address.html#c76a5e84e4bdee527e274ea30c680d79">active</a> = 1; 
<a name="l01064"></a>01064 
<a name="l01065"></a>01065    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 1)
<a name="l01066"></a>01066       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"=== Added address %s \n"</span>, address);
<a name="l01067"></a>01067 
<a name="l01068"></a>01068    <span class="keywordflow">return</span> add_obj;
<a name="l01069"></a>01069 }
<a name="l01070"></a>01070 <span class="comment"></span>
<a name="l01071"></a>01071 <span class="comment">/*! \brief Buld context object */</span>
<a name="l01072"></a><a class="code" href="res__astum_8c.html#8dd0fd28d50bcaaa951b55435529a5cb">01072</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaum__context.html">aum_context</a> *<a class="code" href="chan__iax2_8c.html#aca9aae0060ae9f8ab184c478b2a9428">build_context</a>(<span class="keyword">enum</span> <a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc19">aum_context_type</a> <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, <span class="keyword">enum</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1">aum_config_options</a> option, <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>)
<a name="l01073"></a>01073 {
<a name="l01074"></a>01074    <span class="keyword">struct </span><a class="code" href="structaum__context.html">aum_context</a> *newcontext = (<span class="keyword">struct </span><a class="code" href="structaum__context.html">aum_context</a> *) NULL;
<a name="l01075"></a>01075 
<a name="l01076"></a>01076    <span class="keywordflow">if</span> (type==<a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc192c0f1e472b875d296416258589aef812">AUM_CONTEXT_NONE</a> &amp;&amp; option == <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d131c1c71fa784f95f5d4adfb986e5fdad">AUM_CNF_NONE</a>)
<a name="l01077"></a>01077       <span class="keywordflow">return</span> newcontext;
<a name="l01078"></a>01078 
<a name="l01079"></a>01079    <span class="keywordflow">if</span> (type == <a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc192c0f1e472b875d296416258589aef812">AUM_CONTEXT_NONE</a>) {
<a name="l01080"></a>01080       <span class="keywordflow">switch</span> (option) {
<a name="l01081"></a>01081       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d192502231549b215ed96ccd1750f10b10">AUM_CNF_PARKING</a>:
<a name="l01082"></a>01082          type = <a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc19755d9420171c096eb8be986129638974">AUM_CONTEXT_PARKING</a>;
<a name="l01083"></a>01083          <span class="keywordflow">break</span>;
<a name="l01084"></a>01084       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1ffd6d9310028b78b6a7879d81f878b22">AUM_CNF_DISACONTEXT</a>:
<a name="l01085"></a>01085          type = <a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc19b589b574e51a177b14895e93710c152d">AUM_CONTEXT_DISA</a>;
<a name="l01086"></a>01086          <span class="keywordflow">break</span>;
<a name="l01087"></a>01087       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d19e6b41f33953f81097f898b442ee78a7">AUM_CNF_SUBSCRIBECONTEXT</a>:
<a name="l01088"></a>01088          type = <a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc1988cfbd41e25867356b75d53a969b8467">AUM_CONTEXT_SIPSUBSCRIBE</a>;
<a name="l01089"></a>01089          <span class="keywordflow">break</span>;
<a name="l01090"></a>01090       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1a5319d95070aeb082a195e94821f6a32">AUM_CNF_DEFCONTEXT</a>:
<a name="l01091"></a>01091          type = <a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc193f4c9154e1d42efa3b293026ed5bb02c">AUM_CONTEXT_DEF_INCOMING</a>;
<a name="l01092"></a>01092          <span class="keywordflow">break</span>;
<a name="l01093"></a>01093       <span class="keywordflow">default</span>:
<a name="l01094"></a>01094          type = <a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc192c0f1e472b875d296416258589aef812">AUM_CONTEXT_NONE</a>;
<a name="l01095"></a>01095          <span class="keywordflow">break</span>;
<a name="l01096"></a>01096       }
<a name="l01097"></a>01097    }
<a name="l01098"></a>01098 
<a name="l01099"></a>01099    newcontext = <a class="code" href="res__astum_8c.html#e7c38e3f31f3b834ced400a0ef0d5393">aum_allocate</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__context.html">aum_context</a>));
<a name="l01100"></a>01100    <span class="keywordflow">if</span> (!newcontext)
<a name="l01101"></a>01101       <span class="keywordflow">return</span> newcontext;
<a name="l01102"></a>01102    ast_copy_string(newcontext-&gt;<a class="code" href="structaum__context.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>, context, <span class="keyword">sizeof</span>(newcontext-&gt;<a class="code" href="structaum__context.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>));
<a name="l01103"></a>01103    newcontext-&gt;<a class="code" href="structaum__context.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a> = type;
<a name="l01104"></a>01104 
<a name="l01105"></a>01105    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a> &gt; 1)
<a name="l01106"></a>01106       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"=== Added context %s \n"</span>, context);
<a name="l01107"></a>01107 
<a name="l01108"></a>01108    <span class="keywordflow">return</span> newcontext;
<a name="l01109"></a>01109 }
<a name="l01110"></a>01110 
<a name="l01111"></a>01111 <span class="comment"></span>
<a name="l01112"></a>01112 <span class="comment">/*! \brief Release all cached realtime users */</span>
<a name="l01113"></a><a class="code" href="res__astum_8c.html#d2fd6c7adcf7dded62eb52f4fa8ee0e0">01113</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__astum_8c.html#d2fd6c7adcf7dded62eb52f4fa8ee0e0">aum_rtcache_freeall</a>(<span class="keywordtype">void</span>) {
<a name="l01114"></a>01114    <span class="keyword">struct </span><a class="code" href="structaum__usercache__struct.html">aum_usercache_struct</a> *temp;
<a name="l01115"></a>01115 
<a name="l01116"></a>01116    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;aum_usercache);
<a name="l01117"></a>01117 
<a name="l01118"></a>01118    <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;aum_usercache) ) {
<a name="l01119"></a>01119       <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;aum_usercache);
<a name="l01120"></a>01120       <span class="keywordflow">while</span> ((temp = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;aum_usercache, list))) {
<a name="l01121"></a>01121          <a class="code" href="res__astum_8c.html#e3b7823b997a9732153a16e6c120b767">aum_destroy_user</a>(temp-&gt;<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>);
<a name="l01122"></a>01122          <a class="code" href="res__astum_8c.html#9dd2e3e6486090c6e1930a49b376319e">aum_free</a>(temp);
<a name="l01123"></a>01123       }
<a name="l01124"></a>01124       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;aum_usercache);
<a name="l01125"></a>01125    }
<a name="l01126"></a>01126    <a class="code" href="res__astum_8c.html#ebf83cc80ef4e43a6fe1dd0149ae8d07">aum_real_users</a> = 0;
<a name="l01127"></a>01127 }
<a name="l01128"></a>01128 <span class="comment"></span>
<a name="l01129"></a>01129 <span class="comment">/*! \brief Add realtime user to top of the cache  (actually, the end of the list)</span>
<a name="l01130"></a>01130 <span class="comment">   If the cache is full, the user at the top of the cache is</span>
<a name="l01131"></a>01131 <span class="comment">   simply removed from memory</span>
<a name="l01132"></a>01132 <span class="comment">   \param user AUM user to add to the bottom</span>
<a name="l01133"></a>01133 <span class="comment">*/</span>
<a name="l01134"></a><a class="code" href="res__astum_8c.html#8f6bbdef83c8d0d807a2fae1a33d4677">01134</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__astum_8c.html#8f6bbdef83c8d0d807a2fae1a33d4677">aum_rtcache_add</a>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>) {
<a name="l01135"></a>01135    <span class="keyword">struct </span><a class="code" href="structaum__usercache__struct.html">aum_usercache_struct</a> *temp;
<a name="l01136"></a>01136    <span class="keyword">struct </span><a class="code" href="structaum__usercache__struct.html">aum_usercache_struct</a> *aums;
<a name="l01137"></a>01137 
<a name="l01138"></a>01138    aums = <a class="code" href="res__astum_8c.html#e7c38e3f31f3b834ced400a0ef0d5393">aum_allocate</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__usercache__struct.html">aum_usercache_struct</a>));
<a name="l01139"></a>01139    <span class="keywordflow">if</span> (!aums)
<a name="l01140"></a>01140       <span class="keywordflow">return</span>;     <span class="comment">/* Allocation error */</span>
<a name="l01141"></a>01141    
<a name="l01142"></a>01142    aums-&gt;<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a> = user;
<a name="l01143"></a>01143    
<a name="l01144"></a>01144    <span class="comment">/* Check whether we need to clean up before adding to list */</span>
<a name="l01145"></a>01145    <span class="keywordflow">if</span> (<a class="code" href="res__astum_8c.html#595a5c0d7ae5700453d5f991ca2dbdae">aum_usercache_count</a> == <a class="code" href="res__astum_8c.html#3b28ee7e07abf7ced3662bf4f6697dcd">aum_usercache_max</a>) {
<a name="l01146"></a>01146       <span class="comment">/* Remove user from cache and delete */</span>
<a name="l01147"></a>01147       <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;aum_usercache);
<a name="l01148"></a>01148       temp = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;aum_usercache, list);
<a name="l01149"></a>01149       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;aum_usercache);
<a name="l01150"></a>01150       <a class="code" href="res__astum_8c.html#e3b7823b997a9732153a16e6c120b767">aum_destroy_user</a>(temp-&gt;<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>);
<a name="l01151"></a>01151       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(temp);
<a name="l01152"></a>01152       <a class="code" href="res__astum_8c.html#595a5c0d7ae5700453d5f991ca2dbdae">aum_usercache_count</a>--;
<a name="l01153"></a>01153       <a class="code" href="res__astum_8c.html#ebf83cc80ef4e43a6fe1dd0149ae8d07">aum_real_users</a>-- ;
<a name="l01154"></a>01154    }
<a name="l01155"></a>01155 
<a name="l01156"></a>01156    <span class="comment">/* Move it into the list */</span>
<a name="l01157"></a>01157    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;aum_usercache);
<a name="l01158"></a>01158    <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;aum_usercache, aums, list);
<a name="l01159"></a>01159    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;aum_usercache);
<a name="l01160"></a>01160    <a class="code" href="res__astum_8c.html#595a5c0d7ae5700453d5f991ca2dbdae">aum_usercache_count</a>++;
<a name="l01161"></a>01161 
<a name="l01162"></a>01162    <span class="keywordflow">return</span>;
<a name="l01163"></a>01163 }
<a name="l01164"></a>01164 <span class="comment"></span>
<a name="l01165"></a>01165 <span class="comment">/*! \brief Move realtime cache object to bottom of cache (we remove from top)</span>
<a name="l01166"></a>01166 <span class="comment">   Called when a user object is accessed</span>
<a name="l01167"></a>01167 <span class="comment">*/</span>
<a name="l01168"></a><a class="code" href="res__astum_8c.html#aa329ccfb2f77758d8f346ab09b6954f">01168</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__astum_8c.html#aa329ccfb2f77758d8f346ab09b6954f">aum_rtcache_movetotop</a>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>) {
<a name="l01169"></a>01169    <span class="keyword">struct </span><a class="code" href="structaum__usercache__struct.html">aum_usercache_struct</a> *temp;
<a name="l01170"></a>01170    <span class="keyword">struct </span><a class="code" href="structaum__usercache__struct.html">aum_usercache_struct</a> *top_of_the_class = (<span class="keyword">struct </span><a class="code" href="structaum__usercache__struct.html">aum_usercache_struct</a> *) NULL;
<a name="l01171"></a>01171 
<a name="l01172"></a>01172    <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;aum_usercache);
<a name="l01173"></a>01173    <span class="comment">/* Find user in cache */</span>
<a name="l01174"></a>01174    <a class="code" href="linkedlists_8h.html#915e438a9528c8d6316c617b5bd84487">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;aum_usercache, temp, list) {
<a name="l01175"></a>01175       <span class="keywordflow">if</span> (temp-&gt;<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a> == user) {
<a name="l01176"></a>01176          top_of_the_class = temp;
<a name="l01177"></a>01177          <span class="comment">/* Remove from current position in list */</span>
<a name="l01178"></a>01178          <a class="code" href="linkedlists_8h.html#37f99379dafa45c921f95bf7235eb91d">AST_LIST_REMOVE_CURRENT</a>(&amp;aum_usercache, list);
<a name="l01179"></a>01179       }
<a name="l01180"></a>01180    };
<a name="l01181"></a>01181    <a class="code" href="linkedlists_8h.html#a93fdadc00a2a090968004b7d9c79630">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l01182"></a>01182    <span class="comment">/* Add her to top */</span>
<a name="l01183"></a>01183    <span class="keywordflow">if</span> (top_of_the_class) 
<a name="l01184"></a>01184       <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;aum_usercache, top_of_the_class, list);
<a name="l01185"></a>01185 
<a name="l01186"></a>01186    <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;aum_usercache);
<a name="l01187"></a>01187 
<a name="l01188"></a>01188    <span class="comment">/* Return */</span>
<a name="l01189"></a>01189 }
<a name="l01190"></a>01190 <span class="comment"></span>
<a name="l01191"></a>01191 <span class="comment">/*!   \brief   Add channel variable to list </span>
<a name="l01192"></a>01192 <span class="comment"> *    \param var  AST_variable, list pointer</span>
<a name="l01193"></a>01193 <span class="comment"> *    \param name Name of variable</span>
<a name="l01194"></a>01194 <span class="comment"> *    \param value   Value -  if value is NULL name is supposed to contain both name and value with = sign between them</span>
<a name="l01195"></a>01195 <span class="comment"> *    \return  Head of variable list</span>
<a name="l01196"></a>01196 <span class="comment"> */</span>
<a name="l01197"></a><a class="code" href="res__astum_8c.html#61596d57b32ea26bd6c3b7b1e36b2d26">01197</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *<a class="code" href="res__astum_8c.html#61596d57b32ea26bd6c3b7b1e36b2d26">add_variable_to_list</a>(<span class="keyword">struct</span> <a class="code" href="structast__variable.html">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a>, <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#b068931cc450442b63f5b3d276ea4297">name</a>, <span class="keywordtype">char</span> *<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>)
<a name="l01198"></a>01198 {
<a name="l01199"></a>01199    <span class="keywordtype">char</span> *varname = name;
<a name="l01200"></a>01200    <span class="keywordtype">char</span> *varval = value;
<a name="l01201"></a>01201    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *tmpvar = (<span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *) NULL;
<a name="l01202"></a>01202 
<a name="l01203"></a>01203    <span class="keywordflow">if</span> (!value) {  <span class="comment">/* No value, both are to be found in name */</span>
<a name="l01204"></a>01204       varname = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(name);
<a name="l01205"></a>01205       <span class="keywordflow">if</span> (varname &amp;&amp; (varval = strchr(varname,<span class="charliteral">'='</span>))) {
<a name="l01206"></a>01206          *varval = <span class="charliteral">'\0'</span>;
<a name="l01207"></a>01207          varval++;
<a name="l01208"></a>01208       }
<a name="l01209"></a>01209    }
<a name="l01210"></a>01210 
<a name="l01211"></a>01211    <span class="keywordflow">if</span> (varname &amp;&amp; varval)
<a name="l01212"></a>01212    <span class="keywordflow">if</span> (!(tmpvar = <a class="code" href="config_8c.html#c21fb3a90ccd9ec4f8708c3b67b3c654">ast_variable_new</a>(varname, varval))) 
<a name="l01213"></a>01213       <span class="keywordflow">return</span> var;
<a name="l01214"></a>01214 
<a name="l01215"></a>01215    tmpvar-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a> = var;
<a name="l01216"></a>01216 
<a name="l01217"></a>01217    <span class="keywordflow">return</span> tmpvar;
<a name="l01218"></a>01218 }
<a name="l01219"></a>01219 <span class="comment"></span>
<a name="l01220"></a>01220 <span class="comment">/*! \brief Parse configuration file and build AUM in-memory user</span>
<a name="l01221"></a>01221 <span class="comment"></span>
<a name="l01222"></a>01222 <span class="comment">   All static users are stored in memory for fast access</span>
<a name="l01223"></a>01223 <span class="comment">   Some memory parts are loaded on demand and cached</span>
<a name="l01224"></a>01224 <span class="comment"></span>
<a name="l01225"></a>01225 <span class="comment">   \param   username Name of new user</span>
<a name="l01226"></a>01226 <span class="comment">   \param   x     Configuration entries</span>
<a name="l01227"></a>01227 <span class="comment">   \param realtime      True if realtime group (Not implemented yet)</span>
<a name="l01228"></a>01228 <span class="comment">*/</span>
<a name="l01229"></a><a class="code" href="res__astum_8c.html#ee1adf0cb0617ea05eaccd8f5ad8b129">01229</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="res__astum_8c.html#ee1adf0cb0617ea05eaccd8f5ad8b129">aum_build_user</a>(<span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#14c4b06b824ec593239362517f538b29">username</a>, <span class="keyword">struct</span> <a class="code" href="structast__variable.html">ast_variable</a> *x, <span class="keywordtype">int</span> realtime)
<a name="l01230"></a>01230 {
<a name="l01231"></a>01231    <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>;
<a name="l01232"></a>01232    <span class="keyword">struct </span><a class="code" href="structaum__address.html">aum_address</a> *<a class="code" href="structaum__address.html#716bf5b8761420f27a8804154f75d738">address</a>;
<a name="l01233"></a>01233    <span class="keyword">struct </span><a class="code" href="structaum__context.html">aum_context</a> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>;
<a name="l01234"></a>01234    <span class="keyword">enum</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1">aum_config_options</a> option;
<a name="l01235"></a>01235 
<a name="l01236"></a>01236    <span class="comment">/* Check if username exists already, do not check realtime again */</span>
<a name="l01237"></a>01237    <span class="keywordflow">if</span> (<a class="code" href="astum_8h.html#193a76f977f30b532eb9bccca7d0d8b9">find_aum_user</a>(username, <a class="code" href="plc_8c.html#946003f97ccc52d5d3b54ac0ec31bbfc">FALSE</a>)) {
<a name="l01238"></a>01238       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Ignoring duplicate user %s\n"</span>, username);
<a name="l01239"></a>01239       <span class="keywordflow">return</span> NULL;
<a name="l01240"></a>01240    }
<a name="l01241"></a>01241 
<a name="l01242"></a>01242    <span class="comment">/* Allocate user */</span>
<a name="l01243"></a>01243    user = <a class="code" href="res__astum_8c.html#e7c38e3f31f3b834ced400a0ef0d5393">aum_allocate</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a>));
<a name="l01244"></a>01244    <span class="keywordflow">if</span> (!user) {
<a name="l01245"></a>01245       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Can't allocate AUM user memory\n"</span>);
<a name="l01246"></a>01246       <span class="keywordflow">return</span> NULL;
<a name="l01247"></a>01247    }
<a name="l01248"></a>01248 
<a name="l01249"></a>01249    <a class="code" href="astobj_8h.html#d98ac8e31e47134b19f5305e090ad209">ASTOBJ_INIT</a>(user);
<a name="l01250"></a>01250    <a class="code" href="linkedlists_8h.html#6658ec426af4d1ba98830fd5ac45f93e">AST_LIST_HEAD_INIT</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#884d9804999fc47a3c2694e49ad2536a">address</a>);
<a name="l01251"></a>01251    <a class="code" href="linkedlists_8h.html#6658ec426af4d1ba98830fd5ac45f93e">AST_LIST_HEAD_INIT</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#1471e4e05a4db95d353cc867fe317314">groups</a>);
<a name="l01252"></a>01252    ast_copy_string(user-&gt;name, username, <span class="keyword">sizeof</span>(user-&gt;name));
<a name="l01253"></a>01253    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#673e841c68db57daad3d2b949a08e5cf">LOG_VERBOSE</a>, <span class="stringliteral">"-- Building user: %s\n"</span>, username);
<a name="l01254"></a>01254    <span class="keywordflow">while</span> (x) {
<a name="l01255"></a>01255       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"---- User attribute: %s = %s\n"</span>, x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01256"></a>01256       option = <a class="code" href="res__astum_8c.html#f19ceacaa5634e43392db073d1607a78">aum_config_parse</a>(x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <a class="code" href="astum_8h.html#8e3821198833f49fc234e3aa9d1c101bcf1e18f3f14fdbfe7ab61d68ea8bd654">AUM_CONFOBJ_USER</a>);
<a name="l01257"></a>01257       <span class="keywordflow">switch</span> (option) {
<a name="l01258"></a>01258       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1a8576257bedbe62f4790713809733d65">AUM_CNF_ADDR_EMAIL</a>:
<a name="l01259"></a>01259       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d16c8142f5020dfa3610b1417a09edc5c7">AUM_CNF_ADDR_XMPP</a>:
<a name="l01260"></a>01260       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1c0423d2c59faaacb7c7e11954b8828dd">AUM_CNF_ADDR_SIP</a>:
<a name="l01261"></a>01261       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d14ba1d4c30a97f548dadc75a2d5f7cf09">AUM_CNF_ADDR_IAX2</a>:
<a name="l01262"></a>01262       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d11cae255e4089eb9a2ba932bfab5e66cb">AUM_CNF_ADDR_AOL</a>:
<a name="l01263"></a>01263       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1fc869e867dea46c80885ac31de7306d6">AUM_CNF_ADDR_MSN</a>:
<a name="l01264"></a>01264       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d14c4bd85fcc69fe6747d665df272bf3f1">AUM_CNF_ADDR_TEL</a>:
<a name="l01265"></a>01265       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1182819936b470a1a3701e98029266c04">AUM_CNF_ADDR_CELL_TEL</a>:
<a name="l01266"></a>01266       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1fc23f73d7662836b4a0ddbc828064575">AUM_CNF_ADDR_FAX</a>:
<a name="l01267"></a>01267       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1e3563a4ec8cc44c4a4fb02dbac030240">AUM_CNF_ADDR_FWD</a>:
<a name="l01268"></a>01268       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1d123b99f24de1a3434b3edc522b0025e">AUM_CNF_ADDR_IAXTEL</a>:
<a name="l01269"></a>01269       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d168302ab71153787f570a87a0933d28cd">AUM_CNF_ADDR_WEB</a>:
<a name="l01270"></a>01270       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d124d01b652521d320e3d7e8bc087a032f">AUM_CNF_ADDR_CUST0</a>:
<a name="l01271"></a>01271       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d17c94703cc3398d0ae710826f3dcdccd7">AUM_CNF_ADDR_CUST1</a>:
<a name="l01272"></a>01272       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d11a9bafdae7e1086d9494dfeb47ca8835">AUM_CNF_ADDR_CUST2</a>:
<a name="l01273"></a>01273       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1e1002859d276a2232941d8cfb7a7410b">AUM_CNF_ADDR_CUST3</a>:
<a name="l01274"></a>01274       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d18594351074100a9d003bbb1fe085b9af">AUM_CNF_ADDR_CUST4</a>:
<a name="l01275"></a>01275          address = <a class="code" href="res__astum_8c.html#f969e8f88ae239dfe886c362092fa6d0">build_address</a>(<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf72fc093e3fa1bccf5fc289fd4ea656e0">AUM_ADDR_NONE</a>, option, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01276"></a>01276          <span class="comment">/* Link this address to user list */</span>
<a name="l01277"></a>01277          <span class="keywordflow">if</span> (address)
<a name="l01278"></a>01278             <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#884d9804999fc47a3c2694e49ad2536a">address</a>, address, list);
<a name="l01279"></a>01279          <span class="keywordflow">else</span>
<a name="l01280"></a>01280             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Address %s not added for user %s\n"</span>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, username);
<a name="l01281"></a>01281          <span class="keywordflow">break</span>;
<a name="l01282"></a>01282       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1d26e1d33859c0d512ab736475b7b4ae7">AUM_CNF_VMAILBOX</a>:
<a name="l01283"></a>01283          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>))
<a name="l01284"></a>01284             ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#be2fc5fd64209e633c78549d39c04fb2">mailbox</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#be2fc5fd64209e633c78549d39c04fb2">mailbox</a>));
<a name="l01285"></a>01285          <span class="keywordflow">break</span>;
<a name="l01286"></a>01286       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1561e3abfdefcaef79d4d60892905ae9b">AUM_CNF_GROUP</a>:
<a name="l01287"></a>01287          <span class="keywordflow">if</span> (<a class="code" href="res__astum_8c.html#9a23ffd576c140b41d38b60fc46237b7">add_user_to_group</a>(<a class="code" href="astum_8h.html#d910eebd103db9cd510cd15e10e3ee4b">find_aum_group_by_name</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>), user) &lt; 0)
<a name="l01288"></a>01288             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Could not add user %s to group %s\n"</span>, user-&gt;name, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01289"></a>01289          <span class="keywordflow">break</span>;
<a name="l01290"></a>01290       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d12b018e5e7c717972bb174422a3f9c20a">AUM_CNF_CALLBACKEXT</a>:  <span class="comment">/* ??????? Which field ?????? */</span>
<a name="l01291"></a>01291          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>))
<a name="l01292"></a>01292             ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#68bfdbac9957f91de4b615f51e0bb687">default_exten</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#68bfdbac9957f91de4b615f51e0bb687">default_exten</a>));
<a name="l01293"></a>01293          <span class="keywordflow">break</span>;
<a name="l01294"></a>01294       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1a5319d95070aeb082a195e94821f6a32">AUM_CNF_DEFCONTEXT</a>:
<a name="l01295"></a>01295       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d19e6b41f33953f81097f898b442ee78a7">AUM_CNF_SUBSCRIBECONTEXT</a>:
<a name="l01296"></a>01296       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1ffd6d9310028b78b6a7879d81f878b22">AUM_CNF_DISACONTEXT</a>:
<a name="l01297"></a>01297       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d192502231549b215ed96ccd1750f10b10">AUM_CNF_PARKING</a>:
<a name="l01298"></a>01298          context = <a class="code" href="chan__iax2_8c.html#aca9aae0060ae9f8ab184c478b2a9428">build_context</a>(<a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc192c0f1e472b875d296416258589aef812">AUM_CONTEXT_NONE</a>, option, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01299"></a>01299          <span class="keywordflow">if</span> (context)
<a name="l01300"></a>01300             <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#9be90dc64c1f5b5c993ff11d732a8da0">contexts</a>, context, list);
<a name="l01301"></a>01301          <span class="keywordflow">else</span>
<a name="l01302"></a>01302             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Context %s not added for user %s\n"</span>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, username);
<a name="l01303"></a>01303          <span class="keywordflow">break</span>;
<a name="l01304"></a>01304       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1d7d55a07ff932f9615d65d415728615c">AUM_CNF_DEFEXTEN</a>:
<a name="l01305"></a>01305          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#68bfdbac9957f91de4b615f51e0bb687">default_exten</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#68bfdbac9957f91de4b615f51e0bb687">default_exten</a>));
<a name="l01306"></a>01306          <span class="keywordflow">break</span>;
<a name="l01307"></a>01307       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1e437b6d74bfb76811c782e71617416df">AUM_CNF_CID</a>:
<a name="l01308"></a>01308          <a class="code" href="callerid_8c.html#48f42015459db6f4f29d079bda4a6034">ast_callerid_split</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, user-&gt;<a class="code" href="structaum__user.html#d32e37c15e50d082935eab51f32d28e1">cid_name</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#d32e37c15e50d082935eab51f32d28e1">cid_name</a>), user-&gt;<a class="code" href="structaum__user.html#ce037b538ac4ffb9fc87c43fb24feafc">cid_num</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#ce037b538ac4ffb9fc87c43fb24feafc">cid_num</a>));
<a name="l01309"></a>01309          <span class="keywordflow">break</span>;
<a name="l01310"></a>01310       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d15443aa5252d209282d0aa6539e8da5f1">AUM_CNF_CALLERPRES</a>:
<a name="l01311"></a>01311          user-&gt;<a class="code" href="structaum__user.html#a9db1833989678217b5007e1eaac0e59">calling_pres</a> = <a class="code" href="callerid_8c.html#760c5dbb16d6c44dca8aaba3e5611165">ast_parse_caller_presentation</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01312"></a>01312          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structaum__user.html#a9db1833989678217b5007e1eaac0e59">calling_pres</a> == -1)
<a name="l01313"></a>01313             user-&gt;<a class="code" href="structaum__user.html#a9db1833989678217b5007e1eaac0e59">calling_pres</a> = atoi(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01314"></a>01314             
<a name="l01315"></a>01315          <span class="keywordflow">break</span>;
<a name="l01316"></a>01316       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1761548966327dedd5968055efde12ec7">AUM_CNF_TIMEZONE</a>:
<a name="l01317"></a>01317          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#13159d7907ff4ef35fd3a1fd7e219118">timezone</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#13159d7907ff4ef35fd3a1fd7e219118">timezone</a>));
<a name="l01318"></a>01318          <span class="keywordflow">break</span>;
<a name="l01319"></a>01319       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d17d64f9a915afa40bae0d479e0bf267b3">AUM_CNF_CALLGROUP</a>:
<a name="l01320"></a>01320          user-&gt;<a class="code" href="structaum__user.html#d435ec54d713513ab1d94049cbc33629">callgroup</a> = <a class="code" href="channel_8c.html#3afd78a60ecfe19f643ed5124981a023">ast_get_group</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01321"></a>01321          <span class="keywordflow">break</span>;
<a name="l01322"></a>01322       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1e174148077a55ba0a856eb250a9e8fbc">AUM_CNF_PICKUPGROUP</a>:
<a name="l01323"></a>01323          user-&gt;<a class="code" href="structaum__user.html#6a5ae60e87b5caa521ea5c2b36de96cc">pickupgroup</a> = <a class="code" href="channel_8c.html#3afd78a60ecfe19f643ed5124981a023">ast_get_group</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01324"></a>01324          <span class="keywordflow">break</span>;
<a name="l01325"></a>01325       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1fa286f085242a44c1f34ec99b5a03dd8">AUM_CNF_ACCOUNTCODE</a>:
<a name="l01326"></a>01326          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#6c4d520c88ca77ed2acc04ae1add9f8e">accountcode</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#6c4d520c88ca77ed2acc04ae1add9f8e">accountcode</a>));
<a name="l01327"></a>01327          <span class="keywordflow">break</span>;
<a name="l01328"></a>01328       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1bbd31009f30c0770c64b7da8a88ddeeb">AUM_CNF_MANAGER_WACCESS</a>:
<a name="l01329"></a>01329          user-&gt;<a class="code" href="structaum__user.html#b94a3a67b5d68e65a0e1065aac55b042">manager_write_perm</a> = <a class="code" href="group__Group__AMI.html#g6bfcdc2d3a50cfc5be0ca0b6dbc622ea">get_perm</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01330"></a>01330          <span class="keywordflow">break</span>;
<a name="l01331"></a>01331       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1f84e9000cce9ae5030c76163734ce77f">AUM_CNF_MANAGER_RACCESS</a>:
<a name="l01332"></a>01332          user-&gt;<a class="code" href="structaum__user.html#65a8bc84e148e7cca02d8d8e26fd4653">manager_read_perm</a> = <a class="code" href="group__Group__AMI.html#g6bfcdc2d3a50cfc5be0ca0b6dbc622ea">get_perm</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01333"></a>01333          <span class="keywordflow">break</span>;
<a name="l01334"></a>01334       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1e7a492b3fc5ff87178fcda895cd8a7b5">AUM_CNF_SECRET</a>:
<a name="l01335"></a>01335          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#4bb178d856d85e3399472bc0525dc657">secret</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#4bb178d856d85e3399472bc0525dc657">secret</a>));
<a name="l01336"></a>01336          <span class="keywordflow">break</span>;
<a name="l01337"></a>01337       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1cc57634669ab3f671192d3d536a7f20e">AUM_CNF_PIN</a>:
<a name="l01338"></a>01338          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#034bb11d597ab840a6622019ece5038f">pincode</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#034bb11d597ab840a6622019ece5038f">pincode</a>));
<a name="l01339"></a>01339          <span class="keywordflow">break</span>;
<a name="l01340"></a>01340       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d157321e30c86db3994429d23b4fdad73d">AUM_CNF_IAX2KEY</a>:
<a name="l01341"></a>01341          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#034bb11d597ab840a6622019ece5038f">pincode</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#034bb11d597ab840a6622019ece5038f">pincode</a>));
<a name="l01342"></a>01342          <span class="keywordflow">break</span>;
<a name="l01343"></a>01343       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1dd7681943f5be2e183b9e86e40b23903">AUM_CNF_MUSICCLASS</a>:
<a name="l01344"></a>01344          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#80439b02fbec6ba43c0438ad4d67348d">musicclass</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#80439b02fbec6ba43c0438ad4d67348d">musicclass</a>));
<a name="l01345"></a>01345          <span class="keywordflow">break</span>;
<a name="l01346"></a>01346       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1256fa31814b414eee06fe70770459fa3">AUM_CNF_LDAPDN</a>:
<a name="l01347"></a>01347          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#3851af5f4bc758cb39c646b9b4efd21d">ldapdn</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#3851af5f4bc758cb39c646b9b4efd21d">ldapdn</a>));
<a name="l01348"></a>01348          <span class="keywordflow">break</span>;
<a name="l01349"></a>01349       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1d4a2ab65cb03eb2c8bb692242100fe16">AUM_CNF_FIRSTNAME</a>:
<a name="l01350"></a>01350          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#ff4bb5940ba9aa31e82ac23bce34bd6a">first_name</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#ff4bb5940ba9aa31e82ac23bce34bd6a">first_name</a>));
<a name="l01351"></a>01351          <span class="keywordflow">break</span>;
<a name="l01352"></a>01352       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d16145d5fae67a4409dbae5fc841fa4b79">AUM_CNF_LASTNAME</a>:
<a name="l01353"></a>01353          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#0ff0a46e078589126485715107ee6175">last_name</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#0ff0a46e078589126485715107ee6175">last_name</a>));
<a name="l01354"></a>01354          <span class="keywordflow">break</span>;
<a name="l01355"></a>01355       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1b152e5aedd0d021f7eb0c8b641f69e81">AUM_CNF_TITLE</a>:
<a name="l01356"></a>01356          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#e7cb80e19629cb66649ce1bbeaaf4ffc">title</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#e7cb80e19629cb66649ce1bbeaaf4ffc">title</a>));
<a name="l01357"></a>01357          <span class="keywordflow">break</span>;
<a name="l01358"></a>01358       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1ab1f98ead6ac86c77e90954480014ed1">AUM_CNF_SOUNDNAME</a>:
<a name="l01359"></a>01359          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#42d0a7793b3fcfb0c900d92b48f2ae67">soundname</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#42d0a7793b3fcfb0c900d92b48f2ae67">soundname</a>));
<a name="l01360"></a>01360          <span class="keywordflow">break</span>;
<a name="l01361"></a>01361       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d150d98c782a081966433cc59a730fc1f1">AUM_CNF_CHANVAR</a>:
<a name="l01362"></a>01362          <span class="comment">/* Set peer channel variable */</span>
<a name="l01363"></a>01363          user-&gt;<a class="code" href="structaum__user.html#1a366a2de522c52f41f6de2219adf59b">chanvars</a> = <a class="code" href="res__astum_8c.html#61596d57b32ea26bd6c3b7b1e36b2d26">add_variable_to_list</a>(user-&gt;<a class="code" href="structaum__user.html#1a366a2de522c52f41f6de2219adf59b">chanvars</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, NULL);
<a name="l01364"></a>01364          <span class="keywordflow">break</span>;
<a name="l01365"></a>01365       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d10a87a7e16ee2c439c16db0a4d2ece843">AUM_CNF_GROUPVAR</a>:  <span class="comment">/* Channel group to set */</span>
<a name="l01366"></a>01366          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#0ae5f6206a09288389cbb98d5eb0f3c0">channelgroup</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#0ae5f6206a09288389cbb98d5eb0f3c0">channelgroup</a>));
<a name="l01367"></a>01367          <span class="keywordflow">break</span>;
<a name="l01368"></a>01368       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1ac7c069632f3cfe61b8f0d8f4a4fed1d">AUM_CNF_PERMIT</a>:
<a name="l01369"></a>01369       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d193ddc34ed01fe92ff40e14e73bc0a2d8">AUM_CNF_DENY</a>:
<a name="l01370"></a>01370          <span class="comment">/* ACL */</span>
<a name="l01371"></a>01371          user-&gt;<a class="code" href="structaum__user.html#a33915ba226b6dbd1edb3e09fac41ed9">acl</a> = <a class="code" href="acl_8c.html#bd7ec664091783cbeef4274f5c30d7b4">ast_append_ha</a>(x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, user-&gt;<a class="code" href="structaum__user.html#a33915ba226b6dbd1edb3e09fac41ed9">acl</a>);
<a name="l01372"></a>01372          <span class="keywordflow">break</span>;
<a name="l01373"></a>01373       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1da482c6fb97506bf10d1a357848cc1c2">AUM_CNF_NUMID</a>:
<a name="l01374"></a>01374          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#c6b7c05f6f9e8d0ec2ca5596ca504936">numuserid</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#c6b7c05f6f9e8d0ec2ca5596ca504936">numuserid</a>));
<a name="l01375"></a>01375          <span class="keywordflow">break</span>;
<a name="l01376"></a>01376       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d127ae02c9aa3ccdc46710f636bfb68bae">AUM_CNF_DEBUG</a>:  <span class="comment">/* GENERAL setting only */</span>
<a name="l01377"></a>01377          <span class="keywordflow">break</span>;
<a name="l01378"></a>01378       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1f5c01833a89887e5638175a4f4e46e0d">AUM_CNF_GROUPDESC</a>: <span class="comment">/* Only for groups */</span>
<a name="l01379"></a>01379          <span class="keywordflow">break</span>;
<a name="l01380"></a>01380       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1607d396d8b0eba2eacffa612a18113d9">AUM_CNF_TYPE</a>:   <span class="comment">/* NO op */</span>
<a name="l01381"></a>01381          <span class="keywordflow">break</span>;
<a name="l01382"></a>01382       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1d695d9e56bc72c53b0edfa3d7362c2c4">AUM_CNF_LANGUAGE</a>:
<a name="l01383"></a>01383          ast_copy_string(user-&gt;<a class="code" href="structaum__user.html#8e5b6b627f81f1981fc6d241d6b3dd21">language</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structaum__user.html#8e5b6b627f81f1981fc6d241d6b3dd21">language</a>));
<a name="l01384"></a>01384          <span class="keywordflow">break</span>;
<a name="l01385"></a>01385       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d15c76e4c2e4c3dbb70883bbcf3190e3ad">AUM_CNF_SIPDOMAIN</a>:
<a name="l01386"></a>01386          <span class="comment">/* Not used ye */</span>
<a name="l01387"></a>01387          <span class="keywordflow">break</span>;
<a name="l01388"></a>01388       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d173fa26fecd85afb58dae334118e88ed1">AUM_CNF_NOT_FOUND</a>:
<a name="l01389"></a>01389          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Configuration label unknown in AUM configuration: %s\n"</span>, x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l01390"></a>01390          <span class="keywordflow">break</span>;
<a name="l01391"></a>01391       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1020cff95905ec429aa2da79cd75f3365">AUM_CNF_NOT_VALID_FOR_OBJECT</a>:
<a name="l01392"></a>01392          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Configuration label not valid for user objects in AUM configuration: %s\n"</span>, x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l01393"></a>01393          <span class="keywordflow">break</span>;
<a name="l01394"></a>01394       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d131c1c71fa784f95f5d4adfb986e5fdad">AUM_CNF_NONE</a>:   <span class="comment">/* Should not be here */</span>
<a name="l01395"></a>01395          <span class="keywordflow">break</span>;
<a name="l01396"></a>01396 
<a name="l01397"></a>01397       }
<a name="l01398"></a>01398       
<a name="l01399"></a>01399       x = x-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01400"></a>01400    }
<a name="l01401"></a>01401    <span class="keywordflow">if</span> (realtime) 
<a name="l01402"></a>01402       <a class="code" href="res__astum_8c.html#8f6bbdef83c8d0d807a2fae1a33d4677">aum_rtcache_add</a>(user);
<a name="l01403"></a>01403 
<a name="l01404"></a>01404    <span class="keywordflow">if</span> (realtime)
<a name="l01405"></a>01405       <a class="code" href="res__astum_8c.html#ebf83cc80ef4e43a6fe1dd0149ae8d07">aum_real_users</a>++;
<a name="l01406"></a>01406    <span class="keywordflow">else</span>
<a name="l01407"></a>01407       <a class="code" href="res__astum_8c.html#decda0d0cbdba0e8a722f972201501af">aum_static_users</a>++;
<a name="l01408"></a>01408 
<a name="l01409"></a>01409    <span class="comment">//ASTOBJ_UNMARK(user);</span>
<a name="l01410"></a>01410    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#673e841c68db57daad3d2b949a08e5cf">LOG_VERBOSE</a>, <span class="stringliteral">"-- == Finished building user: %s\n"</span>, username);
<a name="l01411"></a>01411    <span class="keywordflow">return</span> user;
<a name="l01412"></a>01412 }
<a name="l01413"></a>01413 
<a name="l01414"></a>01414 <span class="comment"></span>
<a name="l01415"></a>01415 <span class="comment">/*! \brief Parse configuration file and build AUM in-memory group </span>
<a name="l01416"></a>01416 <span class="comment"></span>
<a name="l01417"></a>01417 <span class="comment">   All groups are stored in memory for fast access</span>
<a name="l01418"></a>01418 <span class="comment"></span>
<a name="l01419"></a>01419 <span class="comment">   Some memory parts are loaded on demand and cached</span>
<a name="l01420"></a>01420 <span class="comment">   \param   groupname   Name of new group</span>
<a name="l01421"></a>01421 <span class="comment">   \param   x     Configuration entries</span>
<a name="l01422"></a>01422 <span class="comment">   \param realtime      True if realtime group (Not implemented yet)</span>
<a name="l01423"></a>01423 <span class="comment">*/</span>
<a name="l01424"></a><a class="code" href="res__astum_8c.html#55307d0ee9eb7b6419585594347227d9">01424</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="res__astum_8c.html#55307d0ee9eb7b6419585594347227d9">aum_build_group</a>(<span class="keywordtype">char</span> *groupname, <span class="keyword">struct</span> <a class="code" href="structast__variable.html">ast_variable</a> *x, <span class="keywordtype">int</span> realtime)
<a name="l01425"></a>01425 {
<a name="l01426"></a>01426    <span class="keyword">struct </span><a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a>;
<a name="l01427"></a>01427    <span class="keyword">struct </span><a class="code" href="structaum__context.html">aum_context</a> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>;
<a name="l01428"></a>01428    <span class="keyword">enum</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1">aum_config_options</a> option;
<a name="l01429"></a>01429 
<a name="l01430"></a>01430    group = <a class="code" href="res__astum_8c.html#e7c38e3f31f3b834ced400a0ef0d5393">aum_allocate</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structaum__group.html">aum_group</a>));
<a name="l01431"></a>01431    <span class="keywordflow">if</span> (!group) {
<a name="l01432"></a>01432       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#d0cb3df3102ca9270c5785af9a8c137f">LOG_WARNING</a>, <span class="stringliteral">"Can't allocate AUM group memory\n"</span>);
<a name="l01433"></a>01433       <span class="keywordflow">return</span> 0;
<a name="l01434"></a>01434    }
<a name="l01435"></a>01435    <span class="keywordflow">if</span> (realtime)
<a name="l01436"></a>01436       <a class="code" href="res__astum_8c.html#2e4b6b5e42594b7f28a94a3b7d6c0433">aum_real_groups</a>++;
<a name="l01437"></a>01437    <span class="keywordflow">else</span>
<a name="l01438"></a>01438       <a class="code" href="res__astum_8c.html#aaf6c6bfd8f8801838688e0cd4943115">aum_static_groups</a>++;
<a name="l01439"></a>01439 
<a name="l01440"></a>01440    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"==== Initiating ASTOBJ for new group %s\n"</span>, groupname);
<a name="l01441"></a>01441    <a class="code" href="astobj_8h.html#d98ac8e31e47134b19f5305e090ad209">ASTOBJ_INIT</a>(group);
<a name="l01442"></a>01442    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"==== Initiating AST_LIST for members of new group %s\n"</span>, groupname);
<a name="l01443"></a>01443    <a class="code" href="linkedlists_8h.html#0ae37ea56ca862f6504390fd49b9839f">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;group-&gt;<a class="code" href="structaum__group.html#d2e3083420929d8bfae81f58fa4594cb">members</a>);
<a name="l01444"></a>01444    ast_copy_string(group-&gt;name, groupname, <span class="keyword">sizeof</span>(group-&gt;name));
<a name="l01445"></a>01445    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"-- Building group: %s\n"</span>, groupname);
<a name="l01446"></a>01446    <span class="keywordflow">while</span> (x) {
<a name="l01447"></a>01447       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"---- Group attribute: %s = %s\n"</span>, x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01448"></a>01448       option = <a class="code" href="res__astum_8c.html#f19ceacaa5634e43392db073d1607a78">aum_config_parse</a>(x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <a class="code" href="astum_8h.html#8e3821198833f49fc234e3aa9d1c101bbb20b1fb9afd97cc175c859147a1e0f5">AUM_CONFOBJ_GROUP</a>);
<a name="l01449"></a>01449       <span class="keywordflow">switch</span> (option) {
<a name="l01450"></a>01450       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1f5c01833a89887e5638175a4f4e46e0d">AUM_CNF_GROUPDESC</a>:
<a name="l01451"></a>01451          group-&gt;<a class="code" href="structaum__group.html#67daf92c833c41c95db874e18fcb2786">description</a> = <a class="code" href="astmm_8h.html#17881997a89ddffd239268f0476567d0">strdup</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01452"></a>01452          <span class="keywordflow">break</span>;
<a name="l01453"></a>01453       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1a5319d95070aeb082a195e94821f6a32">AUM_CNF_DEFCONTEXT</a>:
<a name="l01454"></a>01454       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d19e6b41f33953f81097f898b442ee78a7">AUM_CNF_SUBSCRIBECONTEXT</a>:
<a name="l01455"></a>01455       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1ffd6d9310028b78b6a7879d81f878b22">AUM_CNF_DISACONTEXT</a>:
<a name="l01456"></a>01456       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d192502231549b215ed96ccd1750f10b10">AUM_CNF_PARKING</a>:
<a name="l01457"></a>01457          context = <a class="code" href="chan__iax2_8c.html#aca9aae0060ae9f8ab184c478b2a9428">build_context</a>(<a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc192c0f1e472b875d296416258589aef812">AUM_CONTEXT_NONE</a>, option, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01458"></a>01458          <span class="keywordflow">if</span> (context)
<a name="l01459"></a>01459             <a class="code" href="linkedlists_8h.html#8de6ce8a3b9d59e7e7fddee6b62b32a7">AST_LIST_INSERT_TAIL</a>(&amp;group-&gt;<a class="code" href="structaum__group.html#9be90dc64c1f5b5c993ff11d732a8da0">contexts</a>, context, list);
<a name="l01460"></a>01460          <span class="keywordflow">else</span>
<a name="l01461"></a>01461             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#4490aa3d29644e716440fada68f54032">LOG_ERROR</a>, <span class="stringliteral">"Context %s not added for group %s\n"</span>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, groupname);
<a name="l01462"></a>01462          <span class="keywordflow">break</span>;
<a name="l01463"></a>01463       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1bbd31009f30c0770c64b7da8a88ddeeb">AUM_CNF_MANAGER_WACCESS</a>:
<a name="l01464"></a>01464          group-&gt;<a class="code" href="structaum__group.html#b94a3a67b5d68e65a0e1065aac55b042">manager_write_perm</a> = <a class="code" href="group__Group__AMI.html#g6bfcdc2d3a50cfc5be0ca0b6dbc622ea">get_perm</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01465"></a>01465          <span class="keywordflow">break</span>;
<a name="l01466"></a>01466       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1f84e9000cce9ae5030c76163734ce77f">AUM_CNF_MANAGER_RACCESS</a>:
<a name="l01467"></a>01467          group-&gt;<a class="code" href="structaum__group.html#65a8bc84e148e7cca02d8d8e26fd4653">manager_read_perm</a> = <a class="code" href="group__Group__AMI.html#g6bfcdc2d3a50cfc5be0ca0b6dbc622ea">get_perm</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01468"></a>01468          <span class="keywordflow">break</span>;
<a name="l01469"></a>01469       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1dd7681943f5be2e183b9e86e40b23903">AUM_CNF_MUSICCLASS</a>:
<a name="l01470"></a>01470          ast_copy_string(group-&gt;<a class="code" href="structaum__group.html#80439b02fbec6ba43c0438ad4d67348d">musicclass</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(group-&gt;<a class="code" href="structaum__group.html#80439b02fbec6ba43c0438ad4d67348d">musicclass</a>));
<a name="l01471"></a>01471          <span class="keywordflow">break</span>;
<a name="l01472"></a>01472       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1d695d9e56bc72c53b0edfa3d7362c2c4">AUM_CNF_LANGUAGE</a>:
<a name="l01473"></a>01473          ast_copy_string(group-&gt;<a class="code" href="structaum__group.html#8e5b6b627f81f1981fc6d241d6b3dd21">language</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, <span class="keyword">sizeof</span>(group-&gt;<a class="code" href="structaum__group.html#8e5b6b627f81f1981fc6d241d6b3dd21">language</a>));
<a name="l01474"></a>01474          <span class="keywordflow">break</span>;
<a name="l01475"></a>01475       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d173fa26fecd85afb58dae334118e88ed1">AUM_CNF_NOT_FOUND</a>:
<a name="l01476"></a>01476          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Configuration label unknown in AUM configuration: %s\n"</span>, x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l01477"></a>01477          <span class="keywordflow">break</span>;
<a name="l01478"></a>01478       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d17d64f9a915afa40bae0d479e0bf267b3">AUM_CNF_CALLGROUP</a>:
<a name="l01479"></a>01479          group-&gt;<a class="code" href="structaum__group.html#d435ec54d713513ab1d94049cbc33629">callgroup</a> = <a class="code" href="channel_8c.html#3afd78a60ecfe19f643ed5124981a023">ast_get_group</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01480"></a>01480          <span class="keywordflow">break</span>;
<a name="l01481"></a>01481       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1e174148077a55ba0a856eb250a9e8fbc">AUM_CNF_PICKUPGROUP</a>:
<a name="l01482"></a>01482          group-&gt;<a class="code" href="structaum__group.html#6a5ae60e87b5caa521ea5c2b36de96cc">pickupgroup</a> = <a class="code" href="channel_8c.html#3afd78a60ecfe19f643ed5124981a023">ast_get_group</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01483"></a>01483          <span class="keywordflow">break</span>;
<a name="l01484"></a>01484       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d150d98c782a081966433cc59a730fc1f1">AUM_CNF_CHANVAR</a>:
<a name="l01485"></a>01485          <span class="comment">/* Set peer channel variable */</span>
<a name="l01486"></a>01486          group-&gt;<a class="code" href="structaum__group.html#1a366a2de522c52f41f6de2219adf59b">chanvars</a> = <a class="code" href="res__astum_8c.html#61596d57b32ea26bd6c3b7b1e36b2d26">add_variable_to_list</a>(group-&gt;<a class="code" href="structaum__group.html#1a366a2de522c52f41f6de2219adf59b">chanvars</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, NULL);
<a name="l01487"></a>01487          <span class="keywordflow">break</span>;
<a name="l01488"></a>01488       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1ac7c069632f3cfe61b8f0d8f4a4fed1d">AUM_CNF_PERMIT</a>:
<a name="l01489"></a>01489       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d193ddc34ed01fe92ff40e14e73bc0a2d8">AUM_CNF_DENY</a>:
<a name="l01490"></a>01490          <span class="comment">/* ACL */</span>
<a name="l01491"></a>01491          group-&gt;<a class="code" href="structaum__group.html#a33915ba226b6dbd1edb3e09fac41ed9">acl</a> = <a class="code" href="acl_8c.html#bd7ec664091783cbeef4274f5c30d7b4">ast_append_ha</a>(x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>, group-&gt;<a class="code" href="structaum__group.html#a33915ba226b6dbd1edb3e09fac41ed9">acl</a>);
<a name="l01492"></a>01492          <span class="keywordflow">break</span>;
<a name="l01493"></a>01493       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1020cff95905ec429aa2da79cd75f3365">AUM_CNF_NOT_VALID_FOR_OBJECT</a>:
<a name="l01494"></a>01494          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Configuration label not valid for group objects in AUM configuration: %s\n"</span>, x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l01495"></a>01495          <span class="keywordflow">break</span>;
<a name="l01496"></a>01496       <span class="keywordflow">default</span>: <span class="comment">/* Oops, we're not prepared for this yet */</span>
<a name="l01497"></a>01497          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Configuration label not valid for group objects in AUM configuration: %s\n"</span>, x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l01498"></a>01498          <span class="keywordflow">break</span>;
<a name="l01499"></a>01499       }
<a name="l01500"></a>01500       x = x-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01501"></a>01501    }
<a name="l01502"></a>01502    <a class="code" href="astobj_8h.html#3fdaf2512a79e6988684a893e49dc005">ASTOBJ_CONTAINER_LINK</a>(&amp;<a class="code" href="res__astum_8c.html#df751995f211be58a457c2d71dc6dc19">aum_grouplist</a>, group);
<a name="l01503"></a>01503    <a class="code" href="astobj_8h.html#0a64e5d6351ea151fd82be7033731f29">ASTOBJ_UNMARK</a>(group);
<a name="l01504"></a>01504    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#673e841c68db57daad3d2b949a08e5cf">LOG_VERBOSE</a>, <span class="stringliteral">"-- == Finished building group: %s\n"</span>, groupname);
<a name="l01505"></a>01505    <span class="keywordflow">return</span> 0;
<a name="l01506"></a>01506 }
<a name="l01507"></a>01507 <span class="comment"></span>
<a name="l01508"></a>01508 <span class="comment">/*! \brief Get group from realtime storage </span>
<a name="l01509"></a>01509 <span class="comment">   Checks the \b aumgroups realtime family from extconfig.conf </span>
<a name="l01510"></a>01510 <span class="comment">   \param groupname group to load</span>
<a name="l01511"></a>01511 <span class="comment"> */</span>
<a name="l01512"></a><a class="code" href="res__astum_8c.html#95f64c129663ae6b02bb27a25ab5eeb8">01512</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="res__astum_8c.html#95f64c129663ae6b02bb27a25ab5eeb8">aum_group_realtime_load</a>(<span class="keywordtype">char</span> *groupname)
<a name="l01513"></a>01513 {
<a name="l01514"></a>01514    <span class="keyword">struct </span><a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a> = (<span class="keyword">struct </span><a class="code" href="structaum__group.html">aum_group</a> *) NULL;
<a name="l01515"></a>01515    <span class="keyword">struct</span> <a class="code" href="structast__variable.html">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a>;
<a name="l01516"></a>01516    
<a name="l01517"></a>01517    <a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a> = <a class="code" href="config_8c.html#7f0fcea9896b1ad5f093bdb7abbefe59">ast_load_realtime</a>(<span class="stringliteral">"aumgroups"</span>, <span class="stringliteral">"name"</span>, groupname, NULL);
<a name="l01518"></a>01518    <span class="keywordflow">if</span> (!<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a>)
<a name="l01519"></a>01519       <span class="keywordflow">return</span> (<span class="keyword">struct</span> <a class="code" href="structaum__group.html">aum_group</a> *) NULL;
<a name="l01520"></a>01520 
<a name="l01521"></a>01521    <span class="comment">/* Group found in realtime, now build it in memory */</span>
<a name="l01522"></a>01522    group = <a class="code" href="res__astum_8c.html#55307d0ee9eb7b6419585594347227d9">aum_build_group</a>(groupname, <a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a>, 1);
<a name="l01523"></a>01523    <span class="keywordflow">if</span> (group) {
<a name="l01524"></a>01524       <a class="code" href="astobj_8h.html#3fdaf2512a79e6988684a893e49dc005">ASTOBJ_CONTAINER_LINK</a>(&amp;<a class="code" href="res__astum_8c.html#df751995f211be58a457c2d71dc6dc19">aum_grouplist</a>, group);
<a name="l01525"></a>01525       <a class="code" href="res__astum_8c.html#2e4b6b5e42594b7f28a94a3b7d6c0433">aum_real_groups</a>++;
<a name="l01526"></a>01526       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(group, <a class="code" href="astum_8h.html#624bb43d379736bb70822bd6cbb2a6e749f50ca60fd4a6b1135b71fca5da3a6b">AUM_GROUP_FLAG_REALTIME</a>);
<a name="l01527"></a>01527    }
<a name="l01528"></a>01528    <a class="code" href="config_8c.html#d616f18584600c70e8744e217c03407c">ast_variables_destroy</a>(<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a>);
<a name="l01529"></a>01529    <span class="keywordflow">return</span> group;
<a name="l01530"></a>01530 }
<a name="l01531"></a>01531 
<a name="l01532"></a>01532 <span class="comment"></span>
<a name="l01533"></a>01533 <span class="comment">/*! \brief Get user object from realtime storage </span>
<a name="l01534"></a>01534 <span class="comment">   Checks the \b aumusers realtime family from extconfig.conf </span>
<a name="l01535"></a>01535 <span class="comment">   \param field name to match on</span>
<a name="l01536"></a>01536 <span class="comment">   \param value the value of the field</span>
<a name="l01537"></a>01537 <span class="comment">   </span>
<a name="l01538"></a>01538 <span class="comment">*/</span>
<a name="l01539"></a><a class="code" href="res__astum_8c.html#2c05d82c17601c72f3e01b1ae4210205">01539</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="res__astum_8c.html#2c05d82c17601c72f3e01b1ae4210205">aum_user_realtime_loadbyfield</a>(<span class="keywordtype">char</span> *field, <span class="keywordtype">char</span> *value)
<a name="l01540"></a>01540 {
<a name="l01541"></a>01541    <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a> = (<span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *) NULL;
<a name="l01542"></a>01542    <span class="keyword">struct</span> <a class="code" href="structast__variable.html">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#b2145aac704ce76dbe1ac7adac535b23">var</a>, *<a class="code" href="app__queue_8c.html#1cb251ec0d568de6a929b520c4aed8d1">text</a>;
<a name="l01543"></a>01543    <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#14c4b06b824ec593239362517f538b29">username</a> = value;
<a name="l01544"></a>01544    
<a name="l01545"></a>01545    var = <a class="code" href="config_8c.html#7f0fcea9896b1ad5f093bdb7abbefe59">ast_load_realtime</a>(<span class="stringliteral">"aumusers"</span>, field, value, NULL);
<a name="l01546"></a>01546    <span class="keywordflow">if</span> (!var)
<a name="l01547"></a>01547       <span class="keywordflow">return</span> (<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *) NULL;
<a name="l01548"></a>01548 
<a name="l01549"></a>01549    <span class="comment">/* User found in realtime, now build it in memory */</span>
<a name="l01550"></a>01550 
<a name="l01551"></a>01551    <span class="comment">/* Find username from realtime if it's not the argument */</span>
<a name="l01552"></a>01552    <span class="keywordflow">if</span> (strcasecmp(field, <span class="stringliteral">"name"</span>)) {
<a name="l01553"></a>01553       <a class="code" href="app__queue_8c.html#1cb251ec0d568de6a929b520c4aed8d1">text</a> = var;
<a name="l01554"></a>01554       <span class="keywordflow">while</span> (<a class="code" href="app__queue_8c.html#1cb251ec0d568de6a929b520c4aed8d1">text</a>) {
<a name="l01555"></a>01555          <span class="keywordflow">if</span> (!strcasecmp(<span class="stringliteral">"name"</span>, <a class="code" href="app__queue_8c.html#1cb251ec0d568de6a929b520c4aed8d1">text</a>-&gt;name)) {
<a name="l01556"></a>01556             <a class="code" href="cdr__odbc_8c.html#14c4b06b824ec593239362517f538b29">username</a> = <a class="code" href="app__queue_8c.html#1cb251ec0d568de6a929b520c4aed8d1">text</a>-&gt;value;
<a name="l01557"></a>01557             <span class="keywordflow">break</span>;
<a name="l01558"></a>01558          }
<a name="l01559"></a>01559          <a class="code" href="app__queue_8c.html#1cb251ec0d568de6a929b520c4aed8d1">text</a> = <a class="code" href="app__queue_8c.html#1cb251ec0d568de6a929b520c4aed8d1">text</a>-&gt;next;
<a name="l01560"></a>01560       }
<a name="l01561"></a>01561    
<a name="l01562"></a>01562    }
<a name="l01563"></a>01563 
<a name="l01564"></a>01564    user = <a class="code" href="res__astum_8c.html#ee1adf0cb0617ea05eaccd8f5ad8b129">aum_build_user</a>(<a class="code" href="cdr__odbc_8c.html#14c4b06b824ec593239362517f538b29">username</a>, var, <a class="code" href="plc_8c.html#c0d83f0b82a6b30de8811e69e6d95c61">TRUE</a>);
<a name="l01565"></a>01565    <span class="keywordflow">if</span> (user) {
<a name="l01566"></a>01566       <a class="code" href="astobj_8h.html#3fdaf2512a79e6988684a893e49dc005">ASTOBJ_CONTAINER_LINK</a>(&amp;<a class="code" href="res__astum_8c.html#ba74a92e97c6e68e9f1a98087416ca97">aum_userlist</a>, user);
<a name="l01567"></a>01567       <a class="code" href="res__astum_8c.html#ebf83cc80ef4e43a6fe1dd0149ae8d07">aum_real_users</a>++;
<a name="l01568"></a>01568       <a class="code" href="utils_8h.html#3208623241ff7b4c93907944487502a1">ast_set_flag</a>(user, <a class="code" href="astum_8h.html#6ad8155725a1f22cb2b08985ccb68d238bbed3f7071f380cb87b9ea966826684">AUM_USER_FLAG_REALTIME</a>);
<a name="l01569"></a>01569    }
<a name="l01570"></a>01570    <a class="code" href="config_8c.html#d616f18584600c70e8744e217c03407c">ast_variables_destroy</a>(var);
<a name="l01571"></a>01571    <span class="keywordflow">return</span> user;
<a name="l01572"></a>01572 }
<a name="l01573"></a>01573 <span class="comment"></span>
<a name="l01574"></a>01574 <span class="comment">/*! \brief Get user from realtime storage </span>
<a name="l01575"></a>01575 <span class="comment">   Checks the \b aumusers realtime family from extconfig.conf </span>
<a name="l01576"></a>01576 <span class="comment">   \param username user to load</span>
<a name="l01577"></a>01577 <span class="comment"> */</span>
<a name="l01578"></a><a class="code" href="res__astum_8c.html#691cb6a96f603d4cb71d2d7384e5f891">01578</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="res__astum_8c.html#691cb6a96f603d4cb71d2d7384e5f891">aum_user_realtime_load</a>(<span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#14c4b06b824ec593239362517f538b29">username</a>)
<a name="l01579"></a>01579 {
<a name="l01580"></a>01580    <span class="keywordflow">return</span> <a class="code" href="res__astum_8c.html#2c05d82c17601c72f3e01b1ae4210205">aum_user_realtime_loadbyfield</a>(<span class="stringliteral">"name"</span>, username);
<a name="l01581"></a>01581 }
<a name="l01582"></a>01582 <span class="comment"></span>
<a name="l01583"></a>01583 <span class="comment">/*! \brief Get user from realtime storage </span>
<a name="l01584"></a>01584 <span class="comment">   Checks the \b aumusers realtime family from extconfig.conf </span>
<a name="l01585"></a>01585 <span class="comment">   \param username user to load</span>
<a name="l01586"></a>01586 <span class="comment"> */</span>
<a name="l01587"></a><a class="code" href="res__astum_8c.html#91b04a89ab3af38ce03f262cf708f328">01587</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="res__astum_8c.html#91b04a89ab3af38ce03f262cf708f328">aum_user_realtime_load_by_numuserid</a>(<span class="keywordtype">char</span> *<a class="code" href="structaum__user.html#c6b7c05f6f9e8d0ec2ca5596ca504936">numuserid</a>)
<a name="l01588"></a>01588 {
<a name="l01589"></a>01589    <span class="keywordflow">return</span> <a class="code" href="res__astum_8c.html#2c05d82c17601c72f3e01b1ae4210205">aum_user_realtime_loadbyfield</a>(<span class="stringliteral">"numuserid"</span>, numuserid);
<a name="l01590"></a>01590 }
<a name="l01591"></a>01591 
<a name="l01592"></a>01592 <span class="comment"></span>
<a name="l01593"></a>01593 <span class="comment">/*! \brief Remove user from a group's member list */</span>
<a name="l01594"></a><a class="code" href="res__astum_8c.html#36bfe03015f8fa9397bf2b4290cbe5aa">01594</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__astum_8c.html#36bfe03015f8fa9397bf2b4290cbe5aa">remove_user_from_group</a>(<span class="keyword">struct</span> <a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a>, <span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>)
<a name="l01595"></a>01595 {
<a name="l01596"></a>01596    <span class="keyword">struct </span><a class="code" href="structaum__group__member.html">aum_group_member</a> *<a class="code" href="structmember.html">member</a>;
<a name="l01597"></a>01597 
<a name="l01598"></a>01598    <span class="keywordflow">if</span> (!group || !user)
<a name="l01599"></a>01599       <span class="keywordflow">return</span>;
<a name="l01600"></a>01600 
<a name="l01601"></a>01601    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;group-&gt;<a class="code" href="structaum__group.html#d2e3083420929d8bfae81f58fa4594cb">members</a>, member, list) {
<a name="l01602"></a>01602       <span class="keywordflow">if</span> (member-&gt;<a class="code" href="structaum__group__member.html#ee11cbb19052e40b07aac0ca060c23ee">user</a> == user) {
<a name="l01603"></a>01603          <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;group-&gt;<a class="code" href="structaum__group.html#d2e3083420929d8bfae81f58fa4594cb">members</a>);
<a name="l01604"></a>01604          <a class="code" href="linkedlists_8h.html#d4a4c53d3b264b4e1c5e3fdd84cd8b5a">AST_LIST_REMOVE</a>(&amp;group-&gt;<a class="code" href="structaum__group.html#d2e3083420929d8bfae81f58fa4594cb">members</a>, member, list);
<a name="l01605"></a>01605          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(member);
<a name="l01606"></a>01606          <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;group-&gt;<a class="code" href="structaum__group.html#d2e3083420929d8bfae81f58fa4594cb">members</a>);
<a name="l01607"></a>01607       }
<a name="l01608"></a>01608    };
<a name="l01609"></a>01609 }
<a name="l01610"></a>01610 <span class="comment"></span>
<a name="l01611"></a>01611 <span class="comment">/*! \brief Remove group from a user's group list */</span>
<a name="l01612"></a><a class="code" href="res__astum_8c.html#6e74fcd5f927e8f9f0424f0877e824f9">01612</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__astum_8c.html#6e74fcd5f927e8f9f0424f0877e824f9">remove_group_from_user</a>(<span class="keyword">struct</span> <a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a>, <span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>)
<a name="l01613"></a>01613 {
<a name="l01614"></a>01614    <span class="keyword">struct </span><a class="code" href="structaum__group__member.html">aum_group_member</a> *<a class="code" href="structmember.html">member</a>;
<a name="l01615"></a>01615 
<a name="l01616"></a>01616    <span class="keywordflow">if</span> (!group || !user)
<a name="l01617"></a>01617       <span class="keywordflow">return</span>;
<a name="l01618"></a>01618 
<a name="l01619"></a>01619    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#1471e4e05a4db95d353cc867fe317314">groups</a>, member, list) {
<a name="l01620"></a>01620       <span class="keywordflow">if</span> (member-&gt;<a class="code" href="structaum__group__member.html#db0f6f37ebeb6ea09489124345af2a45">group</a> == group) {
<a name="l01621"></a>01621          <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#1471e4e05a4db95d353cc867fe317314">groups</a>);
<a name="l01622"></a>01622          <a class="code" href="linkedlists_8h.html#d4a4c53d3b264b4e1c5e3fdd84cd8b5a">AST_LIST_REMOVE</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#1471e4e05a4db95d353cc867fe317314">groups</a>, member, list);
<a name="l01623"></a>01623          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(member);
<a name="l01624"></a>01624          <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#1471e4e05a4db95d353cc867fe317314">groups</a>);
<a name="l01625"></a>01625       }
<a name="l01626"></a>01626    };
<a name="l01627"></a>01627 
<a name="l01628"></a>01628    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(user, <a class="code" href="astum_8h.html#6ad8155725a1f22cb2b08985ccb68d238bbed3f7071f380cb87b9ea966826684">AUM_USER_FLAG_REALTIME</a>))
<a name="l01629"></a>01629       <a class="code" href="res__astum_8c.html#aa329ccfb2f77758d8f346ab09b6954f">aum_rtcache_movetotop</a>(user);
<a name="l01630"></a>01630 }
<a name="l01631"></a>01631 <span class="comment"></span>
<a name="l01632"></a>01632 <span class="comment">/*! \brief Destroy AUM group object */</span>
<a name="l01633"></a><a class="code" href="res__astum_8c.html#b1b57aeeb3f6691238a6d7e71c62a744">01633</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__astum_8c.html#b1b57aeeb3f6691238a6d7e71c62a744">aum_destroy_group</a>(<span class="keyword">struct</span> <a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a>)
<a name="l01634"></a>01634 {
<a name="l01635"></a>01635    <span class="comment">/* Release all suballocations */</span>
<a name="l01636"></a>01636    <span class="keywordflow">if</span> (group-&gt;<a class="code" href="structaum__group.html#67daf92c833c41c95db874e18fcb2786">description</a>)
<a name="l01637"></a>01637       <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(group-&gt;<a class="code" href="structaum__group.html#67daf92c833c41c95db874e18fcb2786">description</a>);
<a name="l01638"></a>01638 
<a name="l01639"></a>01639    <span class="comment">/* Release member list */</span>
<a name="l01640"></a>01640    <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;group-&gt;<a class="code" href="structaum__group.html#d2e3083420929d8bfae81f58fa4594cb">members</a>) ) {
<a name="l01641"></a>01641       <span class="keyword">struct </span><a class="code" href="structaum__group__member.html">aum_group_member</a> *<a class="code" href="structmember.html">member</a>;
<a name="l01642"></a>01642       <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;group-&gt;<a class="code" href="structaum__group.html#d2e3083420929d8bfae81f58fa4594cb">members</a>);
<a name="l01643"></a>01643       <span class="keywordflow">while</span> ((member = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;group-&gt;<a class="code" href="structaum__group.html#d2e3083420929d8bfae81f58fa4594cb">members</a>, list))) {
<a name="l01644"></a>01644          <span class="comment">/* Check if the user still considers itself a member of this group */</span>
<a name="l01645"></a>01645          <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;member-&gt;<a class="code" href="structaum__group__member.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>-&gt;<a class="code" href="structaum__user.html#1471e4e05a4db95d353cc867fe317314">groups</a>))
<a name="l01646"></a>01646             <a class="code" href="res__astum_8c.html#6e74fcd5f927e8f9f0424f0877e824f9">remove_group_from_user</a>(group, member-&gt;<a class="code" href="structaum__group__member.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>);
<a name="l01647"></a>01647          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(member);
<a name="l01648"></a>01648       }
<a name="l01649"></a>01649       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;group-&gt;<a class="code" href="structaum__group.html#d2e3083420929d8bfae81f58fa4594cb">members</a>);
<a name="l01650"></a>01650    }
<a name="l01651"></a>01651 
<a name="l01652"></a>01652    <span class="comment">/* clear channel variables */</span>
<a name="l01653"></a>01653    <span class="keywordflow">if</span> (group-&gt;<a class="code" href="structaum__group.html#1a366a2de522c52f41f6de2219adf59b">chanvars</a>) 
<a name="l01654"></a>01654       <a class="code" href="config_8c.html#d616f18584600c70e8744e217c03407c">ast_variables_destroy</a>(group-&gt;<a class="code" href="structaum__group.html#1a366a2de522c52f41f6de2219adf59b">chanvars</a>);
<a name="l01655"></a>01655 
<a name="l01656"></a>01656    <span class="comment">/* Release the group itself */</span>
<a name="l01657"></a>01657    <a class="code" href="res__astum_8c.html#9dd2e3e6486090c6e1930a49b376319e">aum_free</a>(group);
<a name="l01658"></a>01658 }
<a name="l01659"></a>01659 
<a name="l01660"></a>01660 <span class="comment"></span>
<a name="l01661"></a>01661 <span class="comment">/*! \brief Destroy AUM user object */</span>
<a name="l01662"></a><a class="code" href="res__astum_8c.html#e3b7823b997a9732153a16e6c120b767">01662</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__astum_8c.html#e3b7823b997a9732153a16e6c120b767">aum_destroy_user</a>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>)
<a name="l01663"></a>01663 {
<a name="l01664"></a>01664    <span class="comment">/* Release all suballocations */</span>
<a name="l01665"></a>01665 
<a name="l01666"></a>01666    <span class="comment">/* Release user list */</span>
<a name="l01667"></a>01667    <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#884d9804999fc47a3c2694e49ad2536a">address</a>) ) {
<a name="l01668"></a>01668       <span class="keyword">struct </span><a class="code" href="structaum__address.html">aum_address</a> *addr;
<a name="l01669"></a>01669       <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#884d9804999fc47a3c2694e49ad2536a">address</a>);
<a name="l01670"></a>01670       <span class="keywordflow">while</span> ((addr = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#884d9804999fc47a3c2694e49ad2536a">address</a>, list)))
<a name="l01671"></a>01671          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(addr);
<a name="l01672"></a>01672       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#884d9804999fc47a3c2694e49ad2536a">address</a>);
<a name="l01673"></a>01673    }
<a name="l01674"></a>01674 
<a name="l01675"></a>01675    <span class="comment">/* If we belong to groups remove us as members */</span>
<a name="l01676"></a>01676    <span class="comment">/* Remove group memberships */</span>
<a name="l01677"></a>01677    <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#1471e4e05a4db95d353cc867fe317314">groups</a>) ) {
<a name="l01678"></a>01678       <span class="keyword">struct </span><a class="code" href="structaum__group__member.html">aum_group_member</a> *<a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a>;
<a name="l01679"></a>01679       <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#1471e4e05a4db95d353cc867fe317314">groups</a>);
<a name="l01680"></a>01680       <span class="keywordflow">while</span> ((group = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#1471e4e05a4db95d353cc867fe317314">groups</a>, list)))
<a name="l01681"></a>01681          <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;group-&gt;<a class="code" href="structaum__group__member.html#db0f6f37ebeb6ea09489124345af2a45">group</a>-&gt;<a class="code" href="structaum__group.html#d2e3083420929d8bfae81f58fa4594cb">members</a>))
<a name="l01682"></a>01682             <a class="code" href="res__astum_8c.html#36bfe03015f8fa9397bf2b4290cbe5aa">remove_user_from_group</a>(group-&gt;<a class="code" href="structaum__group__member.html#db0f6f37ebeb6ea09489124345af2a45">group</a>, user);
<a name="l01683"></a>01683          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(group);
<a name="l01684"></a>01684       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#1471e4e05a4db95d353cc867fe317314">groups</a>);
<a name="l01685"></a>01685    }
<a name="l01686"></a>01686 
<a name="l01687"></a>01687    <span class="comment">/* Release context list */</span>
<a name="l01688"></a>01688    <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#0a9573eff61452c49019359bfc0df565">AST_LIST_EMPTY</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#9be90dc64c1f5b5c993ff11d732a8da0">contexts</a>) ) {
<a name="l01689"></a>01689       <span class="keyword">struct </span><a class="code" href="structaum__context.html">aum_context</a> *<a class="code" href="chan__alsa_8c.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>;
<a name="l01690"></a>01690       <a class="code" href="linkedlists_8h.html#44d46016bec4f7c50450973666ce638d">AST_LIST_LOCK</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#9be90dc64c1f5b5c993ff11d732a8da0">contexts</a>);
<a name="l01691"></a>01691       <span class="keywordflow">while</span> ((context = <a class="code" href="linkedlists_8h.html#beec347da29fe6b0d7fdb3e80b851f90">AST_LIST_REMOVE_HEAD</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#9be90dc64c1f5b5c993ff11d732a8da0">contexts</a>, list)))
<a name="l01692"></a>01692          <a class="code" href="astmm_8h.html#eb051e552619427a26721b1a925a56e8">free</a>(context);
<a name="l01693"></a>01693       <a class="code" href="linkedlists_8h.html#1829cc3d91ee394b65b7379f68ab3dad">AST_LIST_UNLOCK</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#9be90dc64c1f5b5c993ff11d732a8da0">contexts</a>);
<a name="l01694"></a>01694    }
<a name="l01695"></a>01695 
<a name="l01696"></a>01696    <span class="comment">/* clear channel variables */</span>
<a name="l01697"></a>01697    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structaum__user.html#1a366a2de522c52f41f6de2219adf59b">chanvars</a>)
<a name="l01698"></a>01698       <a class="code" href="config_8c.html#d616f18584600c70e8744e217c03407c">ast_variables_destroy</a>(user-&gt;<a class="code" href="structaum__user.html#1a366a2de522c52f41f6de2219adf59b">chanvars</a>);
<a name="l01699"></a>01699 
<a name="l01700"></a>01700    <span class="comment">/* Clear the ACL */</span>     
<a name="l01701"></a>01701    <a class="code" href="acl_8c.html#395c900def2430bc4d7270a1b537c870">ast_free_ha</a>(user-&gt;<a class="code" href="structaum__user.html#a33915ba226b6dbd1edb3e09fac41ed9">acl</a>);
<a name="l01702"></a>01702 
<a name="l01703"></a>01703    <span class="comment">/* Release the user itself */</span>
<a name="l01704"></a>01704    <a class="code" href="res__astum_8c.html#9dd2e3e6486090c6e1930a49b376319e">aum_free</a>(user);
<a name="l01705"></a>01705 }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707 
<a name="l01708"></a>01708 <span class="comment"></span>
<a name="l01709"></a>01709 <span class="comment">/*! \brief  reload_config: Re-read aum.conf config file ---*/</span>
<a name="l01710"></a>01710 <span class="comment">/* This function reloads all config data for users and groups</span>
<a name="l01711"></a>01711 <span class="comment"> */</span>
<a name="l01712"></a><a class="code" href="res__astum_8c.html#a15309dcf310dc535708754d98d0db69">01712</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__h323_8c.html#658d62bcd011a49f377d6ceb2a0294ca">reload_config</a>(<span class="keyword">enum</span> <a class="code" href="res__astum_8c.html#4e2c74b8ed5eb469d94c25d198b8f171">modulereloadreason</a> reason)
<a name="l01713"></a>01713 {
<a name="l01714"></a>01714    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l01715"></a>01715    <span class="keyword">struct </span><a class="code" href="structast__variable.html">ast_variable</a> *v, *x;
<a name="l01716"></a>01716    <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>;
<a name="l01717"></a>01717    <span class="keywordtype">char</span> *cat;
<a name="l01718"></a>01718    <span class="keyword">struct </span><a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a> = NULL;
<a name="l01719"></a>01719    <span class="keyword">enum</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1">aum_config_options</a> option;
<a name="l01720"></a>01720 
<a name="l01721"></a>01721    <a class="code" href="res__astum_8c.html#b8a5bbee002aece8af628f8694357607">aum_real_groups_enabled</a> = <a class="code" href="config_8c.html#f0d3c598d4ed9b462978022b65676af5">ast_check_realtime</a>(<span class="stringliteral">"aumgroups"</span>);
<a name="l01722"></a>01722    <a class="code" href="res__astum_8c.html#e126e8e41904920cffa1f9c582ef4bf8">aum_real_users_enabled</a> = <a class="code" href="config_8c.html#f0d3c598d4ed9b462978022b65676af5">ast_check_realtime</a>(<span class="stringliteral">"aumgroups"</span>);
<a name="l01723"></a>01723 
<a name="l01724"></a>01724    cfg = <a class="code" href="config_8c.html#0ea8bde5422fa0db50302e0f710e18c1">ast_config_load</a>(<a class="code" href="res__astum_8c.html#c3f3453270a4460e449983a232f6283a">aum_config_file</a>);
<a name="l01725"></a>01725 
<a name="l01726"></a>01726    <span class="comment">/* We *must* have a config file otherwise stop immediately */</span>
<a name="l01727"></a>01727    <span class="keywordflow">if</span> (!cfg) {
<a name="l01728"></a>01728       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Unable to load config %s\n"</span>, <a class="code" href="res__astum_8c.html#c3f3453270a4460e449983a232f6283a">aum_config_file</a>);
<a name="l01729"></a>01729       <span class="keywordflow">return</span> -1;
<a name="l01730"></a>01730    }
<a name="l01731"></a>01731    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#g1cc76c5e6a626e61ced4609749a57a6e">option_debug</a>)
<a name="l01732"></a>01732       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Loading configuration for the Asterisk User Management module\n"</span>);
<a name="l01733"></a>01733    
<a name="l01734"></a>01734 
<a name="l01735"></a>01735    <span class="comment">/* Initialize some reasonable defaults at AUM reload */</span>
<a name="l01736"></a>01736    <a class="code" href="res__astum_8c.html#e910aeac3bd7570908f8be1a9b12134f">aum_debug</a> = 0;
<a name="l01737"></a>01737    <a class="code" href="res__astum_8c.html#2e4b6b5e42594b7f28a94a3b7d6c0433">aum_real_groups</a> = 0;
<a name="l01738"></a>01738    <a class="code" href="res__astum_8c.html#aaf6c6bfd8f8801838688e0cd4943115">aum_static_groups</a> = 0;
<a name="l01739"></a>01739    <a class="code" href="res__astum_8c.html#ebf83cc80ef4e43a6fe1dd0149ae8d07">aum_real_users</a> = 0;
<a name="l01740"></a>01740    <a class="code" href="res__astum_8c.html#decda0d0cbdba0e8a722f972201501af">aum_static_users</a> = 0;
<a name="l01741"></a>01741    <a class="code" href="res__astum_8c.html#3b28ee7e07abf7ced3662bf4f6697dcd">aum_usercache_max</a> = <a class="code" href="res__astum_8c.html#0b2d7e2e4a5bc2a472f6c92b59cdaf63">DEFAULT_USERCACHE_MAX</a>;
<a name="l01742"></a>01742    <a class="code" href="astobj_8h.html#284e163c14171b2ee463adb64dc35f97">ASTOBJ_CONTAINER_INIT</a>(&amp;<a class="code" href="res__astum_8c.html#df751995f211be58a457c2d71dc6dc19">aum_grouplist</a>);
<a name="l01743"></a>01743    <a class="code" href="astobj_8h.html#284e163c14171b2ee463adb64dc35f97">ASTOBJ_CONTAINER_INIT</a>(&amp;<a class="code" href="res__astum_8c.html#ba74a92e97c6e68e9f1a98087416ca97">aum_userlist</a>);
<a name="l01744"></a>01744 
<a name="l01745"></a>01745    <span class="comment">/* Read the [general] config section of aum.conf (or from realtime config) */</span>
<a name="l01746"></a>01746    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(LOG_DEBUG, <span class="stringliteral">"===== Starting to read general section\n"</span>);
<a name="l01747"></a>01747    x = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, <span class="stringliteral">"general"</span>);
<a name="l01748"></a>01748    <span class="keywordflow">while</span>(x) {
<a name="l01749"></a>01749       option = <a class="code" href="res__astum_8c.html#f19ceacaa5634e43392db073d1607a78">aum_config_parse</a>(x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>, <a class="code" href="astum_8h.html#8e3821198833f49fc234e3aa9d1c101bcf1e18f3f14fdbfe7ab61d68ea8bd654">AUM_CONFOBJ_USER</a>);
<a name="l01750"></a>01750       <span class="keywordflow">switch</span> (option) {
<a name="l01751"></a>01751       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d127ae02c9aa3ccdc46710f636bfb68bae">AUM_CNF_DEBUG</a>:
<a name="l01752"></a>01752          <a class="code" href="res__astum_8c.html#e910aeac3bd7570908f8be1a9b12134f">aum_debug</a> = <a class="code" href="utils_8c.html#63bb02e4d6f18c1dbeca92dc63310685">ast_true</a>(x-&gt;<a class="code" href="structast__variable.html#2063c1608d6e0baf80249c42e2be5804">value</a>);
<a name="l01753"></a>01753          <span class="keywordflow">break</span>;
<a name="l01754"></a>01754       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1f5c01833a89887e5638175a4f4e46e0d">AUM_CNF_GROUPDESC</a>:
<a name="l01755"></a>01755          group-&gt;<a class="code" href="structaum__group.html#67daf92c833c41c95db874e18fcb2786">description</a> = <a class="code" href="utils_8h.html#b38bbfc0f090d7e013ad805ff172a7d2">ast_strdupa</a>(x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l01756"></a>01756          <span class="keywordflow">break</span>;
<a name="l01757"></a>01757       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d173fa26fecd85afb58dae334118e88ed1">AUM_CNF_NOT_FOUND</a>:
<a name="l01758"></a>01758          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Configuration label unknown in AUM configuration: %s\n"</span>, x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l01759"></a>01759          <span class="keywordflow">break</span>;
<a name="l01760"></a>01760       <span class="keywordflow">case</span> <a class="code" href="astum_8h.html#43d27bd07d821ff39c201ca688a552d1020cff95905ec429aa2da79cd75f3365">AUM_CNF_NOT_VALID_FOR_OBJECT</a>:
<a name="l01761"></a>01761       <span class="keywordflow">default</span>:
<a name="l01762"></a>01762          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#bbf95aad74d847cd4bcb129604f798cd">LOG_NOTICE</a>, <span class="stringliteral">"Configuration label not valid for group objects in AUM configuration: %s\n"</span>, x-&gt;<a class="code" href="structast__variable.html#b068931cc450442b63f5b3d276ea4297">name</a>);
<a name="l01763"></a>01763          <span class="keywordflow">break</span>;
<a name="l01764"></a>01764       }
<a name="l01765"></a>01765       x = x-&gt;<a class="code" href="structast__variable.html#d0cab90d8d20d57e2f2b9be52f7dd25d">next</a>;
<a name="l01766"></a>01766    }
<a name="l01767"></a>01767    <span class="comment">/* Load group names */</span>
<a name="l01768"></a>01768    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"===== Starting to read [groups] section\n"</span>);
<a name="l01769"></a>01769    v = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, <span class="stringliteral">"groups"</span>);
<a name="l01770"></a>01770    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"- Found group section \n"</span>);
<a name="l01771"></a>01771    <span class="keywordflow">while</span> (v) {
<a name="l01772"></a>01772       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"- Found new group: %s=%s\n"</span>, v-&gt;name, v-&gt;value);
<a name="l01773"></a>01773       <span class="keywordflow">if</span> (!strcmp(v-&gt;name, <span class="stringliteral">"group"</span>)) {
<a name="l01774"></a>01774          <span class="comment">/* get the group */</span>
<a name="l01775"></a>01775          x = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, v-&gt;value);
<a name="l01776"></a>01776          <span class="keywordflow">if</span> (x) {
<a name="l01777"></a>01777             <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"- Trying to build new group: %s\n"</span>, v-&gt;value);
<a name="l01778"></a>01778             <a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a> = <a class="code" href="res__astum_8c.html#55307d0ee9eb7b6419585594347227d9">aum_build_group</a>(v-&gt;value, x, 0);  <span class="comment">/* Build the group */</span>
<a name="l01779"></a>01779             <span class="keywordflow">if</span> (<a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a>) {
<a name="l01780"></a>01780                <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#673e841c68db57daad3d2b949a08e5cf">LOG_VERBOSE</a>, <span class="stringliteral">"- Built new group:%s\n"</span>, v-&gt;value);
<a name="l01781"></a>01781                <a class="code" href="astobj_8h.html#3fdaf2512a79e6988684a893e49dc005">ASTOBJ_CONTAINER_LINK</a>(&amp;<a class="code" href="res__astum_8c.html#df751995f211be58a457c2d71dc6dc19">aum_grouplist</a>, <a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a>);
<a name="l01782"></a>01782             }
<a name="l01783"></a>01783          }
<a name="l01784"></a>01784       }
<a name="l01785"></a>01785       v = v-&gt;next;
<a name="l01786"></a>01786    }
<a name="l01787"></a>01787    
<a name="l01788"></a>01788    <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"===== Starting to read [users] section\n"</span>);
<a name="l01789"></a>01789 
<a name="l01790"></a>01790    <span class="comment">/* Load the rest of the sections - group details and users */</span>
<a name="l01791"></a>01791    cat = <a class="code" href="config_8c.html#38fbac9adb1c1bf165ecce251cb206a8">ast_category_browse</a>(cfg, NULL);
<a name="l01792"></a>01792    <span class="keywordflow">while</span> (cat) {
<a name="l01793"></a>01793       <span class="keywordtype">char</span> *sectiontype;
<a name="l01794"></a>01794 
<a name="l01795"></a>01795       <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"Found new user/group section: %s\n"</span>, cat);
<a name="l01796"></a>01796       sectiontype= <a class="code" href="config_8c.html#db24588ed54fb0d9d8f078b9d64bd0e1">ast_variable_retrieve</a>(cfg, cat, <span class="stringliteral">"type"</span>);
<a name="l01797"></a>01797       <span class="keywordflow">if</span> (!strcmp(cat, <span class="stringliteral">"groups"</span>) || ( sectiontype &amp;&amp; !strcmp(sectiontype, <span class="stringliteral">"group"</span>))) {
<a name="l01798"></a>01798          <a class="code" href="logger_8c.html#46fbacc19de763bbca2547c1a9c6a5fa">ast_log</a>(<a class="code" href="logger_8h.html#eded50d942c7c2d37d09ba8241ff017f">LOG_DEBUG</a>, <span class="stringliteral">"==== Skipping group section (already configured, hopefully)\n"</span>);
<a name="l01799"></a>01799       } <span class="keywordflow">else</span> {
<a name="l01800"></a>01800          x = <a class="code" href="config_8c.html#65ed813ca973e0e5dd3426804249db4f">ast_variable_browse</a>(cfg, cat);
<a name="l01801"></a>01801          <span class="keywordflow">if</span> (x) {
<a name="l01802"></a>01802             <a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a> = <a class="code" href="res__astum_8c.html#ee1adf0cb0617ea05eaccd8f5ad8b129">aum_build_user</a>(cat, x, 0);   <span class="comment">/* Build the user */</span>
<a name="l01803"></a>01803             <span class="keywordflow">if</span> (<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>) {
<a name="l01804"></a>01804                <a class="code" href="astobj_8h.html#3fdaf2512a79e6988684a893e49dc005">ASTOBJ_CONTAINER_LINK</a>(&amp;<a class="code" href="res__astum_8c.html#ba74a92e97c6e68e9f1a98087416ca97">aum_userlist</a>, <a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>);
<a name="l01805"></a>01805             }
<a name="l01806"></a>01806          }
<a name="l01807"></a>01807       }
<a name="l01808"></a>01808       <span class="comment">/* Get next [section] */</span>
<a name="l01809"></a>01809       cat = <a class="code" href="config_8c.html#38fbac9adb1c1bf165ecce251cb206a8">ast_category_browse</a>(cfg, cat);
<a name="l01810"></a>01810    }
<a name="l01811"></a>01811 
<a name="l01812"></a>01812 
<a name="l01813"></a>01813    <span class="comment">/* Release configuration from memory */</span>
<a name="l01814"></a>01814    <a class="code" href="config_8c.html#ad84c9d29ca53758c2a113d057e221a0">ast_config_destroy</a>(cfg);
<a name="l01815"></a>01815 
<a name="l01816"></a>01816    <span class="comment">/* Done, tell the manager */</span>
<a name="l01817"></a>01817    <a class="code" href="manager_8h.html#17a8c809d5b2d04cbb8969a209134c2b">manager_event</a>(<a class="code" href="manager_8h.html#440ebd9d80179402b9cd76c426adb8d2">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">"ModuleReload"</span>, <span class="stringliteral">"Module: res_aum.so\r\nReloadReason: %s\r\nAUMUserCount: %d\r\nAUMGroupCount: %d\r\n\r\n\r\n"</span>, <a class="code" href="res__astum_8c.html#96ef8b04540433e255e0d2c332d551fa">modulereloadreason2txt</a>(reason), <a class="code" href="res__astum_8c.html#decda0d0cbdba0e8a722f972201501af">aum_static_users</a>, <a class="code" href="res__astum_8c.html#aaf6c6bfd8f8801838688e0cd4943115">aum_static_groups</a>);
<a name="l01818"></a>01818 
<a name="l01819"></a>01819    <span class="keywordflow">return</span> 0;
<a name="l01820"></a>01820 }
<a name="l01821"></a>01821 
<a name="l01822"></a>01822 <span class="comment">/*---------------------------- API functions (public, declared in aum.h ----------------*/</span>
<a name="l01823"></a><a class="code" href="res__astum_8c.html#93f45746bdbb4908339b01e5cad29671">01823</a> <span class="keywordtype">char</span> *<a class="code" href="astum_8h.html#93f45746bdbb4908339b01e5cad29671">find_aum_user_context</a>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>, <span class="keyword">enum</span> <a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc19">aum_context_type</a> <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>)
<a name="l01824"></a>01824 {
<a name="l01825"></a>01825    <span class="keyword">struct </span><a class="code" href="structaum__context.html">aum_context</a> *con;
<a name="l01826"></a>01826 
<a name="l01827"></a>01827    <span class="keywordflow">if</span> (!user || type == <a class="code" href="astum_8h.html#f6c49c44d00a15ed3de1e36643e4fc192c0f1e472b875d296416258589aef812">AUM_CONTEXT_NONE</a>)
<a name="l01828"></a>01828       <span class="keywordflow">return</span> NULL;
<a name="l01829"></a>01829 
<a name="l01830"></a>01830    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#9be90dc64c1f5b5c993ff11d732a8da0">contexts</a>, con, list) {
<a name="l01831"></a>01831       <span class="keywordflow">if</span> (con-&gt;<a class="code" href="structaum__context.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a> == type)
<a name="l01832"></a>01832          <span class="keywordflow">return</span> con-&gt;<a class="code" href="structaum__context.html#c1ae8ba118483c4c23841d72b5e7ebbb">context</a>;
<a name="l01833"></a>01833    };
<a name="l01834"></a>01834    <span class="keywordflow">return</span> (<span class="keywordtype">char</span> *) NULL;
<a name="l01835"></a>01835 }
<a name="l01836"></a>01836 
<a name="l01837"></a><a class="code" href="res__astum_8c.html#74cb2fa1c905b31737f9681321c837ef">01837</a> <span class="keyword">struct </span><a class="code" href="structaum__address.html">aum_address</a> *<a class="code" href="astum_8h.html#74cb2fa1c905b31737f9681321c837ef">find_address_for_user</a>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>, <span class="keyword">enum</span> <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf">aum_address_type</a> <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, <span class="keyword">struct</span> <a class="code" href="structaum__address.html">aum_address</a> *start)
<a name="l01838"></a>01838 {
<a name="l01839"></a>01839    <span class="keyword">struct </span><a class="code" href="structaum__address.html">aum_address</a> *addr;
<a name="l01840"></a>01840    <span class="keywordtype">int</span> activesearch = 0;
<a name="l01841"></a>01841    <span class="keywordflow">if</span> (!start)
<a name="l01842"></a>01842       activesearch = 1;
<a name="l01843"></a>01843 
<a name="l01844"></a>01844    <span class="keywordflow">if</span> (!user || type == <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf72fc093e3fa1bccf5fc289fd4ea656e0">AUM_ADDR_NONE</a>)
<a name="l01845"></a>01845       <span class="keywordflow">return</span> NULL;
<a name="l01846"></a>01846 
<a name="l01847"></a>01847    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#884d9804999fc47a3c2694e49ad2536a">address</a>, addr, list) {
<a name="l01848"></a>01848       <span class="keywordflow">if</span> (activesearch &amp;&amp; addr-&gt;<a class="code" href="structaum__address.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a> == type)
<a name="l01849"></a>01849          <span class="keywordflow">return</span> addr;
<a name="l01850"></a>01850       <span class="keywordflow">if</span> (!activesearch &amp;&amp; start == addr)
<a name="l01851"></a>01851          activesearch = 1;
<a name="l01852"></a>01852    };
<a name="l01853"></a>01853    <span class="keywordflow">return</span> NULL;
<a name="l01854"></a>01854 }
<a name="l01855"></a>01855 
<a name="l01856"></a><a class="code" href="res__astum_8c.html#072e629f1d7a418f927edd707df10807">01856</a> <span class="keywordtype">char</span> *<a class="code" href="astum_8h.html#072e629f1d7a418f927edd707df10807">aum_find_address</a>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>, <span class="keyword">enum</span> <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf">aum_address_type</a> <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>)
<a name="l01857"></a>01857 {
<a name="l01858"></a>01858    <span class="keyword">struct </span><a class="code" href="structaum__address.html">aum_address</a> *addr;
<a name="l01859"></a>01859    addr = <a class="code" href="astum_8h.html#74cb2fa1c905b31737f9681321c837ef">find_address_for_user</a>(user, type, NULL);
<a name="l01860"></a>01860    <span class="keywordflow">return</span> addr-&gt;<a class="code" href="structaum__address.html#716bf5b8761420f27a8804154f75d738">address</a>;
<a name="l01861"></a>01861 }
<a name="l01862"></a>01862 
<a name="l01863"></a><a class="code" href="res__astum_8c.html#7fb7da1a6196ecedc5bd02499747c8b3">01863</a> <span class="keywordtype">char</span> *<a class="code" href="astum_8h.html#7fb7da1a6196ecedc5bd02499747c8b3">aum_find_email</a>(<span class="keywordtype">char</span> *userid) {
<a name="l01864"></a>01864    <span class="keywordflow">return</span> <a class="code" href="astum_8h.html#072e629f1d7a418f927edd707df10807">aum_find_address</a>(<a class="code" href="astum_8h.html#193a76f977f30b532eb9bccca7d0d8b9">find_aum_user</a>(userid, <a class="code" href="plc_8c.html#c0d83f0b82a6b30de8811e69e6d95c61">TRUE</a>), <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfa684fc88dfbd27a288352c7a3b8711e5">AUM_ADDR_EMAIL</a>);
<a name="l01865"></a>01865 }
<a name="l01866"></a>01866 
<a name="l01867"></a><a class="code" href="res__astum_8c.html#16992249397edb9a870daba8809c14f3">01867</a> <span class="keywordtype">char</span> *<a class="code" href="astum_8h.html#16992249397edb9a870daba8809c14f3">aum_find_email_full</a>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>) {
<a name="l01868"></a>01868    <span class="keywordflow">return</span> <a class="code" href="astum_8h.html#072e629f1d7a418f927edd707df10807">aum_find_address</a>(user, <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfa684fc88dfbd27a288352c7a3b8711e5">AUM_ADDR_EMAIL</a>);
<a name="l01869"></a>01869 }
<a name="l01870"></a>01870 
<a name="l01871"></a><a class="code" href="res__astum_8c.html#b5926884031eeb0b3533be9572232e8c">01871</a> <span class="keyword">struct </span><a class="code" href="structaum__address.html">aum_address</a> *<a class="code" href="astum_8h.html#b5926884031eeb0b3533be9572232e8c">find_user_address</a>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>, <span class="keyword">enum</span> <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf">aum_address_type</a> <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, <span class="keywordtype">char</span> *<a class="code" href="structaum__address.html#716bf5b8761420f27a8804154f75d738">address</a>)
<a name="l01872"></a>01872 {
<a name="l01873"></a>01873    <span class="keyword">struct </span><a class="code" href="structaum__address.html">aum_address</a> *addr;
<a name="l01874"></a>01874 
<a name="l01875"></a>01875    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(address))
<a name="l01876"></a>01876       <span class="keywordflow">return</span> NULL;
<a name="l01877"></a>01877 
<a name="l01878"></a>01878    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#884d9804999fc47a3c2694e49ad2536a">address</a>, addr, list) {
<a name="l01879"></a>01879       <span class="keywordflow">if</span> (addr-&gt;<a class="code" href="structaum__address.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a> == type &amp;&amp; !strcmp(addr-&gt;<a class="code" href="structaum__address.html#716bf5b8761420f27a8804154f75d738">address</a>, address) )
<a name="l01880"></a>01880          <span class="keywordflow">return</span> addr;
<a name="l01881"></a>01881    };
<a name="l01882"></a>01882    <span class="keywordflow">return</span> (<span class="keyword">struct</span> <a class="code" href="structaum__address.html">aum_address</a> *) NULL;
<a name="l01883"></a>01883    
<a name="l01884"></a>01884 }
<a name="l01885"></a>01885 
<a name="l01886"></a><a class="code" href="res__astum_8c.html#ccd293a69a053fadd9fd57297cca5e43">01886</a> <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="astum_8h.html#ccd293a69a053fadd9fd57297cca5e43">find_user_by_address</a>(<span class="keyword">enum</span> <a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cf">aum_address_type</a> <a class="code" href="rtp_8c.html#599dcce2998a6b40b1e38e8c6006cb0a">type</a>, <span class="keywordtype">char</span> *<a class="code" href="structaum__user.html#884d9804999fc47a3c2694e49ad2536a">address</a>)
<a name="l01887"></a>01887 {
<a name="l01888"></a>01888    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(address))
<a name="l01889"></a>01889       <span class="keywordflow">return</span> NULL;
<a name="l01890"></a>01890 
<a name="l01891"></a>01891    <a class="code" href="astobj_8h.html#0d158ef06434f7b47d5a7eddaa24f18a">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__astum_8c.html#ba74a92e97c6e68e9f1a98087416ca97">aum_userlist</a>, 1, {
<a name="l01892"></a>01892       <a class="code" href="astobj_8h.html#013e2f1442ca7e5cd2cb0756766cd6c7">ASTOBJ_RDLOCK</a>(iterator);
<a name="l01893"></a>01893       <span class="keywordflow">if</span>(<a class="code" href="astum_8h.html#b5926884031eeb0b3533be9572232e8c">find_user_address</a>(iterator, type, address)) {
<a name="l01894"></a>01894          <a class="code" href="astobj_8h.html#09df6ddac721782b63dde9c9247b5285">ASTOBJ_UNLOCK</a>(iterator);
<a name="l01895"></a>01895          <span class="keywordflow">return</span> iterator;
<a name="l01896"></a>01896       }
<a name="l01897"></a>01897       <a class="code" href="astobj_8h.html#09df6ddac721782b63dde9c9247b5285">ASTOBJ_UNLOCK</a>(iterator);
<a name="l01898"></a>01898    } );
<a name="l01899"></a>01899    <span class="keywordflow">return</span> NULL;
<a name="l01900"></a>01900 }
<a name="l01901"></a>01901 
<a name="l01902"></a><a class="code" href="res__astum_8c.html#08bc40c38b935a7773bc6adf18a07ad8">01902</a> <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="astum_8h.html#08bc40c38b935a7773bc6adf18a07ad8">find_aum_user_by_numuserid</a>(<span class="keywordtype">char</span> *<a class="code" href="structaum__user.html#c6b7c05f6f9e8d0ec2ca5596ca504936">numuserid</a>)
<a name="l01903"></a>01903 {
<a name="l01904"></a>01904    <a class="code" href="astobj_8h.html#0d158ef06434f7b47d5a7eddaa24f18a">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__astum_8c.html#ba74a92e97c6e68e9f1a98087416ca97">aum_userlist</a>, 1, {
<a name="l01905"></a>01905       <a class="code" href="astobj_8h.html#013e2f1442ca7e5cd2cb0756766cd6c7">ASTOBJ_RDLOCK</a>(iterator);
<a name="l01906"></a>01906       <span class="keywordflow">if</span>(!strcmp(iterator-&gt;numuserid, numuserid)) {
<a name="l01907"></a>01907          <a class="code" href="astobj_8h.html#09df6ddac721782b63dde9c9247b5285">ASTOBJ_UNLOCK</a>(iterator);
<a name="l01908"></a>01908          <span class="keywordflow">return</span> iterator;
<a name="l01909"></a>01909       }
<a name="l01910"></a>01910       <a class="code" href="astobj_8h.html#09df6ddac721782b63dde9c9247b5285">ASTOBJ_UNLOCK</a>(iterator);
<a name="l01911"></a>01911    } );
<a name="l01912"></a>01912    <span class="keywordflow">return</span> NULL;
<a name="l01913"></a>01913 }
<a name="l01914"></a>01914 
<a name="l01915"></a>01915 
<a name="l01916"></a><a class="code" href="res__astum_8c.html#d910eebd103db9cd510cd15e10e3ee4b">01916</a> <span class="keyword">struct </span><a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="astum_8h.html#d910eebd103db9cd510cd15e10e3ee4b">find_aum_group_by_name</a>(<span class="keywordtype">char</span> *groupname)
<a name="l01917"></a>01917 {
<a name="l01918"></a>01918    <span class="keyword">struct </span><a class="code" href="structaum__group.html">aum_group</a> *res;
<a name="l01919"></a>01919    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#8ea6cd7603b8f588209bc49c9c29e968">ast_strlen_zero</a>(groupname))
<a name="l01920"></a>01920       <span class="keywordflow">return</span> NULL;
<a name="l01921"></a>01921    res = <a class="code" href="astobj_8h.html#bb4a582d1b01a686da4f5dacfab2cfba">ASTOBJ_CONTAINER_FIND</a>(&amp;<a class="code" href="res__astum_8c.html#df751995f211be58a457c2d71dc6dc19">aum_grouplist</a>, groupname);  
<a name="l01922"></a>01922 
<a name="l01923"></a>01923    <span class="keywordflow">if</span> (!res &amp;&amp; <a class="code" href="res__astum_8c.html#b8a5bbee002aece8af628f8694357607">aum_real_groups_enabled</a>) {
<a name="l01924"></a>01924       res = <a class="code" href="res__astum_8c.html#95f64c129663ae6b02bb27a25ab5eeb8">aum_group_realtime_load</a>(groupname);
<a name="l01925"></a>01925    }
<a name="l01926"></a>01926    <span class="keywordflow">return</span> res;
<a name="l01927"></a>01927       
<a name="l01928"></a>01928 }
<a name="l01929"></a>01929 
<a name="l01930"></a><a class="code" href="res__astum_8c.html#193a76f977f30b532eb9bccca7d0d8b9">01930</a> <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="astum_8h.html#193a76f977f30b532eb9bccca7d0d8b9">find_aum_user</a>(<span class="keywordtype">char</span> *userid, <span class="keywordtype">int</span> realtime)
<a name="l01931"></a>01931 {
<a name="l01932"></a>01932    <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *res;
<a name="l01933"></a>01933 
<a name="l01934"></a>01934    <span class="comment">/* Search among static and cached realtime users */</span>
<a name="l01935"></a>01935    res = <a class="code" href="astobj_8h.html#bb4a582d1b01a686da4f5dacfab2cfba">ASTOBJ_CONTAINER_FIND</a>(&amp;<a class="code" href="res__astum_8c.html#ba74a92e97c6e68e9f1a98087416ca97">aum_userlist</a>, userid);   
<a name="l01936"></a>01936    <span class="keywordflow">if</span> (!res &amp;&amp; realtime &amp;&amp; <a class="code" href="res__astum_8c.html#e126e8e41904920cffa1f9c582ef4bf8">aum_real_users_enabled</a>) {
<a name="l01937"></a>01937       res = <a class="code" href="res__astum_8c.html#691cb6a96f603d4cb71d2d7384e5f891">aum_user_realtime_load</a>(userid);
<a name="l01938"></a>01938    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &amp;&amp; <a class="code" href="utils_8h.html#d26671e9d352536be0df3d41a800bb83">ast_test_flag</a>(res, <a class="code" href="astum_8h.html#6ad8155725a1f22cb2b08985ccb68d238bbed3f7071f380cb87b9ea966826684">AUM_USER_FLAG_REALTIME</a>))
<a name="l01939"></a>01939       <span class="comment">/* Move user to top of cache */</span>
<a name="l01940"></a>01940       <a class="code" href="res__astum_8c.html#aa329ccfb2f77758d8f346ab09b6954f">aum_rtcache_movetotop</a>(res);
<a name="l01941"></a>01941    <span class="keywordflow">return</span> res;
<a name="l01942"></a>01942 }
<a name="l01943"></a>01943 
<a name="l01944"></a><a class="code" href="res__astum_8c.html#c309b1531bd088440255cf2a029f5892">01944</a> <span class="keyword">struct </span><a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="astum_8h.html#c309b1531bd088440255cf2a029f5892">find_aum_user_email</a>(<span class="keywordtype">char</span> *<a class="code" href="pbx__dundi_8c.html#48349f516fb409aac98949ec5189eee5">email</a>)
<a name="l01945"></a>01945 {
<a name="l01946"></a>01946    <span class="keywordflow">return</span> <a class="code" href="astum_8h.html#ccd293a69a053fadd9fd57297cca5e43">find_user_by_address</a>(<a class="code" href="astum_8h.html#06c75a2105a638bd07a39cc3b61606cfa684fc88dfbd27a288352c7a3b8711e5">AUM_ADDR_EMAIL</a>, email);
<a name="l01947"></a>01947 }
<a name="l01948"></a>01948 
<a name="l01949"></a><a class="code" href="res__astum_8c.html#b0d2ccd66c50fec141caad9454d2dc80">01949</a> <span class="keywordtype">int</span> <a class="code" href="astum_8h.html#b0d2ccd66c50fec141caad9454d2dc80">aum_group_test_full</a>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>, <span class="keyword">struct</span> <a class="code" href="structaum__group.html">aum_group</a> *<a class="code" href="chan__agent_8c.html#db0f6f37ebeb6ea09489124345af2a45">group</a>)
<a name="l01950"></a>01950 {
<a name="l01951"></a>01951    <span class="keyword">struct </span><a class="code" href="structaum__group__member.html">aum_group_member</a> *<a class="code" href="structmember.html">member</a>;
<a name="l01952"></a>01952    <a class="code" href="linkedlists_8h.html#e5bbda4b7ef1cd9462bb86ba25c5d7eb">AST_LIST_TRAVERSE</a>(&amp;user-&gt;<a class="code" href="structaum__user.html#1471e4e05a4db95d353cc867fe317314">groups</a>, member, list) {
<a name="l01953"></a>01953       <span class="keywordflow">if</span> (member-&gt;<a class="code" href="structaum__group__member.html#db0f6f37ebeb6ea09489124345af2a45">group</a> == group)
<a name="l01954"></a>01954          <span class="keywordflow">return</span> 1;
<a name="l01955"></a>01955    };
<a name="l01956"></a>01956    <span class="keywordflow">return</span> 0;
<a name="l01957"></a>01957 }
<a name="l01958"></a>01958 
<a name="l01959"></a><a class="code" href="res__astum_8c.html#dad444bb8988493db1919c231b24dbb4">01959</a> <span class="keywordtype">int</span> <a class="code" href="astum_8h.html#dad444bb8988493db1919c231b24dbb4">aum_group_test</a>(<span class="keyword">struct</span> <a class="code" href="structaum__user.html">aum_user</a> *<a class="code" href="structaum__usercache__struct.html#ee11cbb19052e40b07aac0ca060c23ee">user</a>, <span class="keywordtype">char</span> *groupname) 
<a name="l01960"></a>01960 {
<a name="l01961"></a>01961    <span class="keywordflow">return</span> <a class="code" href="astum_8h.html#b0d2ccd66c50fec141caad9454d2dc80">aum_group_test_full</a>(user, <a class="code" href="astum_8h.html#d910eebd103db9cd510cd15e10e3ee4b">find_aum_group_by_name</a>(groupname));
<a name="l01962"></a>01962 }
<a name="l01963"></a>01963 <span class="comment"></span>
<a name="l01964"></a>01964 <span class="comment">/*! \brief Initialize charset conversion handlers */</span>
<a name="l01965"></a><a class="code" href="res__astum_8c.html#99bba772168489c7356021eb56e814ce">01965</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__astum_8c.html#99bba772168489c7356021eb56e814ce">initialize_charset_conversion</a>(<span class="keywordtype">void</span>)
<a name="l01966"></a>01966 {
<a name="l01967"></a>01967 <span class="preprocessor">#ifdef STRING_I18N</span>
<a name="l01968"></a>01968 <span class="preprocessor"></span>   ichandler_utf8_to_iso88591 = iconv_open(<span class="stringliteral">"utf8"</span>, <span class="stringliteral">"ISO-8859-1"</span>);
<a name="l01969"></a>01969    ichandler_iso88591_to_utf8 = iconv_open(<span class="stringliteral">"ISO-8859-1"</span>, <span class="stringliteral">"utf8"</span>);
<a name="l01970"></a>01970 <span class="preprocessor">#endif</span>
<a name="l01971"></a>01971 <span class="preprocessor"></span>}
<a name="l01972"></a>01972 
<a name="l01973"></a>01973 
<a name="l01974"></a>01974 <span class="comment">/*---------------------------- Asterisk module interface ---------------------------------*/</span>
<a name="l01975"></a>01975 <span class="comment"></span>
<a name="l01976"></a>01976 <span class="comment">/*! Load aum module */</span>
<a name="l01977"></a><a class="code" href="res__astum_8c.html#8c304b271325d497b3ce1886465a1abe">01977</a> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#8c304b271325d497b3ce1886465a1abe">load_module</a>(<span class="keywordtype">void</span>)
<a name="l01978"></a>01978 {
<a name="l01979"></a>01979    <a class="code" href="res__astum_8c.html#99bba772168489c7356021eb56e814ce">initialize_charset_conversion</a>();
<a name="l01980"></a>01980    <a class="code" href="chan__h323_8c.html#658d62bcd011a49f377d6ceb2a0294ca">reload_config</a>(<a class="code" href="res__astum_8c.html#4e2c74b8ed5eb469d94c25d198b8f1715648e9d89905777021731d659721eb16">MODULE__LOAD</a>);
<a name="l01981"></a>01981    <a class="code" href="res__astum_8c.html#d2fd6c7adcf7dded62eb52f4fa8ee0e0">aum_rtcache_freeall</a>();
<a name="l01982"></a>01982 
<a name="l01983"></a>01983    <span class="comment">/* Check if realtime is enabled */</span>
<a name="l01984"></a>01984    <a class="code" href="res__astum_8c.html#e126e8e41904920cffa1f9c582ef4bf8">aum_real_users_enabled</a> = <a class="code" href="config_8c.html#f0d3c598d4ed9b462978022b65676af5">ast_check_realtime</a>(<span class="stringliteral">"aumusers"</span>);
<a name="l01985"></a>01985    <a class="code" href="res__astum_8c.html#b8a5bbee002aece8af628f8694357607">aum_real_groups_enabled</a> = <a class="code" href="config_8c.html#f0d3c598d4ed9b462978022b65676af5">ast_check_realtime</a>(<span class="stringliteral">"aumgroups"</span>);
<a name="l01986"></a>01986 
<a name="l01987"></a>01987    <span class="comment">/* Register CLI */</span>
<a name="l01988"></a>01988    <a class="code" href="cli_8c.html#a334dfd903e83eea3729ff37aa372781">ast_cli_register_multiple</a>(my_clis, <span class="keyword">sizeof</span>(my_clis)/ <span class="keyword">sizeof</span>(my_clis[0]));
<a name="l01989"></a>01989    <a class="code" href="pbx_8c.html#93b5bf1865d6f3290372ca5ee3274391">ast_custom_function_register</a>(&amp;aum_user_function);
<a name="l01990"></a>01990 
<a name="l01991"></a>01991    <span class="keywordflow">return</span> 0;
<a name="l01992"></a>01992 }
<a name="l01993"></a>01993 <span class="comment"></span>
<a name="l01994"></a>01994 <span class="comment">/*! Unload module from memory, dangerous right now */</span>
<a name="l01995"></a><a class="code" href="res__astum_8c.html#eaf793e807a29b69460b0c6c94a79a0b">01995</a> <span class="keywordtype">int</span> <a class="code" href="chan__agent_8c.html#eaf793e807a29b69460b0c6c94a79a0b">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l01996"></a>01996 {
<a name="l01997"></a>01997    <span class="comment">/* Unregister apps, functions, manager actions, switches */</span>
<a name="l01998"></a>01998    <a class="code" href="cli_8c.html#321c001e02fcba48873965ff141ff29b">ast_cli_unregister_multiple</a>(my_clis, <span class="keyword">sizeof</span>(my_clis)/ <span class="keyword">sizeof</span>(my_clis[0]));
<a name="l01999"></a>01999    <a class="code" href="pbx_8c.html#cfc1bbe0fad0bcf852611eaee79b2d03">ast_custom_function_unregister</a>(&amp;aum_user_function);
<a name="l02000"></a>02000    <a class="code" href="res__astum_8c.html#d2fd6c7adcf7dded62eb52f4fa8ee0e0">aum_rtcache_freeall</a>();
<a name="l02001"></a>02001 
<a name="l02002"></a>02002 <span class="preprocessor">#ifdef STRING_I18N</span>
<a name="l02003"></a>02003 <span class="preprocessor"></span>   <span class="comment">/* Deallocate iconv conversion descriptors */</span>
<a name="l02004"></a>02004    iconv_close(ichandler_utf8_to_iso88591);
<a name="l02005"></a>02005    iconv_close(ichandler_iso88591_to_utf8);
<a name="l02006"></a>02006 <span class="preprocessor">#endif</span>
<a name="l02007"></a>02007 <span class="preprocessor"></span>   <span class="keywordflow">return</span> 0;
<a name="l02008"></a>02008 }
<a name="l02009"></a>02009 <span class="comment"></span>
<a name="l02010"></a>02010 <span class="comment">/*! Description for show modules CLI */</span>
<a name="l02011"></a><a class="code" href="res__astum_8c.html#299c07da7090ae82c6c706f544968ccb">02011</a> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#67daf92c833c41c95db874e18fcb2786">description</a>(<span class="keywordtype">void</span>)
<a name="l02012"></a>02012 {
<a name="l02013"></a>02013    <span class="keywordflow">return</span> <span class="stringliteral">"Asterisk User Management"</span>;
<a name="l02014"></a>02014 }
<a name="l02015"></a>02015 
<a name="l02016"></a><a class="code" href="res__astum_8c.html#4a4f32d4a0b64ccebbcc11346f42dae9">02016</a> <span class="keywordtype">int</span> <a class="code" href="func__channel_8c.html#4a4f32d4a0b64ccebbcc11346f42dae9">usecount</a>(<span class="keywordtype">void</span>)
<a name="l02017"></a>02017 {
<a name="l02018"></a>02018    <span class="keywordtype">int</span> res;
<a name="l02019"></a>02019    STANDARD_USECOUNT(res);
<a name="l02020"></a>02020    <span class="keywordflow">return</span> res;
<a name="l02021"></a>02021 }
<a name="l02022"></a>02022 
<a name="l02023"></a><a class="code" href="res__astum_8c.html#87ef31d54f81072952c331d5c7339d8e">02023</a> <span class="keywordtype">char</span> *<a class="code" href="func__channel_8c.html#87ef31d54f81072952c331d5c7339d8e">key</a>()
<a name="l02024"></a>02024 {
<a name="l02025"></a>02025    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#fdd823f5e0fdac8332029b8e4538b773">ASTERISK_GPL_KEY</a>;
<a name="l02026"></a>02026 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu May 24 22:26:49 2007 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
